<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema di Gestione Direzionale Multi-Azienda</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
            --border-color: #bdc3c7;

            /* Colori priorit√† */
            --priority-aplus: #e74c3c;
            --priority-a: #f39c12;
            --priority-b: #3498db;
            --priority-c: #95a5a6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* HEADER */
        header {
            background: var(--primary-color);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        /* NAVIGAZIONE */
        nav {
            background: var(--secondary-color);
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 0;
        }

        nav button {
            background: transparent;
            color: white;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        nav button:hover {
            background: rgba(255,255,255,0.1);
        }

        nav button.active {
            background: rgba(255,255,255,0.2);
            border-bottom-color: white;
        }

        /* SELETTORE AZIENDE */
        .company-selector {
            background: var(--light-bg);
            padding: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .company-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: white;
            border: 3px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1em;
        }

        .company-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .company-btn.active {
            border-color: var(--secondary-color);
            background: var(--secondary-color);
            color: white;
        }

        .company-btn.azienda-1.active { background: #e74c3c; border-color: #e74c3c; }
        .company-btn.azienda-2.active { background: #3498db; border-color: #3498db; }
        .company-btn.azienda-3.active { background: #2ecc71; border-color: #2ecc71; }
        .company-btn.azienda-4.active { background: #f39c12; border-color: #f39c12; }

        /* CONTENUTO PRINCIPALE */
        .content {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }

        .task-item {
            background: var(--light-bg);
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .task-item.priority-aplus { border-left-color: var(--priority-aplus); }
        .task-item.priority-a { border-left-color: var(--priority-a); }
        .task-item.priority-b { border-left-color: var(--priority-b); }
        .task-item.priority-c { border-left-color: var(--priority-c); }

        .priority-badge {
            background: var(--secondary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .priority-badge.aplus { background: var(--priority-aplus); }
        .priority-badge.a { background: var(--priority-a); }
        .priority-badge.b { background: var(--priority-b); }
        .priority-badge.c { background: var(--priority-c); }

        /* FORM */
        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark-text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        /* BOTTONI */
        .btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success { background: var(--success-color); }
        .btn-warning { background: var(--warning-color); }
        .btn-danger { background: var(--danger-color); }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        /* TABELLE */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        table tr:hover {
            background: var(--light-bg);
        }

        /* REPORT */
        .report-section {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .report-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        /* STATISTICHE */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-box p {
            opacity: 0.9;
            font-size: 1em;
        }

        /* PROCEDURA SOP */
        .sop-list {
            list-style: none;
        }

        .sop-item {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sop-item:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .sop-item h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .sop-item.expanded {
            background: var(--light-bg);
        }

        .sop-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
        }

        .sop-item.expanded .sop-content {
            display: block;
        }

        /* SOP DASHBOARD */
        .sop-dashboard {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .sop-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .sop-tab {
            background: transparent;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark-text);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .sop-tab:hover {
            color: var(--secondary-color);
        }

        .sop-tab.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .sop-tab-content {
            display: none;
        }

        .sop-tab-content.active {
            display: block;
        }

        .sop-checklist {
            list-style: none;
            padding: 0;
        }

        .sop-checklist-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .sop-checklist-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sop-checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .sop-checklist-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .sop-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .sop-stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }

        .sop-stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .sop-stat-label {
            font-size: 0.9em;
            color: var(--dark-text);
            margin-top: 5px;
        }

        .sop-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .sop-history-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid var(--success-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sop-history-date {
            font-weight: 600;
            color: var(--primary-color);
        }

        .sop-history-time {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .sop-notes {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            resize: vertical;
        }

        .sop-execute-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .sop-execute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .sop-progress-bar {
            background: var(--light-bg);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .sop-progress-fill {
            background: linear-gradient(90deg, var(--success-color), var(--secondary-color));
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* ARCHIVI DOCUMENTI */
        .archivi-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .archivi-section-header {
            grid-column: 1 / -1;
            margin: 20px 0 10px 0;
        }

        .archivi-section-header h3 {
            color: var(--primary-color);
            font-size: 1.3em;
            padding: 10px 0;
            border-bottom: 3px solid var(--secondary-color);
        }

        .category-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border-color: var(--secondary-color);
        }

        .category-icon {
            font-size: 2.5em;
            min-width: 60px;
            text-align: center;
        }

        .category-info {
            flex: 1;
        }

        .category-info h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .category-info p {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .doc-count {
            display: inline-block;
            background: var(--light-bg);
            color: var(--dark-text);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        /* Modal Categoria */
        .category-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .category-modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--primary-color);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            font-size: 2em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--danger-color);
        }

        .document-form {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .documents-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .document-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .document-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-color: var(--secondary-color);
        }

        .document-details {
            flex: 1;
        }

        .document-name {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .document-meta {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .document-actions {
            display: flex;
            gap: 10px;
        }

        .document-link {
            display: inline-block;
            padding: 8px 15px;
            background: var(--secondary-color);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .document-link:hover {
            background: var(--primary-color);
        }

        /* CONTATTI */
        .contact-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .contact-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: var(--secondary-color);
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .contact-company {
            font-size: 1em;
            color: #555;
            margin-bottom: 10px;
        }

        .contact-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .contact-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .contact-detail-item a {
            color: var(--secondary-color);
            text-decoration: none;
        }

        .contact-detail-item a:hover {
            text-decoration: underline;
        }

        .contact-category-badge {
            display: inline-block;
            background: var(--secondary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .contact-category-badge.fornitore { background: #3498db; }
        .contact-category-badge.cliente { background: #2ecc71; }
        .contact-category-badge.consulente { background: #9b59b6; }
        .contact-category-badge.dipendente { background: #f39c12; }
        .contact-category-badge.partner { background: #1abc9c; }
        .contact-category-badge.istituzione { background: #34495e; }
        .contact-category-badge.personale { background: #e74c3c; }
        .contact-category-badge.altro { background: #95a5a6; }

        .contact-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contact-notes-preview {
            font-size: 0.85em;
            color: #888;
            font-style: italic;
            margin-top: 8px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            nav button {
                padding: 12px 15px;
                font-size: 0.9em;
            }

            .company-selector {
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.5em;
            }
        }

        /* ANIMAZIONI */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* NOTIFICHE */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--border-color);
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .delete-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .delete-btn:hover {
            opacity: 0.8;
        }

        .task-content {
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 5px;
        }

        /* CALENDARIO */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 10px;
        }

        .calendar-header h3 {
            font-size: 1.5em;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            background: white;
            color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .calendar-nav button:hover {
            background: var(--light-bg);
            transform: scale(1.05);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day-header {
            background: var(--secondary-color);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            border-radius: 5px;
        }

        .calendar-day {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            min-height: 120px;
            padding: 8px;
            position: relative;
            transition: all 0.3s;
        }

        .calendar-day:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            background: var(--light-bg);
        }

        .calendar-day.today {
            border-color: var(--success-color);
            border-width: 3px;
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(46, 204, 113, 0.05));
        }

        .calendar-day-number {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .calendar-day.today .calendar-day-number {
            color: var(--success-color);
        }

        .calendar-event {
            background: var(--secondary-color);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.75em;
            margin: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 3px solid var(--primary-color);
        }

        .calendar-event.priority-aplus {
            background: var(--priority-aplus);
            border-left-color: #c0392b;
        }

        .calendar-event.priority-a {
            background: var(--priority-a);
            border-left-color: #d68910;
        }

        .calendar-event.priority-b {
            background: var(--priority-b);
            border-left-color: #2980b9;
        }

        .calendar-event.priority-c {
            background: var(--priority-c);
            border-left-color: #7f8c8d;
        }

        .calendar-event.deadline {
            background: #9b59b6;
            border-left-color: #8e44ad;
        }

        .calendar-event.priority-appointment {
            background: #16a085;
            border-left-color: #138d75;
        }

        .calendar-more {
            font-size: 0.7em;
            color: var(--secondary-color);
            font-weight: 600;
            margin-top: 3px;
        }

        @media (max-width: 768px) {
            .calendar-grid {
                gap: 5px;
            }

            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }

            .calendar-event {
                font-size: 0.65em;
                padding: 2px 4px;
            }
        }

        /* RICERCA GLOBALE */
        .global-search-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 2000;
            align-items: flex-start;
            justify-content: center;
            padding-top: 100px;
        }

        .global-search-container.active {
            display: flex;
        }

        .global-search-box {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .global-search-input {
            width: 100%;
            padding: 20px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px 10px 0 0;
            outline: none;
            background: var(--light-bg);
        }

        .global-search-results {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
        }

        .search-result-item {
            padding: 15px;
            margin: 10px 0;
            background: var(--light-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--secondary-color);
        }

        .search-result-item:hover {
            background: #d5dbdb;
            transform: translateX(5px);
        }

        .search-result-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .search-result-meta {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .search-highlight {
            background: #f39c12;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* DASHBOARD CONSOLIDATA */
        .consolidated-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .company-stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-top: 4px solid var(--secondary-color);
        }

        .company-stat-card.azienda-1 { border-top-color: #e74c3c; }
        .company-stat-card.azienda-2 { border-top-color: #3498db; }
        .company-stat-card.azienda-3 { border-top-color: #2ecc71; }
        .company-stat-card.azienda-4 { border-top-color: #f39c12; }

        .company-stat-header {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }

        .company-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .mini-stat {
            text-align: center;
            padding: 10px;
            background: var(--light-bg);
            border-radius: 6px;
        }

        .mini-stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .mini-stat-label {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* ANALYTICS/GRAFICI */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-bg);
        }

        .simple-bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            height: 200px;
            padding: 10px;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .bar {
            width: 100%;
            background: linear-gradient(to top, var(--secondary-color), var(--primary-color));
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
            position: relative;
        }

        .bar:hover {
            opacity: 0.8;
            transform: translateY(-5px);
        }

        .bar-value {
            position: absolute;
            top: -25px;
            width: 100%;
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
        }

        .bar-label {
            margin-top: 10px;
            font-size: 0.9em;
            color: #7f8c8d;
            text-align: center;
        }

        /* NOTIFICHE BROWSER */
        .notification-badge {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--danger-color);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 1500;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .notification-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 10px;
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1500;
            display: none;
        }

        .notification-panel.active {
            display: block;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-panel-header {
            padding: 15px;
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s;
        }

        .notification-item:hover {
            background: var(--light-bg);
        }

        .notification-item.urgent {
            border-left: 4px solid var(--danger-color);
        }

        .notification-item.warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification-item.info {
            border-left: 4px solid var(--secondary-color);
        }

        /* FILTRI AVANZATI */
        .filter-bar {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--dark-text);
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9em;
            background: white;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .filter-reset-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .filter-reset-btn:hover {
            opacity: 0.8;
        }

        /* TAG SYSTEM */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag {
            background: var(--secondary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .tag.tag-urgent { background: #e74c3c; }
        .tag.tag-fiscal { background: #9b59b6; }
        .tag.tag-hr { background: #f39c12; }
        .tag.tag-legal { background: #34495e; }
        .tag.tag-admin { background: #1abc9c; }
        .tag.tag-strategic { background: #e67e22; }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            margin-left: 3px;
        }

        .tag-remove:hover {
            transform: scale(1.2);
        }

        /* AUDIT LOG */
        .audit-log-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .audit-log-item {
            padding: 12px;
            margin: 8px 0;
            background: var(--light-bg);
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
            font-size: 0.9em;
        }

        .audit-log-item.action-create { border-left-color: #2ecc71; }
        .audit-log-item.action-update { border-left-color: #3498db; }
        .audit-log-item.action-delete { border-left-color: #e74c3c; }

        .audit-log-time {
            font-weight: 600;
            color: var(--primary-color);
        }

        .audit-log-action {
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* TEMPLATE RICORRENTI */
        .template-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-card:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .template-badge {
            display: inline-block;
            background: var(--secondary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 10px;
        }

        .template-badge.weekly { background: #3498db; }
        .template-badge.monthly { background: #9b59b6; }
        .template-badge.quarterly { background: #e67e22; }

        /* SEARCH BAR STICKY */
        .search-bar-sticky {
            position: fixed;
            top: 20px;
            right: 80px;
            z-index: 1000;
        }

        .search-icon-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .search-icon-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        /* BACKUP INDICATOR */
        .backup-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .backup-indicator.show {
            opacity: 1;
        }

        /* MODAL DETTAGLIO ELEMENTO */
        .detail-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }

        .detail-modal.active {
            display: block;
        }

        .detail-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .detail-modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .detail-modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-modal-close {
            font-size: 2em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.3s;
            line-height: 1;
        }

        .detail-modal-close:hover {
            transform: rotate(90deg);
        }

        .detail-modal-body {
            padding: 30px;
        }

        .detail-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 2px solid var(--light-bg);
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .detail-info-item {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }

        .detail-info-label {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 0.85em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .detail-info-value {
            color: var(--dark-text);
            font-size: 1.1em;
        }

        .detail-description {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            line-height: 1.6;
        }

        /* Documenti Allegati */
        .attachments-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .attachment-item {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .attachment-item:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .attachment-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .attachment-icon {
            font-size: 2em;
            width: 50px;
            text-align: center;
        }

        .attachment-details h4 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .attachment-meta {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .attachment-actions {
            display: flex;
            gap: 10px;
        }

        .add-attachment-form {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .form-inline {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .form-inline .form-group {
            flex: 1;
            min-width: 200px;
            margin: 0;
        }

        /* Note e Cronologia */
        .notes-section {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .notes-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .note-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .note-date {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9em;
        }

        .note-text {
            color: var(--dark-text);
            line-height: 1.5;
        }

        .add-note-form {
            margin-top: 15px;
        }

        /* Timeline/Cronologia */
        .timeline {
            position: relative;
            padding-left: 30px;
            margin-top: 15px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--secondary-color);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--secondary-color);
        }

        .timeline-content {
            background: var(--light-bg);
            padding: 12px 15px;
            border-radius: 6px;
        }

        .timeline-date {
            font-size: 0.85em;
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .timeline-text {
            color: var(--dark-text);
        }

        /* Badge Status */
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.overdue {
            background: #f8d7da;
            color: #721c24;
        }

        /* Pulsanti azione modal */
        .detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--light-bg);
            justify-content: flex-end;
        }

        .clickable-item {
            cursor: pointer;
            transition: all 0.3s;
        }

        .clickable-item:hover {
            transform: translateX(3px);
        }

        /* EMAIL TABS */
        .email-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: var(--light-bg);
            padding: 15px;
            border-radius: 10px;
        }

        .email-tab {
            background: white;
            border: 2px solid var(--border-color);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            flex: 1;
            min-width: 150px;
        }

        .email-tab:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .email-tab.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .email-tab.compose-btn {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .email-tab.compose-btn:hover {
            background: #229954;
            border-color: #229954;
        }

        /* EMAIL LIST */
        .email-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ai-assistant-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .ai-assistant-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
        }

        .email-list-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .email-item {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .email-item:hover {
            border-color: var(--secondary-color);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .email-item.unread {
            background: #e8f4f8;
            border-left: 5px solid var(--secondary-color);
            font-weight: 600;
        }

        .email-item.urgent {
            border-left: 5px solid var(--danger-color);
        }

        .email-item.important {
            border-left: 5px solid var(--warning-color);
        }

        .email-checkbox {
            display: flex;
            align-items: center;
            min-width: 20px;
        }

        .email-star {
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.3s;
            min-width: 30px;
        }

        .email-star:hover {
            transform: scale(1.2);
        }

        .email-star.starred {
            color: #f39c12;
        }

        .email-content {
            flex: 1;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .email-from {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .email-date {
            color: #7f8c8d;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .email-subject {
            font-size: 1em;
            margin-bottom: 5px;
            color: var(--dark-text);
        }

        .email-preview {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .email-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .email-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .email-tag.priority-urgent {
            background: #ffebee;
            color: var(--danger-color);
        }

        .email-tag.priority-important {
            background: #fff3e0;
            color: var(--warning-color);
        }

        .email-tag.priority-normal {
            background: #e8f5e9;
            color: var(--success-color);
        }

        .email-tag.category {
            background: #e3f2fd;
            color: #1976d2;
        }

        .email-tag.has-attachment {
            background: #f3e5f5;
            color: #8e24aa;
        }

        /* EMAIL VIEW */
        .email-view-header {
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .email-view-subject {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .email-view-meta {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 20px;
            color: #7f8c8d;
        }

        .email-view-meta strong {
            color: var(--dark-text);
        }

        .email-view-body {
            line-height: 1.8;
            color: var(--dark-text);
            margin-bottom: 30px;
            white-space: pre-wrap;
        }

        .email-view-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding-top: 20px;
            border-top: 2px solid var(--light-bg);
        }

        /* ASSISTANT PANEL */
        .assistant-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            z-index: 1500;
            transition: right 0.3s;
            overflow-y: auto;
        }

        .assistant-panel.active {
            right: 0;
        }

        .assistant-panel-content {
            padding: 20px;
        }

        .assistant-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
            margin-bottom: 20px;
        }

        .assistant-panel-header h3 {
            color: var(--primary-color);
            font-size: 1.3em;
        }

        .assistant-panel-header .close-btn {
            font-size: 2em;
            cursor: pointer;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .assistant-panel-header .close-btn:hover {
            color: var(--danger-color);
            transform: rotate(90deg);
        }

        .assistant-section {
            margin-bottom: 25px;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 10px;
        }

        .assistant-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .suggestion-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .suggestion-item {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }

        .suggestion-icon {
            font-size: 1.5em;
        }

        .btn-small {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 5px;
            transition: all 0.3s;
        }

        .btn-small:hover {
            background: #2980b9;
        }

        .quick-replies {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-reply-btn {
            background: white;
            border: 2px solid var(--border-color);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
            font-weight: 600;
        }

        .quick-reply-btn:hover {
            border-color: var(--secondary-color);
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .analysis-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .analysis-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light-bg);
        }

        .analysis-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .analysis-item strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
        }

        .actions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            background: linear-gradient(135deg, var(--success-color), #229954);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-align: left;
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Sistema di Gestione Direzionale Multi-Azienda</h1>
            <p>Assistente di Direzione Senior e Coordinatrice Operativa Multiazienda</p>
        </header>

        <nav>
            <button onclick="showSection('dashboard')" class="active">Dashboard</button>
            <button onclick="showSection('consolidated')">üìà Vista Consolidata</button>
            <button onclick="showSection('analytics')">üìä Analytics</button>
            <button onclick="showSection('emails')">üìß Email & Assistente</button>
            <button onclick="showSection('tasks')">Attivit√†</button>
            <button onclick="showSection('templates')">üîÑ Template Ricorrenti</button>
            <button onclick="showSection('appuntamenti')">Appuntamenti</button>
            <button onclick="showSection('scadenze')">Scadenze</button>
            <button onclick="showSection('spese')">Spese</button>
            <button onclick="showSection('calendario')">Calendario</button>
            <button onclick="showSection('contatti')">Contatti</button>
            <button onclick="showSection('archivi')">Archivi Documenti</button>
            <button onclick="showSection('sop')">Procedure (SOP)</button>
            <button onclick="showSection('report')">Report Direzionale</button>
            <button onclick="showSection('audit-log')">üìú Storico Modifiche</button>
            <button onclick="showSection('settings')">Impostazioni</button>
        </nav>

        <div class="company-selector">
            <button class="company-btn azienda-1 active" onclick="selectCompany(1)">Azienda 1</button>
            <button class="company-btn azienda-2" onclick="selectCompany(2)">Azienda 2</button>
            <button class="company-btn azienda-3" onclick="selectCompany(3)">Azienda 3</button>
            <button class="company-btn azienda-4" onclick="selectCompany(4)">Azienda 4</button>
        </div>

        <div class="content">
            <!-- DASHBOARD SECTION -->
            <div id="dashboard" class="section active fade-in">
                <h2>Dashboard Settimanale - <span id="dashboard-company-name">Azienda 1</span></h2>

                <div class="stats-container">
                    <div class="stat-box" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <h3 id="stat-urgent">0</h3>
                        <p>Attivit√† Urgenti (A+)</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #f39c12, #d68910);">
                        <h3 id="stat-important">0</h3>
                        <p>Attivit√† Importanti (A)</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <h3 id="stat-deadlines">0</h3>
                        <p>Scadenze Imminenti</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                        <h3 id="stat-completed">0</h3>
                        <p>Completate questa settimana</p>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üî• Attivit√† Urgenti</h3>
                        <div id="urgent-tasks"></div>
                    </div>

                    <div class="card">
                        <h3>‚ö° Attivit√† Importanti</h3>
                        <div id="important-tasks"></div>
                    </div>

                    <div class="card">
                        <h3>üìÖ Scadenze Fiscali/Legali</h3>
                        <div id="fiscal-deadlines"></div>
                    </div>

                    <div class="card">
                        <h3>üë• Scadenze HR</h3>
                        <div id="hr-deadlines"></div>
                    </div>

                    <div class="card">
                        <h3>‚ö†Ô∏è Criticit√† Interne</h3>
                        <div id="critical-issues"></div>
                    </div>

                    <div class="card">
                        <h3>üéØ Decisioni in Attesa</h3>
                        <div id="pending-decisions"></div>
                    </div>

                    <div class="card">
                        <h3>üí∞ Spese del Mese</h3>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 2.5em; font-weight: bold; color: var(--primary-color); margin-bottom: 10px;">
                                ‚Ç¨ <span id="total-expenses-month">0.00</span>
                            </div>
                            <div style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 15px;">
                                <span id="expenses-count-month">0</span> spese registrate
                            </div>
                        </div>
                        <div id="recent-expenses" style="max-height: 150px; overflow-y: auto;"></div>
                    </div>

                    <div class="card">
                        <h3>üìÖ Prossimi Appuntamenti</h3>
                        <div id="upcoming-appointments"></div>
                    </div>
                </div>
            </div>

            <!-- TASKS SECTION -->
            <div id="tasks" class="section">
                <h2>Gestione Attivit√† - <span id="tasks-company-name">Azienda 1</span></h2>

                <div class="card">
                    <h3>Aggiungi Nuova Attivit√†</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="btn" onclick="startVoiceInput('task')" id="voice-btn-task">
                            üé§ Inserimento Vocale
                        </button>
                    </div>
                    <form id="task-form" onsubmit="addTask(event)">
                        <div class="form-group">
                            <label>Titolo Attivit√†</label>
                            <input type="text" id="task-title" required>
                        </div>

                        <div class="form-group">
                            <label>Descrizione</label>
                            <textarea id="task-description"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="task-category">
                                <option value="urgent">Attivit√† Urgenti</option>
                                <option value="important">Attivit√† Importanti</option>
                                <option value="fiscal">Scadenze Fiscali/Legali</option>
                                <option value="hr">Scadenze HR</option>
                                <option value="critical">Criticit√† Interne</option>
                                <option value="decisions">Decisioni in Attesa</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Priorit√†</label>
                            <select id="task-priority">
                                <option value="aplus">A+ - Fondamentale (impatto diretto)</option>
                                <option value="a">A - Importanza alta</option>
                                <option value="b">B - Importante ma programmabile</option>
                                <option value="c">C - Routine o delegabile</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Data Scadenza</label>
                            <input type="date" id="task-deadline">
                        </div>

                        <button type="submit" class="btn btn-success">Aggiungi Attivit√†</button>
                    </form>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>Tutte le Attivit√†</h3>
                    <div id="all-tasks-list"></div>
                </div>
            </div>

            <!-- APPUNTAMENTI SECTION -->
            <div id="appuntamenti" class="section">
                <h2>üìÖ Gestione Appuntamenti - <span id="appuntamenti-company-name">Azienda 1</span></h2>

                <div class="card">
                    <h3>Aggiungi Nuovo Appuntamento</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="btn" onclick="startVoiceInput('appointment')" id="voice-btn-appointment">
                            üé§ Inserimento Vocale
                        </button>
                    </div>
                    <form id="appointment-form" onsubmit="addAppointment(event)">
                        <div class="form-group">
                            <label>Titolo Appuntamento</label>
                            <input type="text" id="appointment-title" placeholder="Es: Riunione con cliente X" required>
                        </div>

                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="appointment-date" required>
                        </div>

                        <div class="form-group">
                            <label>Ora Inizio</label>
                            <input type="time" id="appointment-time" required>
                        </div>

                        <div class="form-group">
                            <label>Durata (minuti)</label>
                            <select id="appointment-duration">
                                <option value="15">15 minuti</option>
                                <option value="30" selected>30 minuti</option>
                                <option value="45">45 minuti</option>
                                <option value="60">1 ora</option>
                                <option value="90">1 ora e 30</option>
                                <option value="120">2 ore</option>
                                <option value="180">3 ore</option>
                                <option value="240">4 ore</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Luogo</label>
                            <input type="text" id="appointment-location" placeholder="Es: Sede cliente, Ufficio, Videochiamata">
                        </div>

                        <div class="form-group">
                            <label>Partecipanti</label>
                            <input type="text" id="appointment-participants" placeholder="Es: Mario Rossi, Luca Bianchi">
                        </div>

                        <div class="form-group">
                            <label>Note</label>
                            <textarea id="appointment-notes" placeholder="Aggiungi note, argomenti da trattare, documenti da portare..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-success">Aggiungi Appuntamento</button>
                    </form>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>Tutti gli Appuntamenti</h3>
                    <table id="appointments-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Ora</th>
                                <th>Titolo</th>
                                <th>Luogo</th>
                                <th>Partecipanti</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="appointments-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- SCADENZE SECTION -->
            <div id="scadenze" class="section">
                <h2>Calendario Scadenze - <span id="scadenze-company-name">Azienda 1</span></h2>

                <div class="card">
                    <h3>Aggiungi Scadenza</h3>
                    <form id="deadline-form" onsubmit="addDeadline(event)">
                        <div class="form-group">
                            <label>Tipo Scadenza</label>
                            <input type="text" id="deadline-type" placeholder="Es: F24, INPS, CU, etc." required>
                        </div>

                        <div class="form-group">
                            <label>Descrizione</label>
                            <textarea id="deadline-description"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Data Scadenza</label>
                            <input type="date" id="deadline-date" required>
                        </div>

                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="deadline-category">
                                <option value="fiscale">Fiscale</option>
                                <option value="legale">Legale</option>
                                <option value="hr">Risorse Umane</option>
                                <option value="amministrativa">Amministrativa</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-success">Aggiungi Scadenza</button>
                    </form>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>Prossime Scadenze</h3>
                    <table id="deadlines-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Categoria</th>
                                <th>Descrizione</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="deadlines-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- SPESE SECTION -->
            <div id="spese" class="section">
                <h2>üí∞ Gestione Spese - <span id="spese-company-name">Azienda 1</span></h2>

                <div class="card">
                    <h3>Aggiungi Nuova Spesa</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="btn" onclick="startVoiceInput('expense')" id="voice-btn-expense">
                            üé§ Inserimento Vocale
                        </button>
                    </div>
                    <form id="expense-form" onsubmit="addExpense(event)">
                        <div class="form-group">
                            <label>Descrizione</label>
                            <input type="text" id="expense-description" placeholder="Es: Raccomandata per cliente X, Taxi per riunione, ecc." required>
                        </div>

                        <div class="form-group">
                            <label>Importo (‚Ç¨)</label>
                            <input type="number" id="expense-amount" step="0.01" min="0" placeholder="0.00" required>
                        </div>

                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="expense-date" required>
                        </div>

                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="expense-category">
                                <option value="posta">üìÆ Posta e Raccomandate</option>
                                <option value="viaggio">‚úàÔ∏è Viaggi e Trasferte</option>
                                <option value="taxi">üöñ Taxi e Trasporti</option>
                                <option value="materiale">üìé Materiale Ufficio</option>
                                <option value="cancelleria">‚úèÔ∏è Cancelleria</option>
                                <option value="pranzo">üçΩÔ∏è Pranzi di Lavoro</option>
                                <option value="parcheggio">üÖøÔ∏è Parcheggi</option>
                                <option value="bolli">üìÑ Marche da Bollo</option>
                                <option value="corriere">üì¶ Corrieri</option>
                                <option value="altro">üíº Altro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Note (opzionale)</label>
                            <textarea id="expense-notes" placeholder="Aggiungi dettagli aggiuntivi..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-success">Aggiungi Spesa</button>
                    </form>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>Riepilogo Spese</h3>
                    <div class="stats-container" style="margin: 20px 0;">
                        <div class="stat-box" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                            <h3>‚Ç¨ <span id="total-expenses-today">0.00</span></h3>
                            <p>Spese di Oggi</p>
                        </div>
                        <div class="stat-box" style="background: linear-gradient(135deg, #f39c12, #d68910);">
                            <h3>‚Ç¨ <span id="total-expenses-week">0.00</span></h3>
                            <p>Spese Questa Settimana</p>
                        </div>
                        <div class="stat-box" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                            <h3>‚Ç¨ <span id="total-expenses-month-section">0.00</span></h3>
                            <p>Spese Questo Mese</p>
                        </div>
                        <div class="stat-box" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                            <h3><span id="total-expenses-count">0</span></h3>
                            <p>Totale Spese Registrate</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Tutte le Spese</h3>
                    <table id="expenses-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrizione</th>
                                <th>Categoria</th>
                                <th>Importo</th>
                                <th>Note</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- CALENDARIO SECTION -->
            <div id="calendario" class="section">
                <h2>Calendario Mensile - <span id="calendario-company-name">Azienda 1</span></h2>

                <div class="card">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button onclick="previousMonth()">‚óÄ Mese Precedente</button>
                        </div>
                        <h3 id="calendar-month-year"></h3>
                        <div class="calendar-nav">
                            <button onclick="nextMonth()">Mese Successivo ‚ñ∂</button>
                        </div>
                    </div>

                    <div class="calendar-grid" id="calendar-container">
                        <!-- Il calendario verr√† generato qui dal JavaScript -->
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>Legenda</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="calendar-event priority-aplus" style="width: 80px;">A+</div>
                            <span>Urgente</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="calendar-event priority-a" style="width: 80px;">A</div>
                            <span>Importante</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="calendar-event priority-b" style="width: 80px;">B</div>
                            <span>Programmabile</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="calendar-event priority-c" style="width: 80px;">C</div>
                            <span>Routine</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="calendar-event deadline" style="width: 80px;">Scadenza</div>
                            <span>Scadenze fiscali/legali</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="calendar-event priority-appointment" style="width: 80px;">Appuntamento</div>
                            <span>Appuntamenti</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTATTI SECTION -->
            <div id="contatti" class="section">
                <h2>üë• Rubrica Contatti - <span id="contatti-company-name">Azienda 1</span></h2>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Gestione Contatti</h3>
                        <div>
                            <button onclick="showContactForm()" class="btn btn-success">‚ûï Nuovo Contatto</button>
                            <button onclick="exportContacts()" class="btn">üì• Esporta CSV</button>
                            <button onclick="document.getElementById('import-contacts-file').click()" class="btn">üì§ Importa CSV</button>
                            <input type="file" id="import-contacts-file" style="display:none" accept=".csv,.json" onchange="importContacts(event)">
                        </div>
                    </div>

                    <!-- FORM NUOVO CONTATTO -->
                    <div id="contact-form-container" style="display: none; background: var(--light-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--primary-color);">Aggiungi/Modifica Contatto</h4>
                        <form id="contact-form" onsubmit="saveContact(event)">
                            <input type="hidden" id="contact-id">

                            <div class="form-group">
                                <label>Nome Completo *</label>
                                <input type="text" id="contact-name" required placeholder="es: Mario Rossi">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Azienda/Organizzazione</label>
                                    <input type="text" id="contact-company" placeholder="es: Acme S.r.l.">
                                </div>
                                <div class="form-group">
                                    <label>Ruolo</label>
                                    <input type="text" id="contact-role" placeholder="es: Amministratore Delegato">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Telefono 1</label>
                                    <input type="tel" id="contact-phone1" placeholder="es: +39 123 456 7890">
                                </div>
                                <div class="form-group">
                                    <label>Telefono 2</label>
                                    <input type="tel" id="contact-phone2" placeholder="es: +39 098 765 4321">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email 1 *</label>
                                    <input type="email" id="contact-email1" required placeholder="es: mario.rossi@email.com">
                                </div>
                                <div class="form-group">
                                    <label>Email 2</label>
                                    <input type="email" id="contact-email2" placeholder="es: mario@azienda.it">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Categoria</label>
                                <select id="contact-category">
                                    <option value="fornitore">Fornitore</option>
                                    <option value="cliente">Cliente</option>
                                    <option value="consulente">Consulente</option>
                                    <option value="dipendente">Dipendente</option>
                                    <option value="partner">Partner</option>
                                    <option value="istituzione">Istituzione/Ente</option>
                                    <option value="personale">Personale</option>
                                    <option value="altro">Altro</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Indirizzo</label>
                                <input type="text" id="contact-address" placeholder="Via, Citt√†, CAP">
                            </div>

                            <div class="form-group">
                                <label>Note</label>
                                <textarea id="contact-notes" rows="3" placeholder="Annotazioni sul contatto..."></textarea>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-success">üíæ Salva Contatto</button>
                                <button type="button" onclick="cancelContactForm()" class="btn">‚ùå Annulla</button>
                            </div>
                        </form>
                    </div>

                    <!-- FILTRI E RICERCA -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <input type="text" id="contact-search" placeholder="üîç Cerca per nome, email, telefono, azienda..."
                            style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 6px;"
                            onkeyup="filterContacts()">
                        <select id="contact-filter-category" onchange="filterContacts()"
                            style="padding: 12px; border: 2px solid var(--border-color); border-radius: 6px;">
                            <option value="">Tutte le categorie</option>
                            <option value="fornitore">Fornitore</option>
                            <option value="cliente">Cliente</option>
                            <option value="consulente">Consulente</option>
                            <option value="dipendente">Dipendente</option>
                            <option value="partner">Partner</option>
                            <option value="istituzione">Istituzione/Ente</option>
                            <option value="personale">Personale</option>
                            <option value="altro">Altro</option>
                        </select>
                    </div>

                    <!-- CONTATORE -->
                    <p style="color: var(--dark-text); margin-bottom: 15px;">
                        <strong>Totale contatti: <span id="contacts-count">0</span></strong>
                    </p>

                    <!-- LISTA CONTATTI -->
                    <div id="contacts-list" style="max-height: 600px; overflow-y: auto;">
                        <p style="text-align: center; color: #7f8c8d; padding: 40px;">Nessun contatto presente. Clicca su "Nuovo Contatto" per aggiungerne uno.</p>
                    </div>
                </div>
            </div>

            <!-- ARCHIVI DOCUMENTI SECTION -->
            <div id="archivi" class="section">
                <h2>üìÅ Archivi Documenti - <span id="archivi-company-name">Azienda 1</span></h2>

                <p style="margin-bottom: 20px; color: var(--dark-text);">
                    Sistema di archiviazione centralizzato per documenti aziendali e personali. Clicca su una categoria per gestire i documenti.
                </p>

                <div class="archivi-categories">
                    <!-- CATEGORIE AZIENDALI -->
                    <div class="archivi-section-header">
                        <h3>üìä DOCUMENTI AZIENDALI</h3>
                    </div>

                    <div class="category-card" onclick="openCategory('contratti')">
                        <div class="category-icon">üìÑ</div>
                        <div class="category-info">
                            <h4>Contratti</h4>
                            <p>Fornitori, clienti, dipendenti, locazioni, servizi</p>
                            <span class="doc-count" id="count-contratti">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('fiscale')">
                        <div class="category-icon">üí∞</div>
                        <div class="category-info">
                            <h4>Fiscale e Tributario</h4>
                            <p>Fatture, F24, dichiarazioni, CU, comunicazioni ADE</p>
                            <span class="doc-count" id="count-fiscale">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('legale')">
                        <div class="category-icon">‚öñÔ∏è</div>
                        <div class="category-info">
                            <h4>Legale</h4>
                            <p>Atti, PEC legali, diffide, contenziosi, sentenze</p>
                            <span class="doc-count" id="count-legale">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('risorse-umane')">
                        <div class="category-icon">üë•</div>
                        <div class="category-info">
                            <h4>Risorse Umane</h4>
                            <p>Contratti lavoro, cedolini, documenti dipendenti, formazione</p>
                            <span class="doc-count" id="count-risorse-umane">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('assicurazioni-azienda')">
                        <div class="category-icon">üõ°Ô∏è</div>
                        <div class="category-info">
                            <h4>Assicurazioni Aziendali</h4>
                            <p>Polizze aziendali, sinistri, corrispondenza</p>
                            <span class="doc-count" id="count-assicurazioni-azienda">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('bancario')">
                        <div class="category-icon">üè¶</div>
                        <div class="category-info">
                            <h4>Bancario</h4>
                            <p>Estratti conto, mutui, finanziamenti, garanzie fideiussorie</p>
                            <span class="doc-count" id="count-bancario">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('enti-istituzioni')">
                        <div class="category-icon">üèõÔ∏è</div>
                        <div class="category-info">
                            <h4>Enti e Istituzioni</h4>
                            <p>Camera Commercio, INPS, INAIL, enti vari</p>
                            <span class="doc-count" id="count-enti-istituzioni">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('licenze')">
                        <div class="category-icon">üìú</div>
                        <div class="category-info">
                            <h4>Licenze e Certificazioni</h4>
                            <p>Autorizzazioni, certificazioni qualit√†, HACCP, privacy</p>
                            <span class="doc-count" id="count-licenze">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('fornitori')">
                        <div class="category-icon">üì¶</div>
                        <div class="category-info">
                            <h4>Fornitori</h4>
                            <p>Preventivi, ordini, DDT, garanzie prodotti</p>
                            <span class="doc-count" id="count-fornitori">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('clienti')">
                        <div class="category-icon">ü§ù</div>
                        <div class="category-info">
                            <h4>Clienti</h4>
                            <p>Ordini, preventivi, reclami, documentazione commerciale</p>
                            <span class="doc-count" id="count-clienti">0 documenti</span>
                        </div>
                    </div>

                    <!-- CATEGORIE PERSONALI -->
                    <div class="archivi-section-header" style="margin-top: 40px;">
                        <h3>üè† DOCUMENTI PERSONALI (Case)</h3>
                    </div>

                    <div class="category-card" onclick="openCategory('immobili')">
                        <div class="category-icon">üè°</div>
                        <div class="category-info">
                            <h4>Immobili</h4>
                            <p>Atti propriet√†, catastali, mutui, ristrutturazioni</p>
                            <span class="doc-count" id="count-immobili">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('utenze-domestiche')">
                        <div class="category-icon">üí°</div>
                        <div class="category-info">
                            <h4>Utenze Domestiche</h4>
                            <p>Bollette, contratti luce/gas/acqua/internet/telefono</p>
                            <span class="doc-count" id="count-utenze-domestiche">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('condominio')">
                        <div class="category-icon">üè¢</div>
                        <div class="category-info">
                            <h4>Condominio</h4>
                            <p>Verbali assemblee, bilanci, lavori straordinari, millesimi</p>
                            <span class="doc-count" id="count-condominio">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('manutenzioni-casa')">
                        <div class="category-icon">üîß</div>
                        <div class="category-info">
                            <h4>Manutenzioni Casa</h4>
                            <p>Interventi, garanzie, contratti assistenza caldaia/climatizzatori</p>
                            <span class="doc-count" id="count-manutenzioni-casa">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('assicurazioni-casa')">
                        <div class="category-icon">üõ°Ô∏è</div>
                        <div class="category-info">
                            <h4>Assicurazioni Casa</h4>
                            <p>Polizze casa, RC, sinistri</p>
                            <span class="doc-count" id="count-assicurazioni-casa">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('documenti-personali')">
                        <div class="category-icon">üÜî</div>
                        <div class="category-info">
                            <h4>Documenti Personali</h4>
                            <p>Passaporti, patenti, certificati, documenti famiglia</p>
                            <span class="doc-count" id="count-documenti-personali">0 documenti</span>
                        </div>
                    </div>

                    <!-- CATEGORIE COMUNICAZIONI -->
                    <div class="archivi-section-header" style="margin-top: 40px;">
                        <h3>‚úâÔ∏è COMUNICAZIONI</h3>
                    </div>

                    <div class="category-card" onclick="openCategory('email-archiviate')">
                        <div class="category-icon">üìß</div>
                        <div class="category-info">
                            <h4>Email Archiviate</h4>
                            <p>Email importanti categorizzate</p>
                            <span class="doc-count" id="count-email-archiviate">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('pec-aziendale')">
                        <div class="category-icon">üì¨</div>
                        <div class="category-info">
                            <h4>PEC Aziendale</h4>
                            <p>Archivio PEC per ogni azienda</p>
                            <span class="doc-count" id="count-pec-aziendale">0 documenti</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="openCategory('corrispondenza-ufficiale')">
                        <div class="category-icon">üìÆ</div>
                        <div class="category-info">
                            <h4>Corrispondenza Ufficiale</h4>
                            <p>Raccomandate, atti giudiziari</p>
                            <span class="doc-count" id="count-corrispondenza-ufficiale">0 documenti</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SOP SECTION -->
            <div id="sop" class="section">
                <h2>Procedure Operative Standard (SOP)</h2>

                <p style="margin-bottom: 20px; color: var(--dark-text);">
                    Le 10 procedure fondamentali per ottimizzare il lavoro quotidiano e ridurre le ripetizioni.
                </p>

                <ul class="sop-list" id="sop-list"></ul>
            </div>

            <!-- REPORT SECTION -->
            <div id="report" class="section">
                <h2>Report Direzionale Settimanale</h2>

                <div class="card">
                    <button onclick="generateReport()" class="btn btn-success">üìÑ Genera Report Settimanale</button>
                    <button onclick="exportReport()" class="btn" style="margin-left: 10px;">üì• Esporta in PDF</button>
                </div>

                <div id="report-content" class="report-section" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 30px;">Report Direzionale Settimanale</h3>
                    <p style="text-align: center; margin-bottom: 30px;">
                        Settimana del <span id="report-week"></span>
                    </p>

                    <div class="report-section">
                        <h4>‚úÖ Cosa √® stato fatto</h4>
                        <div id="report-done"></div>
                    </div>

                    <div class="report-section">
                        <h4>üîÑ Cosa √® in corso</h4>
                        <div id="report-ongoing"></div>
                    </div>

                    <div class="report-section">
                        <h4>üéØ Cosa richiede decisione del management</h4>
                        <div id="report-decisions"></div>
                    </div>

                    <div class="report-section">
                        <h4>‚ö†Ô∏è Rischi in evidenza</h4>
                        <div id="report-risks"></div>
                    </div>

                    <div class="report-section">
                        <h4>üìÖ Scadenze imminenti</h4>
                        <div id="report-deadlines"></div>
                    </div>

                    <div class="report-section">
                        <h4>üí∞ Spese della settimana</h4>
                        <div id="report-expenses"></div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS SECTION -->
            <div id="settings" class="section">
                <h2>Impostazioni Aziende</h2>

                <div class="card">
                    <h3>Configura Nomi Aziende</h3>
                    <form id="company-names-form" onsubmit="saveCompanyNames(event)">
                        <div class="form-group">
                            <label>Nome Azienda 1</label>
                            <input type="text" id="company-1-name" value="Azienda 1">
                        </div>
                        <div class="form-group">
                            <label>Nome Azienda 2</label>
                            <input type="text" id="company-2-name" value="Azienda 2">
                        </div>
                        <div class="form-group">
                            <label>Nome Azienda 3</label>
                            <input type="text" id="company-3-name" value="Azienda 3">
                        </div>
                        <div class="form-group">
                            <label>Nome Azienda 4</label>
                            <input type="text" id="company-4-name" value="Azienda 4">
                        </div>
                        <button type="submit" class="btn btn-success">Salva Configurazione</button>
                    </form>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>Gestione Dati</h3>
                    <button onclick="exportData()" class="btn">üì• Esporta Tutti i Dati (JSON)</button>
                    <button onclick="exportToCSV()" class="btn">üìä Esporta CSV</button>
                    <button onclick="exportToExcel()" class="btn">üìë Esporta Excel</button>
                    <button onclick="importData()" class="btn">üì§ Importa Dati</button>
                    <button onclick="createBackup()" class="btn btn-success">üíæ Backup Manuale</button>
                    <button onclick="clearAllData()" class="btn btn-danger">üóëÔ∏è Cancella Tutti i Dati</button>
                    <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(event)">
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>Notifiche Browser</h3>
                    <p style="margin-bottom: 15px;">Abilita le notifiche del browser per ricevere promemoria automatici su scadenze e attivit√† urgenti.</p>
                    <button onclick="enableNotifications()" class="btn btn-success">üîî Abilita Notifiche</button>
                    <p id="notification-status" style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;"></p>
                </div>
            </div>

            <!-- VISTA CONSOLIDATA SECTION -->
            <div id="consolidated" class="section">
                <h2>üìà Dashboard Consolidata Multi-Azienda</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">Panoramica completa di tutte le aziende</p>

                <div class="consolidated-stats" id="consolidated-stats">
                    <!-- Generato dinamicamente -->
                </div>

                <div class="chart-container">
                    <div class="chart-title">Confronto Attivit√† per Azienda</div>
                    <div class="simple-bar-chart" id="company-comparison-chart">
                        <!-- Generato dinamicamente -->
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>üö® Alert Globali</h3>
                    <div id="global-alerts">
                        <!-- Generato dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- ANALYTICS SECTION -->
            <div id="analytics" class="section">
                <h2>üìä Analytics e Statistiche Avanzate</h2>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Periodo:</label>
                        <select id="analytics-period" onchange="updateAnalytics()">
                            <option value="week">Ultima Settimana</option>
                            <option value="month">Ultimo Mese</option>
                            <option value="quarter">Ultimo Trimestre</option>
                            <option value="year">Ultimo Anno</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Azienda:</label>
                        <select id="analytics-company" onchange="updateAnalytics()">
                            <option value="all">Tutte le Aziende</option>
                            <option value="1">Azienda 1</option>
                            <option value="2">Azienda 2</option>
                            <option value="3">Azienda 3</option>
                            <option value="4">Azienda 4</option>
                        </select>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-box" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <h3 id="analytics-total-tasks">0</h3>
                        <p>Attivit√† Totali</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                        <h3 id="analytics-completed-rate">0%</h3>
                        <p>Tasso Completamento</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #f39c12, #d68910);">
                        <h3 id="analytics-avg-time">0</h3>
                        <p>Tempo Medio (giorni)</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <h3 id="analytics-overdue">0</h3>
                        <p>In Ritardo</p>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Attivit√† per Priorit√†</div>
                    <div class="simple-bar-chart" id="priority-chart">
                        <!-- Generato dinamicamente -->
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Spese per Categoria</div>
                    <div class="simple-bar-chart" id="expenses-chart">
                        <!-- Generato dinamicamente -->
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Trend Settimanale Attivit√† Completate</div>
                    <div class="simple-bar-chart" id="weekly-trend-chart">
                        <!-- Generato dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- TEMPLATE RICORRENTI SECTION -->
            <div id="templates" class="section">
                <h2>üîÑ Template Attivit√† Ricorrenti</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">Crea template per attivit√† che si ripetono regolarmente</p>

                <div class="card">
                    <h3>Crea Nuovo Template</h3>
                    <form id="template-form" onsubmit="addTemplate(event)">
                        <div class="form-group">
                            <label>Titolo Template *</label>
                            <input type="text" id="template-title" required placeholder="es: Controllo Email Settimanale">
                        </div>
                        <div class="form-group">
                            <label>Descrizione</label>
                            <textarea id="template-description" rows="3" placeholder="Descrizione dell'attivit√† ricorrente..."></textarea>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Categoria</label>
                                <select id="template-category">
                                    <option value="urgent">Urgente</option>
                                    <option value="important">Importante</option>
                                    <option value="fiscal">Fiscale/Contabile</option>
                                    <option value="hr">HR/Personale</option>
                                    <option value="critical">Criticit√†</option>
                                    <option value="decisions">Decisioni</option>
                                    <option value="operational">Operativo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Priorit√†</label>
                                <select id="template-priority">
                                    <option value="aplus">A+ - Urgente</option>
                                    <option value="a">A - Importante</option>
                                    <option value="b">B - Normale</option>
                                    <option value="c">C - Bassa</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Frequenza</label>
                            <select id="template-frequency">
                                <option value="daily">Giornaliera</option>
                                <option value="weekly">Settimanale</option>
                                <option value="monthly">Mensile</option>
                                <option value="quarterly">Trimestrale</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Crea Template</button>
                    </form>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>Template Salvati</h3>
                    <div id="templates-list">
                        <div class="empty-state">
                            <p>Nessun template creato. Crea il tuo primo template ricorrente!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUDIT LOG SECTION -->
            <div id="audit-log" class="section">
                <h2>üìú Storico Modifiche (Audit Log)</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">Traccia di tutte le modifiche effettuate nel sistema</p>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Filtra per tipo:</label>
                        <select id="audit-filter-type" onchange="filterAuditLog()">
                            <option value="all">Tutte le Azioni</option>
                            <option value="create">Creazioni</option>
                            <option value="update">Modifiche</option>
                            <option value="delete">Eliminazioni</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Azienda:</label>
                        <select id="audit-filter-company" onchange="filterAuditLog()">
                            <option value="all">Tutte</option>
                            <option value="1">Azienda 1</option>
                            <option value="2">Azienda 2</option>
                            <option value="3">Azienda 3</option>
                            <option value="4">Azienda 4</option>
                        </select>
                    </div>
                    <button class="filter-reset-btn" onclick="clearAuditLog()">Pulisci Storico</button>
                </div>

                <div class="audit-log-container" id="audit-log-container">
                    <div class="empty-state">
                        <p>Nessuna modifica registrata ancora.</p>
                    </div>
                </div>
            </div>

            <!-- EMAIL & ASSISTENTE SECTION -->
            <div id="emails" class="section">
                <h2>üìß Gestione Email con Assistente IA - <span id="emails-company-name">Azienda 1</span></h2>

                <!-- Statistiche Email -->
                <div class="stats-container" style="margin-bottom: 30px;">
                    <div class="stat-box" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <h3 id="stat-unread-emails">0</h3>
                        <p>Email Non Lette</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #f39c12, #d68910);">
                        <h3 id="stat-urgent-emails">0</h3>
                        <p>Email Urgenti</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <h3 id="stat-today-emails">0</h3>
                        <p>Ricevute Oggi</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        <h3 id="stat-flagged-emails">0</h3>
                        <p>Con Stella ‚≠ê</p>
                    </div>
                </div>

                <!-- Daily Briefing Button -->
                <div style="margin-bottom: 20px;">
                    <button onclick="showDailyBriefing()" style="width: 100%; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.3em; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                        ‚òÄÔ∏è Daily Briefing - Cosa fare oggi
                    </button>
                </div>

                <!-- Tabs Email -->
                <div class="email-tabs">
                    <button class="email-tab active" onclick="switchEmailTab('inbox')">üì• Posta in Arrivo (<span id="inbox-count">0</span>)</button>
                    <button class="email-tab" onclick="switchEmailTab('sent')">üì§ Inviati (<span id="sent-count">0</span>)</button>
                    <button class="email-tab" onclick="switchEmailTab('archived')">üì¶ Archiviati (<span id="archived-count">0</span>)</button>
                    <button class="email-tab" onclick="switchEmailTab('trash')">üóëÔ∏è Cestino (<span id="trash-count">0</span>)</button>
                    <button class="email-tab compose-btn" onclick="composeNewEmail()">‚úâÔ∏è Nuova Email</button>
                </div>

                <!-- Filtri e Ricerca -->
                <div class="card">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <input type="text" id="email-search" placeholder="üîç Cerca email..." oninput="filterEmails()" style="width: 300px; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
                        </div>
                        <div class="filter-group">
                            <label>Priorit√†:</label>
                            <select id="email-filter-priority" onchange="filterEmails()">
                                <option value="all">Tutte</option>
                                <option value="urgent">üî¥ Urgenti</option>
                                <option value="important">üü° Importanti</option>
                                <option value="normal">üü¢ Normali</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Categoria:</label>
                            <select id="email-filter-category" onchange="filterEmails()">
                                <option value="all">Tutte</option>
                                <option value="clienti">üë• Clienti</option>
                                <option value="fornitori">üè≠ Fornitori</option>
                                <option value="fiscale">üí∞ Fiscale</option>
                                <option value="hr">üëî HR</option>
                                <option value="commerciale">üìà Commerciale</option>
                                <option value="legale">‚öñÔ∏è Legale</option>
                                <option value="altro">üìã Altro</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>
                                <input type="checkbox" id="email-filter-unread" onchange="filterEmails()">
                                Solo non lette
                            </label>
                            <label style="margin-left: 15px;">
                                <input type="checkbox" id="email-filter-starred" onchange="filterEmails()">
                                Solo con stella ‚≠ê
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Lista Email -->
                <div class="card">
                    <div class="email-list-header">
                        <h3>
                            <span id="current-email-tab-title">üì• Posta in Arrivo</span>
                            <button class="ai-assistant-btn" onclick="toggleEmailAssistant()" title="Assistente IA">ü§ñ Assistente IA</button>
                        </h3>
                    </div>
                    <div id="email-list-container" class="email-list-container">
                        <!-- Email list will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- RICERCA GLOBALE -->
        <div class="search-bar-sticky">
            <button class="search-icon-btn" onclick="toggleGlobalSearch()" title="Ricerca Globale (Ctrl+K)">üîç</button>
        </div>

        <div id="global-search" class="global-search-container">
            <div class="global-search-box">
                <input
                    type="text"
                    class="global-search-input"
                    id="global-search-input"
                    placeholder="Cerca in tutte le sezioni... (ESC per chiudere)"
                    onkeyup="performGlobalSearch(event)"
                >
                <div class="global-search-results" id="global-search-results">
                    <p style="text-align: center; padding: 40px; color: #7f8c8d;">
                        Inizia a digitare per cercare in attivit√†, scadenze, contatti, documenti e altro...
                    </p>
                </div>
            </div>
        </div>

        <!-- PANNELLO NOTIFICHE -->
        <div id="notification-badge" class="notification-badge" onclick="toggleNotificationPanel()" style="display: none;">
            <span id="notification-count">0</span> üîî
        </div>

        <div id="notification-panel" class="notification-panel">
            <div class="notification-panel-header">
                <span>Notifiche</span>
                <span class="close-modal" onclick="toggleNotificationPanel()" style="cursor: pointer;">&times;</span>
            </div>
            <div id="notification-list">
                <div class="empty-state" style="padding: 40px; text-align: center; color: #7f8c8d;">
                    <p>Nessuna notifica al momento</p>
                </div>
            </div>
        </div>

        <!-- BACKUP INDICATOR -->
        <div id="backup-indicator" class="backup-indicator">
            üíæ Backup salvato
        </div>

        <!-- MODAL DETTAGLIO ELEMENTO -->
        <div id="detail-modal" class="detail-modal">
            <div class="detail-modal-content">
                <div class="detail-modal-header">
                    <h2 id="detail-modal-title">Dettaglio</h2>
                    <span class="detail-modal-close" onclick="closeDetailModal()">&times;</span>
                </div>
                <div class="detail-modal-body" id="detail-modal-body">
                    <!-- Contenuto generato dinamicamente -->
                </div>
            </div>
        </div>

        <!-- MODAL ARCHIVI DOCUMENTI -->
        <div id="category-modal" class="category-modal">
            <div class="category-modal-content">
                <div class="modal-header">
                    <h3><span id="modal-category-icon"></span> <span id="modal-category-title"></span></h3>
                    <span class="close-modal" onclick="closeCategory()">&times;</span>
                </div>

                <div class="document-form">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">Aggiungi Nuovo Documento</h4>
                    <form id="document-form" onsubmit="addDocument(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nome Documento *</label>
                                <input type="text" id="doc-name" required placeholder="es: Contratto_Fornitore_2024">
                            </div>
                            <div class="form-group">
                                <label>Data Documento</label>
                                <input type="date" id="doc-date">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo Documento</label>
                                <input type="text" id="doc-type" placeholder="es: Contratto, Fattura, PEC...">
                            </div>
                            <div class="form-group">
                                <label>Riferimento/Protocollo</label>
                                <input type="text" id="doc-reference" placeholder="es: Prot. 123/2024">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Note</label>
                            <textarea id="doc-notes" rows="3" placeholder="Annotazioni sul documento..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Link/Percorso File</label>
                            <input type="text" id="doc-link" placeholder="es: C:\Documenti\Contratti\file.pdf o URL">
                        </div>
                        <button type="submit" class="btn btn-success">Aggiungi Documento</button>
                    </form>
                </div>

                <div>
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">Documenti Archiviati (<span id="modal-doc-count">0</span>)</h4>
                    <div class="documents-list" id="documents-list">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">Nessun documento in questa categoria</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL VISUALIZZA EMAIL -->
        <div id="email-view-modal" class="detail-modal">
            <div class="detail-modal-content" style="max-width: 1000px;">
                <div class="detail-modal-header">
                    <h2 id="email-view-title">üìß Email</h2>
                    <span class="detail-modal-close" onclick="closeEmailView()">&times;</span>
                </div>
                <div class="detail-modal-body" id="email-view-body">
                    <!-- Contenuto email generato dinamicamente -->
                </div>
            </div>
        </div>

        <!-- MODAL COMPONI EMAIL -->
        <div id="email-compose-modal" class="detail-modal">
            <div class="detail-modal-content" style="max-width: 900px;">
                <div class="detail-modal-header">
                    <h2>‚úâÔ∏è Nuova Email</h2>
                    <span class="detail-modal-close" onclick="closeEmailCompose()">&times;</span>
                </div>
                <div class="detail-modal-body">
                    <form id="email-compose-form" onsubmit="sendEmail(event)">
                        <div class="form-group">
                            <label>A: *</label>
                            <input type="email" id="email-to" required placeholder="destinatario@example.com" multiple>
                            <small style="color: #7f8c8d;">Separa pi√π destinatari con virgola</small>
                        </div>
                        <div class="form-group">
                            <label>Oggetto: *</label>
                            <input type="text" id="email-subject" required placeholder="Oggetto dell'email">
                        </div>
                        <div class="form-group">
                            <label>Categoria:</label>
                            <select id="email-compose-category">
                                <option value="clienti">üë• Clienti</option>
                                <option value="fornitori">üè≠ Fornitori</option>
                                <option value="fiscale">üí∞ Fiscale</option>
                                <option value="hr">üëî HR</option>
                                <option value="commerciale">üìà Commerciale</option>
                                <option value="legale">‚öñÔ∏è Legale</option>
                                <option value="altro">üìã Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priorit√†:</label>
                            <select id="email-compose-priority">
                                <option value="normal">üü¢ Normale</option>
                                <option value="important">üü° Importante</option>
                                <option value="urgent">üî¥ Urgente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Messaggio: *</label>
                            <textarea id="email-body" rows="10" required placeholder="Scrivi il messaggio qui..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="email-use-template">
                                Usa Template
                            </label>
                            <select id="email-template-select" style="display: none; margin-left: 10px;" onchange="applyEmailTemplate()">
                                <option value="">-- Seleziona Template --</option>
                                <option value="conferma-ordine">Conferma Ordine</option>
                                <option value="sollecito-pagamento">Sollecito Pagamento</option>
                                <option value="richiesta-info">Richiesta Informazioni</option>
                                <option value="conferma-appuntamento">Conferma Appuntamento</option>
                                <option value="risposta-reclamo">Risposta a Reclamo</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" class="btn" onclick="closeEmailCompose()">Annulla</button>
                            <button type="button" class="btn" onclick="saveDraft()">üíæ Salva Bozza</button>
                            <button type="submit" class="btn btn-success">üì§ Invia Email</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- PANNELLO ASSISTENTE IA -->
        <div id="email-assistant-panel" class="assistant-panel">
            <div class="assistant-panel-content">
                <div class="assistant-panel-header">
                    <h3>ü§ñ Assistente Email IA</h3>
                    <span class="close-btn" onclick="toggleEmailAssistant()">&times;</span>
                </div>
                <div class="assistant-panel-body">
                    <!-- Suggerimenti Intelligenti -->
                    <div class="assistant-section">
                        <h4>üí° Suggerimenti Intelligenti</h4>
                        <div id="assistant-suggestions" class="suggestion-list">
                            <div class="suggestion-item">
                                <span class="suggestion-icon">‚ö°</span>
                                <div>
                                    <strong>3 email urgenti</strong> richiedono attenzione immediata
                                    <button class="btn-small" onclick="showUrgentEmails()">Visualizza</button>
                                </div>
                            </div>
                            <div class="suggestion-item">
                                <span class="suggestion-icon">üìÖ</span>
                                <div>
                                    <strong>Scadenza richiesta info</strong> entro domani
                                    <button class="btn-small" onclick="showDeadlineEmails()">Visualizza</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Risposte Rapide Suggerite -->
                    <div class="assistant-section">
                        <h4>‚ö° Risposte Rapide</h4>
                        <div class="quick-replies">
                            <button class="quick-reply-btn" onclick="applyQuickReply('conferma')">‚úÖ Conferma Ricevuta</button>
                            <button class="quick-reply-btn" onclick="applyQuickReply('informazioni')">üìã Richiedi Informazioni</button>
                            <button class="quick-reply-btn" onclick="applyQuickReply('ringrazia')">üôè Ringraziamento</button>
                            <button class="quick-reply-btn" onclick="applyQuickReply('sollecito')">‚è∞ Sollecito</button>
                        </div>
                    </div>

                    <!-- Analisi Email Corrente -->
                    <div class="assistant-section">
                        <h4>üîç Analisi IA</h4>
                        <div id="email-analysis" class="analysis-box">
                            <p style="color: #7f8c8d; text-align: center; padding: 20px;">
                                Seleziona un'email per vedere l'analisi IA
                            </p>
                        </div>
                    </div>

                    <!-- Azioni Suggerite -->
                    <div class="assistant-section">
                        <h4>üéØ Azioni Suggerite</h4>
                        <div id="suggested-actions" class="actions-list">
                            <button class="action-btn" onclick="convertEmailToTask()">
                                üìù Converti in Attivit√†
                            </button>
                            <button class="action-btn" onclick="convertEmailToDeadline()">
                                üìÖ Aggiungi Scadenza
                            </button>
                            <button class="action-btn" onclick="convertEmailToContact()">
                                üë§ Salva Contatto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // STATO GLOBALE
        let currentCompany = 1;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentSOPChecklist = {}; // Stato checklist SOP corrente
        let currentCategory = null; // Categoria archivio corrente
        let recognition = null; // Riconoscimento vocale
        let notificationPermission = false; // Permesso notifiche browser
        let backupInterval = null; // Intervallo backup automatico
        let data = {
            companies: {
                1: { name: 'Azienda 1', tasks: [], deadlines: [], sopExecutions: [], expenses: [], appointments: [], archives: {}, contacts: [], emails: [] },
                2: { name: 'Azienda 2', tasks: [], deadlines: [], sopExecutions: [], expenses: [], appointments: [], archives: {}, contacts: [], emails: [] },
                3: { name: 'Azienda 3', tasks: [], deadlines: [], sopExecutions: [], expenses: [], appointments: [], archives: {}, contacts: [], emails: [] },
                4: { name: 'Azienda 4', tasks: [], deadlines: [], sopExecutions: [], expenses: [], appointments: [], archives: {}, contacts: [], emails: [] }
            },
            templates: [], // Template attivit√† ricorrenti
            auditLog: [], // Storico modifiche
            backups: [], // Backup automatici
            settings: {
                autoBackup: true,
                backupInterval: 30, // minuti
                notificationsEnabled: false
            }
        };

        // SOP PREDEFINITE
        const sopTemplates = [
            {
                title: "1. Gestione Email Direzionali",
                description: "Procedura per la gestione quotidiana delle email della direzione",
                steps: [
                    "Controllare email ogni 2 ore (9:00, 11:00, 14:00, 16:00)",
                    "Classificare per priorit√†: A+ (urgenti), A (importanti), B (normali), C (info)",
                    "Rispondere immediatamente alle A+, entro 2 ore alle A",
                    "Inoltrare alla direzione solo email che richiedono decisioni",
                    "Archiviare email processate in cartelle dedicate per azienda"
                ]
            },
            {
                title: "2. Gestione Documentazione Fornitori/Clienti",
                description: "Protocollo per la gestione della documentazione in entrata/uscita",
                steps: [
                    "Ricevere documento via email/PEC",
                    "Protocollare con numero progressivo e data",
                    "Verificare completezza e conformit√†",
                    "Archiviare digitalmente nella cartella aziendale corretta",
                    "Aggiornare il registro documentale",
                    "Notificare ai responsabili se richiede azione"
                ]
            },
            {
                title: "3. Standardizzazione Richieste Interne",
                description: "Template e procedura per gestire richieste dai dipendenti",
                steps: [
                    "Ricevere richiesta via form standardizzato",
                    "Verificare autorizzazioni e policy aziendali",
                    "Valutare se √® competenza diretta o richiede escalation",
                    "Processare o inoltrare alla direzione con nota",
                    "Comunicare esito entro 48 ore",
                    "Archiviare nel sistema di ticketing"
                ]
            },
            {
                title: "4. Flusso di Approvazione Documenti",
                description: "Procedura per l'approvazione di contratti, ordini e documenti formali",
                steps: [
                    "Ricevere documento in bozza dal richiedente",
                    "Verificare completezza formale e correttezza dati",
                    "Inviare per review legale se necessario",
                    "Sottoporre alla direzione per approvazione",
                    "Gestire eventuali modifiche e re-invii",
                    "Finalizzare, protocollare e archiviare versione approvata"
                ]
            },
            {
                title: "5. Archiviazione Digitale",
                description: "Sistema di archiviazione e nomenclatura file",
                steps: [
                    "Struttura cartelle: /Azienda/Anno/Categoria/Mese",
                    "Nomenclatura file: AAAAMMGG_TipoDoc_Oggetto_VX",
                    "Salvare sempre PDF/A per documenti definitivi",
                    "Backup settimanale su cloud e storage esterno",
                    "Revisione trimestrale per pulizia archivi",
                    "Mantenere log delle modifiche per documenti critici"
                ]
            },
            {
                title: "6. Preparazione Meeting Direzionali",
                description: "Checklist pre-meeting per la direzione",
                steps: [
                    "Confermare presenza partecipanti 24h prima",
                    "Preparare ordine del giorno e materiali",
                    "Stampare/condividere documentazione rilevante",
                    "Predisporre sala/link videoconferenza",
                    "Preparare action items meeting precedente",
                    "Prendere verbale e distribuire entro 24h dal meeting"
                ]
            },
            {
                title: "7. Follow-up Automatico Scadenze",
                description: "Sistema di reminder e tracking scadenze",
                steps: [
                    "Inserire scadenza nel sistema con preavviso (7, 3, 1 giorno)",
                    "Primo reminder a -7 giorni via email",
                    "Secondo reminder a -3 giorni via email + messaggio",
                    "Alert finale a -1 giorno con verifica stato",
                    "Follow-up post-scadenza se non completata",
                    "Aggiornamento dashboard settimanale"
                ]
            },
            {
                title: "8. Protocollo Comunicazione tra Aziende",
                description: "Standard per coordinamento multi-aziendale",
                steps: [
                    "Identificare chiaramente l'azienda mittente/destinataria",
                    "Usare template email standardizzato con logo azienda",
                    "CC sempre alla direzione per comunicazioni cross-azienda",
                    "Tracciare in registro comunicazioni interaziendali",
                    "Weekly sync meeting per allineamento",
                    "Repository condiviso per documenti comuni"
                ]
            },
            {
                title: "9. Protocollo Contatti con Consulenti",
                description: "Gestione rapporti con commercialista, legale, consulenti HR",
                steps: [
                    "Mantenere elenco aggiornato consulenti per azienda",
                    "Centralizzare tutte le comunicazioni via email aziendale",
                    "Preparare brief completo prima di ogni contatto",
                    "Richiedere sempre conferma scritta di accordi/pareri",
                    "Tracciare ore/costi consulenze in apposito registro",
                    "Review trimestrale performance e costi consulenti"
                ]
            },
            {
                title: "10. Preparazione Report Settimanale al Management",
                description: "Template e timing per il report direzionale",
                steps: [
                    "Raccogliere dati venerd√¨ pomeriggio (entro le 16:00)",
                    "Compilare sezioni: completato, in corso, decisioni, rischi, scadenze",
                    "Validare numeri e verificare coerenza",
                    "Formattare in template standard corporate",
                    "Inviare entro venerd√¨ sera o luned√¨ mattina 9:00",
                    "Archiviare nella cartella Reports/Anno/Settimana"
                ]
            },
            {
                title: "11. Prenotazione Viaggi e Trasferte",
                description: "Procedura completa per organizzare viaggi di lavoro",
                steps: [
                    "Ricevere richiesta con date, destinazione e budget",
                    "Verificare disponibilit√† treni/aerei su Trenitalia, Italo, comparatori voli",
                    "Selezionare orari compatibili con appuntamenti",
                    "Prenotare biglietti e inviare conferme via email",
                    "Prenotare hotel (verificare cancellazione gratuita)",
                    "Organizzare transfer se necessario",
                    "Inviare itinerario completo 24h prima della partenza",
                    "Archiviare ricevute per rimborso spese"
                ]
            },
            {
                title: "12. Gestione Sistemi Allarme Casa",
                description: "Protocollo per gestione allarmi domestici",
                steps: [
                    "Attivazione: verificare chiusura porte/finestre",
                    "Inserire codice e attivare modalit√† (totale/parziale/perimetrale)",
                    "Verificare LED conferma attivazione",
                    "Disattivazione: inserire codice entro 30 secondi dall'ingresso",
                    "In caso di allarme accidentale: disattivare e chiamare centrale",
                    "Test mensile sensori e batterie",
                    "Manutenzione annuale con tecnico autorizzato"
                ]
            },
            {
                title: "13. Gestione Utenze Domestiche",
                description: "Procedura per gestione bollette e contratti utenze",
                steps: [
                    "Verificare arrivo bollette luce/gas/acqua/internet",
                    "Controllare consumi e confrontare con mese precedente",
                    "Verificare correttezza importi e letture",
                    "Pagare entro scadenza (domiciliazione o bollettino)",
                    "Segnalare anomalie o contestare addebiti errati",
                    "Valutare cambio fornitore annualmente per risparmio",
                    "Archiviare bollette pagate per categoria"
                ]
            },
            {
                title: "14. Manutenzione Ordinaria Casa",
                description: "Checklist manutenzione programmata impianti domestici",
                steps: [
                    "Revisione caldaia annuale (entro scadenza legale)",
                    "Controllo filtri condizionatori (inizio estate/inverno)",
                    "Pulizia canne fumarie annuale",
                    "Controllo impianto elettrico (interruttori, prese)",
                    "Verifica perdite idrauliche (rubinetti, tubi)",
                    "Controllo serramenti e guarnizioni",
                    "Tenere registro manutenzioni con date e tecnici"
                ]
            },
            {
                title: "15. Gestione Emergenze Domestiche",
                description: "Protocollo per emergenze casa (perdite, guasti, effrazioni)",
                steps: [
                    "Identificare tipo emergenza e gravit√†",
                    "Chiudere acqua/gas/elettricit√† se necessario",
                    "Contattare tecnico di fiducia (idraulico/elettricista/fabbro)",
                    "Se non disponibile, chiamare servizio emergenze 24h",
                    "Documentare con foto il danno",
                    "Avvisare assicurazione se sinistro coperto da polizza",
                    "Richiedere fattura e archiviare per detrazioni fiscali"
                ]
            },
            {
                title: "16. Protocollazione e Archiviazione Documenti",
                description: "Sistema standardizzato per gestione documentale aziendale",
                steps: [
                    "Ricevere documento (email, PEC, cartaceo)",
                    "Assegnare numero protocollo progressivo annuale",
                    "Classificare per tipo e categoria (vedi sezione Archivi)",
                    "Digitalizzare se documento cartaceo",
                    "Salvare con nomenclatura: AAAAMMGG_Tipo_Oggetto_V1",
                    "Archiviare nella cartella Azienda/Anno/Categoria/Mese",
                    "Aggiornare registro protocollo con metadati"
                ]
            },
            {
                title: "17. Gestione Ciclo Ordini Fornitori",
                description: "Flusso completo dalla richiesta alla ricezione merce",
                steps: [
                    "Ricevere richiesta d'acquisto da reparto richiedente",
                    "Verificare budget e autorizzazioni",
                    "Richiedere preventivi a 3 fornitori qualificati",
                    "Confrontare prezzi, tempi consegna, condizioni pagamento",
                    "Emettere ordine al fornitore selezionato",
                    "Tracciare ordine e sollecitare se ritardi",
                    "Verificare merce in arrivo con DDT",
                    "Archiviare ordine-DDT-fattura nella cartella Fornitori"
                ]
            },
            {
                title: "18. Rinnovo Licenze e Certificazioni Aziendali",
                description: "Gestione scadenze certificazioni e autorizzazioni",
                steps: [
                    "Mantenere calendario scadenze licenze per ogni azienda",
                    "Reminder a -60 giorni per avvio pratica rinnovo",
                    "Raccogliere documentazione necessaria",
                    "Contattare ente/consulente per iter rinnovo",
                    "Monitorare avanzamento pratica",
                    "Verificare emissione nuovo certificato prima scadenza",
                    "Archiviare in cartella Licenze e aggiornare scadenziario"
                ]
            },
            {
                title: "19. Gestione Pagamenti e Bonifici",
                description: "Procedura per esecuzione pagamenti sicuri",
                steps: [
                    "Verificare fattura e corrispondenza con ordine/DDT",
                    "Controllare IBAN beneficiario (attenzione a frodi)",
                    "Verificare autorizzazione pagamento dalla direzione",
                    "Eseguire bonifico da home banking aziendale",
                    "Inserire causale dettagliata con numero fattura",
                    "Salvare CRO/ricevuta bonifico",
                    "Archiviare ricevuta insieme a fattura pagata"
                ]
            },
            {
                title: "20. Controllo Scadenze Fiscali Mensili",
                description: "Checklist mensile adempimenti fiscali per azienda",
                steps: [
                    "Giorno 16: verificare invio liquidazione IVA del mese precedente",
                    "Giorno 16: controllare versamenti F24 (IVA, ritenute, contributi)",
                    "Fine mese: sollecitare commercialista per chiusura contabilit√†",
                    "Verificare invio fatture elettroniche e ricezione notifiche SDI",
                    "Controllare registrazione fatture passive ricevute",
                    "Aggiornare cash flow previsionale con incassi/pagamenti",
                    "Report mensile alla direzione su posizione fiscale"
                ]
            },
            {
                title: "21. Negoziazione e Rinnovo Contratti",
                description: "Strategia per rinnovo contratti fornitori e servizi",
                steps: [
                    "Identificare contratti in scadenza nei prossimi 90 giorni",
                    "Analizzare performance attuale fornitore (qualit√†, puntualit√†, prezzo)",
                    "Richiedere preventivi a fornitori alternativi per confronto",
                    "Preparare punti di negoziazione (sconto, dilazioni, servizi extra)",
                    "Condurre trattativa o delegare a direzione se importi rilevanti",
                    "Formalizzare accordi per iscritto",
                    "Archiviare nuovo contratto e aggiornare scadenziario"
                ]
            },
            {
                title: "22. Onboarding Nuovo Dipendente",
                description: "Checklist accoglienza e inserimento nuova risorsa",
                steps: [
                    "Preparare postazione lavoro (PC, telefono, accessi, badge)",
                    "Creare email aziendale e account sistemi IT",
                    "Preparare kit welcome (contratto, regolamenti, organigramma)",
                    "Programmare formazione obbligatoria (sicurezza, privacy)",
                    "Assegnare tutor/responsabile per affiancamento",
                    "Pianificare incontri con team e direzione prima settimana",
                    "Follow-up a 7-30-90 giorni per feedback inserimento"
                ]
            },
            {
                title: "23. Gestione Sinistri Assicurativi",
                description: "Procedura per denuncia e gestione sinistri",
                steps: [
                    "Verificare copertura assicurativa per il tipo di sinistro",
                    "Raccogliere documentazione (foto, testimoni, verbali)",
                    "Denunciare sinistro a compagnia entro termini polizza",
                    "Aprire pratica e ottenere numero sinistro",
                    "Collaborare con perito per sopralluogo",
                    "Fornire documenti richiesti (preventivi riparazioni, fatture)",
                    "Monitorare liquidazione e sollecitare se ritardi"
                ]
            },
            {
                title: "24. Richiesta e Confronto Preventivi",
                description: "Metodo standardizzato per procurement trasparente",
                steps: [
                    "Definire specifiche tecniche dettagliate del bene/servizio",
                    "Identificare almeno 3 fornitori qualificati",
                    "Inviare richiesta preventivo con stesso capitolato a tutti",
                    "Dare deadline chiara per invio offerte (es. 7 giorni)",
                    "Creare matrice comparativa (prezzo, qualit√†, tempi, condizioni)",
                    "Valutare anche affidabilit√† storica fornitore",
                    "Documentare scelta e archiviare preventivi"
                ]
            },
            {
                title: "25. Gestione Reclami e Contestazioni Clienti",
                description: "Protocollo per gestione professionale reclami",
                steps: [
                    "Ricevere reclamo e registrare in sistema ticketing",
                    "Confermare ricezione al cliente entro 24 ore",
                    "Investigare cause del problema (interno, fornitore, errore cliente)",
                    "Proporre soluzione entro 48-72 ore",
                    "Implementare azione correttiva concordata",
                    "Follow-up con cliente per verificare soddisfazione",
                    "Analizzare reclamo per prevenire ricorrenze future"
                ]
            }
        ];

        // CATEGORIE ARCHIVI CON ICONE E TITOLI
        const categoryInfo = {
            'contratti': { icon: 'üìÑ', title: 'Contratti' },
            'fiscale': { icon: 'üí∞', title: 'Fiscale e Tributario' },
            'legale': { icon: '‚öñÔ∏è', title: 'Legale' },
            'risorse-umane': { icon: 'üë•', title: 'Risorse Umane' },
            'assicurazioni-azienda': { icon: 'üõ°Ô∏è', title: 'Assicurazioni Aziendali' },
            'bancario': { icon: 'üè¶', title: 'Bancario' },
            'enti-istituzioni': { icon: 'üèõÔ∏è', title: 'Enti e Istituzioni' },
            'licenze': { icon: 'üìú', title: 'Licenze e Certificazioni' },
            'fornitori': { icon: 'üì¶', title: 'Fornitori' },
            'clienti': { icon: 'ü§ù', title: 'Clienti' },
            'immobili': { icon: 'üè°', title: 'Immobili' },
            'utenze-domestiche': { icon: 'üí°', title: 'Utenze Domestiche' },
            'condominio': { icon: 'üè¢', title: 'Condominio' },
            'manutenzioni-casa': { icon: 'üîß', title: 'Manutenzioni Casa' },
            'assicurazioni-casa': { icon: 'üõ°Ô∏è', title: 'Assicurazioni Casa' },
            'documenti-personali': { icon: 'üÜî', title: 'Documenti Personali' },
            'email-archiviate': { icon: 'üìß', title: 'Email Archiviate' },
            'pec-aziendale': { icon: 'üì¨', title: 'PEC Aziendale' },
            'corrispondenza-ufficiale': { icon: 'üìÆ', title: 'Corrispondenza Ufficiale' }
        };

        // GESTIONE ARCHIVI DOCUMENTI
        function openCategory(categoryId) {
            currentCategory = categoryId;
            const info = categoryInfo[categoryId];

            document.getElementById('modal-category-icon').textContent = info.icon;
            document.getElementById('modal-category-title').textContent = info.title;

            renderDocuments();
            document.getElementById('category-modal').style.display = 'block';

            // Reset form
            document.getElementById('document-form').reset();
            document.getElementById('doc-date').valueAsDate = new Date();
        }

        function closeCategory() {
            document.getElementById('category-modal').style.display = 'none';
            currentCategory = null;
            updateArchivesCounts();
        }

        function addDocument(event) {
            event.preventDefault();

            const doc = {
                id: Date.now(),
                name: document.getElementById('doc-name').value,
                date: document.getElementById('doc-date').value,
                type: document.getElementById('doc-type').value,
                reference: document.getElementById('doc-reference').value,
                notes: document.getElementById('doc-notes').value,
                link: document.getElementById('doc-link').value,
                createdAt: new Date().toISOString(),
                company: currentCompany
            };

            if (!data.companies[currentCompany].archives[currentCategory]) {
                data.companies[currentCompany].archives[currentCategory] = [];
            }

            data.companies[currentCompany].archives[currentCategory].push(doc);
            saveData();
            renderDocuments();
            document.getElementById('document-form').reset();
            document.getElementById('doc-date').valueAsDate = new Date();
        }

        function renderDocuments() {
            const documents = data.companies[currentCompany].archives[currentCategory] || [];
            const documentsList = document.getElementById('documents-list');
            const docCount = document.getElementById('modal-doc-count');

            docCount.textContent = documents.length;

            if (documents.length === 0) {
                documentsList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Nessun documento in questa categoria</p>';
                return;
            }

            documentsList.innerHTML = documents.map(doc => `
                <div class="document-item">
                    <div class="document-details">
                        <div class="document-name">${doc.name}</div>
                        <div class="document-meta">
                            ${doc.type ? `<span>üìã ${doc.type}</span> ‚Ä¢ ` : ''}
                            ${doc.date ? `<span>üìÖ ${new Date(doc.date).toLocaleDateString('it-IT')}</span> ‚Ä¢ ` : ''}
                            ${doc.reference ? `<span>üîñ ${doc.reference}</span> ‚Ä¢ ` : ''}
                            <span>Aggiunto: ${new Date(doc.createdAt).toLocaleDateString('it-IT')}</span>
                        </div>
                        ${doc.notes ? `<div style="margin-top: 5px; font-size: 0.9em; color: #555;">${doc.notes}</div>` : ''}
                    </div>
                    <div class="document-actions">
                        ${doc.link ? `<a href="${doc.link}" class="document-link" target="_blank">Apri</a>` : ''}
                        <button class="btn btn-danger btn-small" onclick="deleteDocument(${doc.id})">Elimina</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteDocument(docId) {
            if (confirm('Sei sicuro di voler eliminare questo documento?')) {
                const archives = data.companies[currentCompany].archives[currentCategory] || [];
                data.companies[currentCompany].archives[currentCategory] = archives.filter(d => d.id !== docId);
                saveData();
                renderDocuments();
                updateArchivesCounts();
            }
        }

        function updateArchivesCounts() {
            Object.keys(categoryInfo).forEach(categoryId => {
                const count = (data.companies[currentCompany].archives[categoryId] || []).length;
                const countElement = document.getElementById(`count-${categoryId}`);
                if (countElement) {
                    countElement.textContent = `${count} documento${count !== 1 ? 'i' : ''}`;
                }
            });
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const modal = document.getElementById('category-modal');
            if (event.target === modal) {
                closeCategory();
            }
        }

        // GESTIONE CONTATTI
        function showContactForm() {
            document.getElementById('contact-form-container').style.display = 'block';
            document.getElementById('contact-form').reset();
            document.getElementById('contact-id').value = '';
        }

        function cancelContactForm() {
            document.getElementById('contact-form-container').style.display = 'none';
            document.getElementById('contact-form').reset();
        }

        function saveContact(event) {
            event.preventDefault();

            const contactId = document.getElementById('contact-id').value;
            const contact = {
                id: contactId || Date.now(),
                name: document.getElementById('contact-name').value,
                company: document.getElementById('contact-company').value,
                role: document.getElementById('contact-role').value,
                phone1: document.getElementById('contact-phone1').value,
                phone2: document.getElementById('contact-phone2').value,
                email1: document.getElementById('contact-email1').value,
                email2: document.getElementById('contact-email2').value,
                category: document.getElementById('contact-category').value,
                address: document.getElementById('contact-address').value,
                notes: document.getElementById('contact-notes').value,
                createdAt: new Date().toISOString()
            };

            if (contactId) {
                // Modifica contatto esistente
                const index = data.companies[currentCompany].contacts.findIndex(c => c.id == contactId);
                if (index !== -1) {
                    data.companies[currentCompany].contacts[index] = contact;
                }
            } else {
                // Nuovo contatto
                data.companies[currentCompany].contacts.push(contact);
            }

            saveData();
            cancelContactForm();
            renderContacts();
            showNotification(contactId ? 'Contatto aggiornato!' : 'Contatto aggiunto con successo!');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderContacts() {
            const contacts = data.companies[currentCompany].contacts || [];
            const contactsList = document.getElementById('contacts-list');
            const contactsCount = document.getElementById('contacts-count');

            contactsCount.textContent = contacts.length;

            if (contacts.length === 0) {
                contactsList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">Nessun contatto presente. Clicca su "Nuovo Contatto" per aggiungerne uno.</p>';
                return;
            }

            // Ordina per nome
            const sortedContacts = [...contacts].sort((a, b) => a.name.localeCompare(b.name));

            contactsList.innerHTML = sortedContacts.map(contact => `
                <div class="contact-card">
                    <div class="contact-info">
                        <span class="contact-category-badge ${contact.category}">${getCategoryLabel(contact.category)}</span>
                        <div class="contact-name">${escapeHtml(contact.name)}</div>
                        ${contact.company ? `<div class="contact-company">üè¢ ${escapeHtml(contact.company)}${contact.role ? ` - ${escapeHtml(contact.role)}` : ''}</div>` : ''}

                        <div class="contact-details">
                            ${contact.phone1 ? `<div class="contact-detail-item">üìû <a href="tel:${contact.phone1}">${escapeHtml(contact.phone1)}</a></div>` : ''}
                            ${contact.phone2 ? `<div class="contact-detail-item">üì± <a href="tel:${contact.phone2}">${escapeHtml(contact.phone2)}</a></div>` : ''}
                            ${contact.email1 ? `<div class="contact-detail-item">‚úâÔ∏è <a href="mailto:${contact.email1}">${escapeHtml(contact.email1)}</a></div>` : ''}
                            ${contact.email2 ? `<div class="contact-detail-item">üìß <a href="mailto:${contact.email2}">${escapeHtml(contact.email2)}</a></div>` : ''}
                            ${contact.address ? `<div class="contact-detail-item">üìç ${escapeHtml(contact.address)}</div>` : ''}
                        </div>

                        ${contact.notes ? `<div class="contact-notes-preview">üìù ${escapeHtml(contact.notes)}</div>` : ''}
                    </div>

                    <div class="contact-actions">
                        <button class="btn btn-small" onclick='editContact(${contact.id})'>‚úèÔ∏è Modifica</button>
                        <button class="btn btn-danger btn-small" onclick="deleteContact(${contact.id})">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `).join('');
        }

        function getCategoryLabel(category) {
            const labels = {
                'fornitore': 'Fornitore',
                'cliente': 'Cliente',
                'consulente': 'Consulente',
                'dipendente': 'Dipendente',
                'partner': 'Partner',
                'istituzione': 'Istituzione',
                'personale': 'Personale',
                'altro': 'Altro'
            };
            return labels[category] || category;
        }

        function editContact(contactId) {
            const contact = data.companies[currentCompany].contacts.find(c => c.id == contactId);
            if (!contact) return;

            document.getElementById('contact-id').value = contact.id;
            document.getElementById('contact-name').value = contact.name;
            document.getElementById('contact-company').value = contact.company || '';
            document.getElementById('contact-role').value = contact.role || '';
            document.getElementById('contact-phone1').value = contact.phone1 || '';
            document.getElementById('contact-phone2').value = contact.phone2 || '';
            document.getElementById('contact-email1').value = contact.email1;
            document.getElementById('contact-email2').value = contact.email2 || '';
            document.getElementById('contact-category').value = contact.category;
            document.getElementById('contact-address').value = contact.address || '';
            document.getElementById('contact-notes').value = contact.notes || '';

            document.getElementById('contact-form-container').style.display = 'block';
            document.getElementById('contact-form-container').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteContact(contactId) {
            if (confirm('Sei sicuro di voler eliminare questo contatto?')) {
                data.companies[currentCompany].contacts = data.companies[currentCompany].contacts.filter(c => c.id !== contactId);
                saveData();
                renderContacts();
                showNotification('Contatto eliminato!');
            }
        }

        function filterContacts() {
            const searchTerm = document.getElementById('contact-search').value.toLowerCase();
            const categoryFilter = document.getElementById('contact-filter-category').value;
            const contacts = data.companies[currentCompany].contacts || [];

            const filtered = contacts.filter(contact => {
                const matchesSearch = !searchTerm ||
                    contact.name.toLowerCase().includes(searchTerm) ||
                    (contact.company && contact.company.toLowerCase().includes(searchTerm)) ||
                    (contact.email1 && contact.email1.toLowerCase().includes(searchTerm)) ||
                    (contact.email2 && contact.email2.toLowerCase().includes(searchTerm)) ||
                    (contact.phone1 && contact.phone1.includes(searchTerm)) ||
                    (contact.phone2 && contact.phone2.includes(searchTerm));

                const matchesCategory = !categoryFilter || contact.category === categoryFilter;

                return matchesSearch && matchesCategory;
            });

            const contactsList = document.getElementById('contacts-list');
            const contactsCount = document.getElementById('contacts-count');

            contactsCount.textContent = contacts.length;

            if (filtered.length === 0) {
                contactsList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">Nessun contatto trovato con i filtri selezionati.</p>';
                return;
            }

            const sortedContacts = [...filtered].sort((a, b) => a.name.localeCompare(b.name));

            contactsList.innerHTML = sortedContacts.map(contact => `
                <div class="contact-card">
                    <div class="contact-info">
                        <span class="contact-category-badge ${contact.category}">${getCategoryLabel(contact.category)}</span>
                        <div class="contact-name">${escapeHtml(contact.name)}</div>
                        ${contact.company ? `<div class="contact-company">üè¢ ${escapeHtml(contact.company)}${contact.role ? ` - ${escapeHtml(contact.role)}` : ''}</div>` : ''}

                        <div class="contact-details">
                            ${contact.phone1 ? `<div class="contact-detail-item">üìû <a href="tel:${contact.phone1}">${escapeHtml(contact.phone1)}</a></div>` : ''}
                            ${contact.phone2 ? `<div class="contact-detail-item">üì± <a href="tel:${contact.phone2}">${escapeHtml(contact.phone2)}</a></div>` : ''}
                            ${contact.email1 ? `<div class="contact-detail-item">‚úâÔ∏è <a href="mailto:${contact.email1}">${escapeHtml(contact.email1)}</a></div>` : ''}
                            ${contact.email2 ? `<div class="contact-detail-item">üìß <a href="mailto:${contact.email2}">${escapeHtml(contact.email2)}</a></div>` : ''}
                            ${contact.address ? `<div class="contact-detail-item">üìç ${escapeHtml(contact.address)}</div>` : ''}
                        </div>

                        ${contact.notes ? `<div class="contact-notes-preview">üìù ${escapeHtml(contact.notes)}</div>` : ''}
                    </div>

                    <div class="contact-actions">
                        <button class="btn btn-small" onclick='editContact(${contact.id})'>‚úèÔ∏è Modifica</button>
                        <button class="btn btn-danger btn-small" onclick="deleteContact(${contact.id})">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `).join('');
        }

        function exportContacts() {
            const contacts = data.companies[currentCompany].contacts || [];
            if (contacts.length === 0) {
                alert('Nessun contatto da esportare!');
                return;
            }

            // Crea CSV
            const headers = ['Nome', 'Azienda', 'Ruolo', 'Telefono 1', 'Telefono 2', 'Email 1', 'Email 2', 'Categoria', 'Indirizzo', 'Note'];
            const csvContent = [
                headers.join(','),
                ...contacts.map(c => [
                    `"${c.name}"`,
                    `"${c.company || ''}"`,
                    `"${c.role || ''}"`,
                    `"${c.phone1 || ''}"`,
                    `"${c.phone2 || ''}"`,
                    `"${c.email1}"`,
                    `"${c.email2 || ''}"`,
                    `"${c.category}"`,
                    `"${c.address || ''}"`,
                    `"${c.notes || ''}"`
                ].join(','))
            ].join('\n');

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `contatti_${data.companies[currentCompany].name}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Contatti esportati in CSV!');
        }

        function importContacts(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;

                    if (file.name.endsWith('.csv')) {
                        // Importa CSV
                        const lines = content.split('\n');
                        const headers = lines[0].split(',');

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;

                            const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                            const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());

                            if (cleanValues.length >= 6) {
                                const contact = {
                                    id: Date.now() + i,
                                    name: cleanValues[0],
                                    company: cleanValues[1],
                                    role: cleanValues[2],
                                    phone1: cleanValues[3],
                                    phone2: cleanValues[4],
                                    email1: cleanValues[5],
                                    email2: cleanValues[6] || '',
                                    category: cleanValues[7] || 'altro',
                                    address: cleanValues[8] || '',
                                    notes: cleanValues[9] || '',
                                    createdAt: new Date().toISOString()
                                };
                                data.companies[currentCompany].contacts.push(contact);
                            }
                        }
                    } else if (file.name.endsWith('.json')) {
                        // Importa JSON
                        const importedContacts = JSON.parse(content);
                        if (Array.isArray(importedContacts)) {
                            importedContacts.forEach(c => {
                                c.id = Date.now() + Math.random();
                                data.companies[currentCompany].contacts.push(c);
                            });
                        }
                    }

                    saveData();
                    renderContacts();
                    showNotification('Contatti importati con successo!');
                } catch (error) {
                    alert('Errore durante l\'importazione: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // INIZIALIZZAZIONE
        function init() {
            loadData();
            loadCompanyNames();
            renderSOP();
            updateDashboard();
            updateAllTasks();
            updateAppointments();
            updateDeadlinesTable();
            updateExpenses();
            renderCalendar();
            updateArchivesCounts();
            renderContacts();
            // Imposta data di oggi per i form
            document.getElementById('expense-date').valueAsDate = new Date();
            document.getElementById('appointment-date').valueAsDate = new Date();
            // Inizializza riconoscimento vocale
            initVoiceRecognition();

            // Inizializza nuove funzionalit√†
            renderTemplates();
            renderAuditLog();
            updateConsolidatedDashboard();
            updateAnalytics();
            startAutoBackup();

            // Controlla permesso notifiche
            if (Notification.permission === 'granted') {
                notificationPermission = true;
                if (data.settings.notificationsEnabled) {
                    startNotificationChecks();
                }
            }

            // Inizializza status notifiche
            if (data.settings.notificationsEnabled) {
                document.getElementById('notification-status').textContent = '‚úì Notifiche abilitate';
                document.getElementById('notification-status').style.color = '#2ecc71';
            }

            // Inizializza gestione email
            initializeEmailSection();
        }

        // GESTIONE SEZIONI
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active', 'fade-in');

            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Trova e attiva il bottone corrispondente
            const buttons = document.querySelectorAll('nav button');
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(sectionId)) {
                    btn.classList.add('active');
                }
            });

            if (sectionId === 'dashboard') updateDashboard();
            if (sectionId === 'tasks') updateAllTasks();
            if (sectionId === 'appuntamenti') updateAppointments();
            if (sectionId === 'scadenze') updateDeadlinesTable();
            if (sectionId === 'spese') updateExpenses();
            if (sectionId === 'calendario') renderCalendar();
            if (sectionId === 'consolidated') updateConsolidatedDashboard();
            if (sectionId === 'analytics') updateAnalytics();
            if (sectionId === 'templates') renderTemplates();
            if (sectionId === 'audit-log') renderAuditLog();
        }

        // GESTIONE AZIENDE
        function selectCompany(companyId) {
            currentCompany = companyId;

            document.querySelectorAll('.company-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const companyName = data.companies[companyId].name;
            document.querySelectorAll('[id$="-company-name"]').forEach(el => {
                el.textContent = companyName;
            });

            // Chiudi tutte le SOP aperte quando si cambia azienda
            document.querySelectorAll('.sop-item').forEach(item => {
                item.classList.remove('expanded');
            });

            updateDashboard();
            updateAllTasks();
            updateAppointments();
            updateDeadlinesTable();
            updateExpenses();
            renderCalendar();
            updateArchivesCounts();
            renderContacts();
            updateEmailStats();
            renderEmailList();
        }

        // GESTIONE TASKS
        function addTask(event) {
            event.preventDefault();

            const task = {
                id: Date.now(),
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                category: document.getElementById('task-category').value,
                priority: document.getElementById('task-priority').value,
                deadline: document.getElementById('task-deadline').value,
                completed: false,
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].tasks.push(task);
            saveData();

            document.getElementById('task-form').reset();
            showNotification('Attivit√† aggiunta con successo!');
            updateDashboard();
            updateAllTasks();
            renderCalendar();
        }

        function deleteTask(taskId) {
            if (confirm('Sei sicura di voler eliminare questa attivit√†?')) {
                data.companies[currentCompany].tasks = data.companies[currentCompany].tasks.filter(t => t.id !== taskId);
                saveData();
                showNotification('Attivit√† eliminata!');
                updateDashboard();
                updateAllTasks();
                renderCalendar();
            }
        }

        function toggleTaskComplete(taskId) {
            const task = data.companies[currentCompany].tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveData();
                updateDashboard();
                updateAllTasks();
                renderCalendar();
            }
        }

        function updateAllTasks() {
            const container = document.getElementById('all-tasks-list');
            const tasks = data.companies[currentCompany].tasks;

            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">Nessuna attivit√† inserita</div>';
                return;
            }

            const priorityOrder = { 'aplus': 0, 'a': 1, 'b': 2, 'c': 3 };
            const sortedTasks = [...tasks].sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            container.innerHTML = sortedTasks.map(task => `
                <div class="task-item priority-${task.priority} clickable-item" style="${task.completed ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
                    <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="event.stopPropagation(); toggleTaskComplete(${task.id})">
                    <span class="priority-badge ${task.priority}">${task.priority.toUpperCase()}</span>
                    <div class="task-content" onclick="openDetailModal('task', ${task.id}, ${currentCompany})" style="cursor: pointer; flex: 1;">
                        <strong>${task.title}</strong>
                        ${task.description ? `<div style="font-size: 0.9em; margin-top: 5px;">${task.description}</div>` : ''}
                        ${task.deadline ? `<div style="font-size: 0.8em; margin-top: 5px; color: #e74c3c;">üìÖ Scadenza: ${formatDate(task.deadline)}</div>` : ''}
                        ${task.attachments && task.attachments.length > 0 ? `<div style="font-size: 0.8em; margin-top: 5px; color: #3498db;">üìé ${task.attachments.length} documento/i allegato/i</div>` : ''}
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-small" onclick="event.stopPropagation(); openDetailModal('task', ${task.id}, ${currentCompany})" title="Vedi dettagli">üëÅÔ∏è</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteTask(${task.id})">Elimina</button>
                    </div>
                </div>
            `).join('');
        }

        // GESTIONE SCADENZE
        function addDeadline(event) {
            event.preventDefault();

            const deadline = {
                id: Date.now(),
                type: document.getElementById('deadline-type').value,
                description: document.getElementById('deadline-description').value,
                date: document.getElementById('deadline-date').value,
                category: document.getElementById('deadline-category').value,
                completed: false
            };

            data.companies[currentCompany].deadlines.push(deadline);
            saveData();

            document.getElementById('deadline-form').reset();
            showNotification('Scadenza aggiunta con successo!');
            updateDashboard();
            updateDeadlinesTable();
            renderCalendar();
        }

        function deleteDeadline(deadlineId) {
            if (confirm('Sei sicura di voler eliminare questa scadenza?')) {
                data.companies[currentCompany].deadlines = data.companies[currentCompany].deadlines.filter(d => d.id !== deadlineId);
                saveData();
                showNotification('Scadenza eliminata!');
                updateDashboard();
                updateDeadlinesTable();
                renderCalendar();
            }
        }

        function updateDeadlinesTable() {
            const tbody = document.getElementById('deadlines-tbody');
            const deadlines = [...data.companies[currentCompany].deadlines].sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            );

            if (deadlines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #bdc3c7;">Nessuna scadenza inserita</td></tr>';
                return;
            }

            tbody.innerHTML = deadlines.map(deadline => `
                <tr ${deadline.completed ? 'style="opacity: 0.5; text-decoration: line-through;"' : 'class="clickable-item"'} onclick="openDetailModal('deadline', ${deadline.id}, ${currentCompany})" style="cursor: pointer;">
                    <td>${formatDate(deadline.date)}</td>
                    <td><strong>${deadline.type}</strong>${deadline.attachments && deadline.attachments.length > 0 ? ` <span style="color: #3498db; font-size: 0.8em;">üìé${deadline.attachments.length}</span>` : ''}</td>
                    <td><span style="background: var(--secondary-color); color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.8em;">${deadline.category}</span></td>
                    <td>${deadline.description || '-'}</td>
                    <td>
                        <button class="btn btn-small" onclick="event.stopPropagation(); openDetailModal('deadline', ${deadline.id}, ${currentCompany})" title="Vedi dettagli">üëÅÔ∏è</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteDeadline(${deadline.id})">Elimina</button>
                    </td>
                </tr>
            `).join('');
        }

        // GESTIONE SPESE
        function addExpense(event) {
            event.preventDefault();

            const expense = {
                id: Date.now(),
                description: document.getElementById('expense-description').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                date: document.getElementById('expense-date').value,
                category: document.getElementById('expense-category').value,
                notes: document.getElementById('expense-notes').value,
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].expenses.push(expense);
            saveData();

            document.getElementById('expense-form').reset();
            document.getElementById('expense-date').valueAsDate = new Date();
            showNotification('Spesa aggiunta con successo!');
            updateDashboard();
            updateExpenses();
        }

        function deleteExpense(expenseId) {
            if (confirm('Sei sicura di voler eliminare questa spesa?')) {
                data.companies[currentCompany].expenses = data.companies[currentCompany].expenses.filter(e => e.id !== expenseId);
                saveData();
                showNotification('Spesa eliminata!');
                updateDashboard();
                updateExpenses();
            }
        }

        function getCategoryIcon(category) {
            const icons = {
                'posta': 'üìÆ',
                'viaggio': '‚úàÔ∏è',
                'taxi': 'üöñ',
                'materiale': 'üìé',
                'cancelleria': '‚úèÔ∏è',
                'pranzo': 'üçΩÔ∏è',
                'parcheggio': 'üÖøÔ∏è',
                'bolli': 'üìÑ',
                'corriere': 'üì¶',
                'altro': 'üíº'
            };
            return icons[category] || 'üíº';
        }

        function getCategoryName(category) {
            const names = {
                'posta': 'Posta/Raccomandate',
                'viaggio': 'Viaggi',
                'taxi': 'Taxi',
                'materiale': 'Materiale Ufficio',
                'cancelleria': 'Cancelleria',
                'pranzo': 'Pranzi',
                'parcheggio': 'Parcheggi',
                'bolli': 'Marche da Bollo',
                'corriere': 'Corrieri',
                'altro': 'Altro'
            };
            return names[category] || 'Altro';
        }

        function updateExpenses() {
            const expenses = data.companies[currentCompany].expenses || [];

            // Ordina per data decrescente
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            // Statistiche
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];

            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + 1);

            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            let totalToday = 0;
            let totalWeek = 0;
            let totalMonth = 0;

            expenses.forEach(exp => {
                const expDate = new Date(exp.date);
                if (exp.date === todayStr) totalToday += exp.amount;
                if (expDate >= weekStart) totalWeek += exp.amount;
                if (expDate >= monthStart) totalMonth += exp.amount;
            });

            // Aggiorna statistiche nella sezione spese
            document.getElementById('total-expenses-today').textContent = totalToday.toFixed(2);
            document.getElementById('total-expenses-week').textContent = totalWeek.toFixed(2);
            document.getElementById('total-expenses-month-section').textContent = totalMonth.toFixed(2);
            document.getElementById('total-expenses-count').textContent = expenses.length;

            // Aggiorna dashboard card
            document.getElementById('total-expenses-month').textContent = totalMonth.toFixed(2);
            document.getElementById('expenses-count-month').textContent = expenses.length;

            // Ultimi 5 movimenti nella dashboard
            const recentContainer = document.getElementById('recent-expenses');
            if (sortedExpenses.length === 0) {
                recentContainer.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 0.9em;">Nessuna spesa registrata</div>';
            } else {
                recentContainer.innerHTML = sortedExpenses.slice(0, 5).map(exp => `
                    <div style="padding: 8px; margin: 5px 0; background: var(--light-bg); border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.85em; font-weight: 600;">
                                ${getCategoryIcon(exp.category)} ${exp.description}
                            </div>
                            <div style="font-size: 0.75em; color: #7f8c8d; margin-top: 2px;">
                                ${formatDate(exp.date)}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: var(--danger-color);">
                            ‚Ç¨ ${exp.amount.toFixed(2)}
                        </div>
                    </div>
                `).join('');
            }

            // Tabella completa
            const tbody = document.getElementById('expenses-tbody');
            if (sortedExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #bdc3c7;">Nessuna spesa registrata</td></tr>';
                return;
            }

            tbody.innerHTML = sortedExpenses.map(expense => `
                <tr class="clickable-item" onclick="openDetailModal('expense', ${expense.id}, ${currentCompany})" style="cursor: pointer;">
                    <td>${formatDate(expense.date)}</td>
                    <td><strong>${expense.description}</strong>${expense.attachments && expense.attachments.length > 0 ? ` <span style="color: #3498db; font-size: 0.8em;">üìé${expense.attachments.length}</span>` : ''}</td>
                    <td>
                        <span style="background: var(--secondary-color); color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.8em;">
                            ${getCategoryIcon(expense.category)} ${getCategoryName(expense.category)}
                        </span>
                    </td>
                    <td style="font-weight: bold; color: var(--danger-color);">‚Ç¨ ${expense.amount.toFixed(2)}</td>
                    <td style="font-size: 0.9em; color: #7f8c8d;">${expense.notes || '-'}</td>
                    <td>
                        <button class="btn btn-small" onclick="event.stopPropagation(); openDetailModal('expense', ${expense.id}, ${currentCompany})" title="Vedi dettagli">üëÅÔ∏è</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteExpense(${expense.id})">Elimina</button>
                    </td>
                </tr>
            `).join('');
        }

        // GESTIONE APPUNTAMENTI
        function addAppointment(event) {
            event.preventDefault();

            const appointment = {
                id: Date.now(),
                title: document.getElementById('appointment-title').value,
                date: document.getElementById('appointment-date').value,
                time: document.getElementById('appointment-time').value,
                duration: parseInt(document.getElementById('appointment-duration').value),
                location: document.getElementById('appointment-location').value,
                participants: document.getElementById('appointment-participants').value,
                notes: document.getElementById('appointment-notes').value,
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].appointments.push(appointment);
            saveData();

            document.getElementById('appointment-form').reset();
            document.getElementById('appointment-date').valueAsDate = new Date();
            showNotification('Appuntamento aggiunto con successo!');
            updateDashboard();
            updateAppointments();
            renderCalendar();
        }

        function deleteAppointment(appointmentId) {
            if (confirm('Sei sicura di voler eliminare questo appuntamento?')) {
                data.companies[currentCompany].appointments = data.companies[currentCompany].appointments.filter(a => a.id !== appointmentId);
                saveData();
                showNotification('Appuntamento eliminato!');
                updateDashboard();
                updateAppointments();
                renderCalendar();
            }
        }

        function updateAppointments() {
            const appointments = data.companies[currentCompany].appointments || [];

            // Ordina per data e ora
            const sortedAppointments = [...appointments].sort((a, b) => {
                const dateTimeA = new Date(a.date + 'T' + a.time);
                const dateTimeB = new Date(b.date + 'T' + b.time);
                return dateTimeA - dateTimeB;
            });

            // Prossimi appuntamenti nella dashboard
            const now = new Date();
            const upcomingAppointments = sortedAppointments.filter(apt => {
                const aptDateTime = new Date(apt.date + 'T' + apt.time);
                return aptDateTime >= now;
            }).slice(0, 5);

            const upcomingContainer = document.getElementById('upcoming-appointments');
            if (upcomingAppointments.length === 0) {
                upcomingContainer.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 0.9em;">Nessun appuntamento in programma</div>';
            } else {
                upcomingContainer.innerHTML = upcomingAppointments.map(apt => `
                    <div style="padding: 8px; margin: 5px 0; background: var(--light-bg); border-radius: 5px; border-left: 4px solid var(--secondary-color);">
                        <div style="font-size: 0.85em; font-weight: 600;">
                            üìÖ ${apt.title}
                        </div>
                        <div style="font-size: 0.75em; color: #7f8c8d; margin-top: 2px;">
                            ${formatDate(apt.date)} alle ${apt.time}
                        </div>
                        ${apt.location ? `<div style="font-size: 0.75em; color: #7f8c8d;">üìç ${apt.location}</div>` : ''}
                    </div>
                `).join('');
            }

            // Tabella completa
            const tbody = document.getElementById('appointments-tbody');
            if (sortedAppointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #bdc3c7;">Nessun appuntamento registrato</td></tr>';
                return;
            }

            tbody.innerHTML = sortedAppointments.map(apt => {
                const aptDateTime = new Date(apt.date + 'T' + apt.time);
                const isPast = aptDateTime < now;
                return `
                    <tr ${isPast ? 'style="opacity: 0.5; cursor: pointer;"' : 'class="clickable-item" style="cursor: pointer;"'} onclick="openDetailModal('appointment', ${apt.id}, ${currentCompany})">
                        <td>${formatDate(apt.date)}</td>
                        <td><strong>${apt.time}</strong></td>
                        <td><strong>${apt.title}</strong>${apt.attachments && apt.attachments.length > 0 ? ` <span style="color: #3498db; font-size: 0.8em;">üìé${apt.attachments.length}</span>` : ''}</td>
                        <td>${apt.location || '-'}</td>
                        <td style="font-size: 0.9em;">${apt.participants || '-'}</td>
                        <td>
                            <button class="btn btn-small" onclick="event.stopPropagation(); openDetailModal('appointment', ${apt.id}, ${currentCompany})" title="Vedi dettagli">üëÅÔ∏è</button>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteAppointment(${apt.id})">Elimina</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // RICONOSCIMENTO VOCALE
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'it-IT';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    processVoiceInput(transcript);
                };

                recognition.onerror = function(event) {
                    console.error('Errore riconoscimento vocale:', event.error);
                    showNotification('Errore nel riconoscimento vocale. Riprova.');
                    resetVoiceButtons();
                };

                recognition.onend = function() {
                    resetVoiceButtons();
                };
            } else {
                console.warn('Riconoscimento vocale non supportato in questo browser');
            }
        }

        let currentVoiceContext = null;

        function startVoiceInput(context) {
            if (!recognition) {
                alert('Il riconoscimento vocale non √® supportato dal tuo browser. Prova con Chrome, Edge o Safari.');
                return;
            }

            currentVoiceContext = context;
            const button = document.getElementById(`voice-btn-${context}`);
            button.style.background = 'var(--danger-color)';
            button.textContent = 'üî¥ Ascoltando...';

            recognition.start();
        }

        function processVoiceInput(transcript) {
            const text = transcript.toLowerCase();

            if (currentVoiceContext === 'task') {
                document.getElementById('task-title').value = transcript;
                showNotification('Attivit√† inserita: ' + transcript);
            } else if (currentVoiceContext === 'expense') {
                document.getElementById('expense-description').value = transcript;
                showNotification('Descrizione spesa inserita: ' + transcript);
            } else if (currentVoiceContext === 'appointment') {
                document.getElementById('appointment-title').value = transcript;

                // Precompila automaticamente data e ora se vuoti
                const dateField = document.getElementById('appointment-date');
                const timeField = document.getElementById('appointment-time');

                if (!dateField.value) {
                    dateField.valueAsDate = new Date();
                }

                if (!timeField.value) {
                    // Imposta ora corrente arrotondata alla mezz'ora successiva
                    const now = new Date();
                    now.setMinutes(now.getMinutes() + 30 - (now.getMinutes() % 30));
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    timeField.value = `${hours}:${minutes}`;
                }

                showNotification('‚úÖ Titolo inserito: ' + transcript + ' | Completa gli altri campi e clicca Aggiungi!');

                // Focus sul campo data per permettere eventuali modifiche
                document.getElementById('appointment-location').focus();
            }
        }

        function resetVoiceButtons() {
            ['task', 'expense', 'appointment'].forEach(context => {
                const button = document.getElementById(`voice-btn-${context}`);
                if (button) {
                    button.style.background = '';
                    button.textContent = 'üé§ Inserimento Vocale';
                }
            });
        }

        // GESTIONE CALENDARIO
        function renderCalendar() {
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];

            // Aggiorna titolo
            document.getElementById('calendar-month-year').textContent =
                `${monthNames[currentMonth]} ${currentYear}`;

            // Prima data del mese
            const firstDay = new Date(currentYear, currentMonth, 1);
            // Ultimo giorno del mese
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            // Giorno della settimana del primo giorno (0 = Domenica, 1 = Luned√¨, etc.)
            let startDay = firstDay.getDay();
            // Converti da Domenica=0 a Luned√¨=0
            startDay = startDay === 0 ? 6 : startDay - 1;

            const daysInMonth = lastDay.getDate();

            // Giorno precedente
            const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();

            const container = document.getElementById('calendar-container');
            container.innerHTML = '';

            // Headers giorni settimana
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                container.appendChild(header);
            });

            // Giorni del mese precedente
            for (let i = startDay - 1; i >= 0; i--) {
                const dayCell = createDayCell(prevMonthLastDay - i, true);
                container.appendChild(dayCell);
            }

            // Giorni del mese corrente
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate() &&
                    currentMonth === today.getMonth() &&
                    currentYear === today.getFullYear();
                const dayCell = createDayCell(day, false, isToday);
                container.appendChild(dayCell);
            }

            // Giorni del mese successivo
            const totalCells = container.children.length - 7; // sottrai gli header
            const remainingCells = 42 - totalCells; // 6 righe x 7 giorni
            for (let day = 1; day <= remainingCells; day++) {
                const dayCell = createDayCell(day, true);
                container.appendChild(dayCell);
            }
        }

        function createDayCell(dayNumber, isOtherMonth = false, isToday = false) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            if (isOtherMonth) cell.classList.add('other-month');
            if (isToday) cell.classList.add('today');

            const dayNum = document.createElement('div');
            dayNum.className = 'calendar-day-number';
            dayNum.textContent = dayNumber;
            cell.appendChild(dayNum);

            if (!isOtherMonth) {
                // Cerca attivit√† e scadenze per questo giorno
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                const events = getEventsForDate(dateStr);

                // Mostra max 3 eventi, poi "+X altri"
                const maxVisible = 3;
                events.slice(0, maxVisible).forEach(event => {
                    const eventDiv = document.createElement('div');
                    // Gestisci tutti i tipi di eventi
                    let eventClass = '';
                    if (event.type === 'deadline') {
                        eventClass = 'deadline';
                    } else if (event.type === 'appointment') {
                        eventClass = 'priority-appointment';
                    } else {
                        eventClass = 'priority-' + event.priority;
                    }
                    eventDiv.className = `calendar-event ${eventClass}`;
                    eventDiv.textContent = event.title;
                    eventDiv.title = event.title; // Tooltip
                    cell.appendChild(eventDiv);
                });

                if (events.length > maxVisible) {
                    const more = document.createElement('div');
                    more.className = 'calendar-more';
                    more.textContent = `+${events.length - maxVisible} altri`;
                    cell.appendChild(more);
                }
            }

            return cell;
        }

        function getEventsForDate(dateStr) {
            const events = [];
            const tasks = data.companies[currentCompany].tasks;
            const deadlines = data.companies[currentCompany].deadlines;
            const appointments = data.companies[currentCompany].appointments || [];

            // Aggiungi attivit√† con scadenza
            tasks.forEach(task => {
                if (task.deadline === dateStr && !task.completed) {
                    events.push({
                        type: 'task',
                        title: task.title,
                        priority: task.priority
                    });
                }
            });

            // Aggiungi scadenze
            deadlines.forEach(deadline => {
                if (deadline.date === dateStr && !deadline.completed) {
                    events.push({
                        type: 'deadline',
                        title: `${deadline.type}${deadline.description ? ': ' + deadline.description : ''}`,
                        priority: null
                    });
                }
            });

            // Aggiungi appuntamenti
            appointments.forEach(appointment => {
                if (appointment.date === dateStr) {
                    events.push({
                        type: 'appointment',
                        title: `${appointment.time} - ${appointment.title}`,
                        priority: 'appointment'
                    });
                }
            });

            // Ordina per priorit√† (A+ prima, poi appointment)
            const priorityOrder = { 'aplus': 0, 'a': 1, 'appointment': 2, 'b': 3, 'c': 4, null: 5 };
            events.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            return events;
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        // UPDATE DASHBOARD
        function updateDashboard() {
            const tasks = data.companies[currentCompany].tasks;
            const deadlines = data.companies[currentCompany].deadlines;

            // Statistiche
            document.getElementById('stat-urgent').textContent = tasks.filter(t => t.priority === 'aplus' && !t.completed).length;
            document.getElementById('stat-important').textContent = tasks.filter(t => t.priority === 'a' && !t.completed).length;

            const today = new Date();
            const oneWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            document.getElementById('stat-deadlines').textContent = deadlines.filter(d => {
                const deadlineDate = new Date(d.date);
                return deadlineDate >= today && deadlineDate <= oneWeek && !d.completed;
            }).length;

            const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('stat-completed').textContent = tasks.filter(t => {
                return t.completed && new Date(t.createdAt) >= oneWeekAgo;
            }).length;

            // Tasks per categoria
            updateCategoryTasks('urgent', 'urgent-tasks');
            updateCategoryTasks('important', 'important-tasks');
            updateCategoryTasks('fiscal', 'fiscal-deadlines');
            updateCategoryTasks('hr', 'hr-deadlines');
            updateCategoryTasks('critical', 'critical-issues');
            updateCategoryTasks('decisions', 'pending-decisions');
        }

        function updateCategoryTasks(category, elementId) {
            const container = document.getElementById(elementId);
            const tasks = data.companies[currentCompany].tasks.filter(t =>
                t.category === category && !t.completed
            );

            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 0.9em;">Nessuna attivit√†</div>';
                return;
            }

            container.innerHTML = tasks.slice(0, 3).map(task => `
                <div class="task-item priority-${task.priority}">
                    <span class="priority-badge ${task.priority}">${task.priority.toUpperCase()}</span>
                    <div class="task-content">
                        <strong>${task.title}</strong>
                        ${task.deadline ? `<div style="font-size: 0.8em; margin-top: 5px;">üìÖ ${formatDate(task.deadline)}</div>` : ''}
                    </div>
                </div>
            `).join('');

            if (tasks.length > 3) {
                container.innerHTML += `<div style="text-align: center; margin-top: 10px; color: var(--secondary-color); font-size: 0.9em;">+${tasks.length - 3} altre</div>`;
            }
        }

        // RENDER SOP
        function renderSOP() {
            const sopList = document.getElementById('sop-list');
            sopList.innerHTML = sopTemplates.map((sop, index) => {
                const stats = getSOPStats(index);
                return `
                    <li class="sop-item" id="sop-item-${index}">
                        <div class="sop-header-toggle" style="cursor: pointer;" onclick="toggleSOP(${index})">
                            <h4>${sop.title}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9em;">${sop.description}</p>
                            <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 0.85em; color: var(--secondary-color);">
                                <span>üìä Esecuzioni: ${stats.totalExecutions}</span>
                                <span>üìÖ Ultima: ${stats.lastExecution || 'Mai'}</span>
                                <span>‚è±Ô∏è Media: ${stats.avgTime || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="sop-content">
                            <div class="sop-dashboard">
                                <!-- Tabs -->
                                <div class="sop-tabs">
                                    <button class="sop-tab active" data-sop="${index}" data-tab="checklist">
                                        ‚úÖ Checklist
                                    </button>
                                    <button class="sop-tab" data-sop="${index}" data-tab="stats">
                                        üìä Statistiche
                                    </button>
                                    <button class="sop-tab" data-sop="${index}" data-tab="history">
                                        üìú Storico
                                    </button>
                                </div>

                                <!-- Tab: Checklist -->
                                <div id="sop-tab-${index}-checklist" class="sop-tab-content active">
                                    <h4 style="margin-bottom: 15px;">Esegui Procedura</h4>

                                    <!-- Progress Bar -->
                                    <div class="sop-progress-bar">
                                        <div class="sop-progress-fill" id="sop-progress-${index}" style="width: 0%">
                                            0%
                                        </div>
                                    </div>

                                    <!-- Checklist Interattiva -->
                                    <ul class="sop-checklist" id="sop-checklist-${index}">
                                        ${sop.steps.map((step, stepIndex) => `
                                            <li class="sop-checklist-item" id="sop-step-${index}-${stepIndex}">
                                                <input
                                                    type="checkbox"
                                                    id="check-${index}-${stepIndex}"
                                                    onchange="updateSOPProgress(${index})"
                                                />
                                                <label for="check-${index}-${stepIndex}" style="flex: 1; cursor: pointer;">
                                                    ${step}
                                                </label>
                                            </li>
                                        `).join('')}
                                    </ul>

                                    <!-- Note -->
                                    <div style="margin-top: 20px;">
                                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">
                                            Note (opzionale):
                                        </label>
                                        <textarea
                                            class="sop-notes"
                                            id="sop-notes-${index}"
                                            placeholder="Aggiungi eventuali note, problemi riscontrati, miglioramenti suggeriti..."
                                        ></textarea>
                                    </div>

                                    <!-- Bottone Completa -->
                                    <button class="sop-execute-btn" onclick="completeSOPExecution(${index})">
                                        ‚úÖ Completa Procedura
                                    </button>
                                </div>

                                <!-- Tab: Statistiche -->
                                <div id="sop-tab-${index}-stats" class="sop-tab-content">
                                    <h4 style="margin-bottom: 15px;">Statistiche di Esecuzione</h4>
                                    <div class="sop-stats">
                                        <div class="sop-stat-box">
                                            <div class="sop-stat-number">${stats.totalExecutions}</div>
                                            <div class="sop-stat-label">Totale Esecuzioni</div>
                                        </div>
                                        <div class="sop-stat-box">
                                            <div class="sop-stat-number">${stats.thisWeek}</div>
                                            <div class="sop-stat-label">Questa Settimana</div>
                                        </div>
                                        <div class="sop-stat-box">
                                            <div class="sop-stat-number">${stats.thisMonth}</div>
                                            <div class="sop-stat-label">Questo Mese</div>
                                        </div>
                                        <div class="sop-stat-box" style="border-left-color: var(--success-color);">
                                            <div class="sop-stat-number">${stats.avgTime || 'N/A'}</div>
                                            <div class="sop-stat-label">Tempo Medio</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                                        <p style="margin: 5px 0;"><strong>Prima Esecuzione:</strong> ${stats.firstExecution || 'N/A'}</p>
                                        <p style="margin: 5px 0;"><strong>Ultima Esecuzione:</strong> ${stats.lastExecution || 'N/A'}</p>
                                        <p style="margin: 5px 0;"><strong>Frequenza Media:</strong> ${stats.frequency || 'N/A'}</p>
                                    </div>
                                </div>

                                <!-- Tab: Storico -->
                                <div id="sop-tab-${index}-history" class="sop-tab-content">
                                    <h4 style="margin-bottom: 15px;">Storico Esecuzioni</h4>
                                    <div class="sop-history" id="sop-history-${index}">
                                        ${renderSOPHistory(index)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');

            // Aggiungi event listeners per i tab SOP
            document.querySelectorAll('.sop-tab').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sopIndex = parseInt(this.getAttribute('data-sop'));
                    const tabName = this.getAttribute('data-tab');

                    // Nascondi tutti i tab di questa SOP
                    document.querySelectorAll(`#sop-item-${sopIndex} .sop-tab-content`).forEach(content => {
                        content.classList.remove('active');
                    });
                    document.querySelectorAll(`#sop-item-${sopIndex} .sop-tab`).forEach(tab => {
                        tab.classList.remove('active');
                    });

                    // Mostra il tab selezionato
                    document.getElementById(`sop-tab-${sopIndex}-${tabName}`).classList.add('active');
                    this.classList.add('active');

                    // Refresh dello storico se necessario
                    if (tabName === 'history') {
                        document.getElementById(`sop-history-${sopIndex}`).innerHTML = renderSOPHistory(sopIndex);
                    }
                });
            });
        }

        function toggleSOP(index) {
            const sopItem = document.getElementById(`sop-item-${index}`);
            const wasExpanded = sopItem.classList.contains('expanded');

            // Chiudi tutte le SOP
            document.querySelectorAll('.sop-item').forEach(item => {
                item.classList.remove('expanded');
            });

            // Apri quella selezionata (se non era gi√† aperta)
            if (!wasExpanded) {
                sopItem.classList.add('expanded');
                resetSOPChecklist(index);
            }
        }

        function showSOPTab(event, sopIndex, tabName) {
            // Ferma la propagazione per evitare che chiuda la SOP
            event.stopPropagation();

            // Nascondi tutti i tab di questa SOP
            document.querySelectorAll(`#sop-item-${sopIndex} .sop-tab-content`).forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll(`#sop-item-${sopIndex} .sop-tab`).forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostra il tab selezionato
            document.getElementById(`sop-tab-${sopIndex}-${tabName}`).classList.add('active');
            event.target.classList.add('active');

            // Refresh dello storico se necessario
            if (tabName === 'history') {
                document.getElementById(`sop-history-${sopIndex}`).innerHTML = renderSOPHistory(sopIndex);
            } else if (tabName === 'stats') {
                renderSOP(); // Aggiorna le statistiche
            }
        }

        function resetSOPChecklist(sopIndex) {
            currentSOPChecklist[sopIndex] = {};
            const checkboxes = document.querySelectorAll(`#sop-checklist-${sopIndex} input[type="checkbox"]`);
            checkboxes.forEach(cb => cb.checked = false);
            document.querySelectorAll(`#sop-checklist-${sopIndex} .sop-checklist-item`).forEach(item => {
                item.classList.remove('completed');
            });
            updateSOPProgress(sopIndex);
        }

        function updateSOPProgress(sopIndex) {
            const sop = sopTemplates[sopIndex];
            const totalSteps = sop.steps.length;
            const checkboxes = document.querySelectorAll(`#sop-checklist-${sopIndex} input[type="checkbox"]`);
            let completedSteps = 0;

            checkboxes.forEach((cb, index) => {
                const listItem = document.getElementById(`sop-step-${sopIndex}-${index}`);
                if (cb.checked) {
                    completedSteps++;
                    listItem.classList.add('completed');
                } else {
                    listItem.classList.remove('completed');
                }
            });

            const percentage = Math.round((completedSteps / totalSteps) * 100);
            const progressBar = document.getElementById(`sop-progress-${sopIndex}`);
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
        }

        function completeSOPExecution(sopIndex) {
            const sop = sopTemplates[sopIndex];
            const checkboxes = document.querySelectorAll(`#sop-checklist-${sopIndex} input[type="checkbox"]`);
            const totalSteps = sop.steps.length;
            let completedSteps = 0;

            checkboxes.forEach(cb => {
                if (cb.checked) completedSteps++;
            });

            if (completedSteps < totalSteps) {
                if (!confirm(`Hai completato solo ${completedSteps} su ${totalSteps} passaggi. Vuoi comunque completare la procedura?`)) {
                    return;
                }
            }

            const notes = document.getElementById(`sop-notes-${sopIndex}`).value;
            const execution = {
                id: Date.now(),
                sopIndex: sopIndex,
                sopTitle: sop.title,
                date: new Date().toISOString(),
                completedSteps: completedSteps,
                totalSteps: totalSteps,
                percentage: Math.round((completedSteps / totalSteps) * 100),
                notes: notes,
                duration: 'N/A' // Per ora non tracciamo il tempo reale
            };

            data.companies[currentCompany].sopExecutions.push(execution);
            saveData();

            showNotification('‚úÖ Procedura completata con successo!');

            // Reset checklist
            resetSOPChecklist(sopIndex);
            document.getElementById(`sop-notes-${sopIndex}`).value = '';

            // Aggiorna statistiche
            renderSOP();
        }

        function getSOPStats(sopIndex) {
            const executions = data.companies[currentCompany].sopExecutions.filter(e => e.sopIndex === sopIndex);

            if (executions.length === 0) {
                return {
                    totalExecutions: 0,
                    thisWeek: 0,
                    thisMonth: 0,
                    lastExecution: null,
                    firstExecution: null,
                    avgTime: null,
                    frequency: null
                };
            }

            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            const thisWeek = executions.filter(e => new Date(e.date) >= weekAgo).length;
            const thisMonth = executions.filter(e => new Date(e.date) >= monthAgo).length;

            const sorted = [...executions].sort((a, b) => new Date(b.date) - new Date(a.date));
            const lastExecution = formatDate(sorted[0].date.split('T')[0]);
            const firstExecution = formatDate(sorted[sorted.length - 1].date.split('T')[0]);

            // Calcola frequenza media (giorni tra esecuzioni)
            let frequency = 'N/A';
            if (executions.length > 1) {
                const first = new Date(sorted[sorted.length - 1].date);
                const last = new Date(sorted[0].date);
                const daysDiff = (last - first) / (1000 * 60 * 60 * 24);
                const avgDays = Math.round(daysDiff / (executions.length - 1));
                frequency = `Ogni ${avgDays} giorni`;
            }

            return {
                totalExecutions: executions.length,
                thisWeek,
                thisMonth,
                lastExecution,
                firstExecution,
                avgTime: 'N/A', // Per ora
                frequency
            };
        }

        function renderSOPHistory(sopIndex) {
            const executions = data.companies[currentCompany].sopExecutions
                .filter(e => e.sopIndex === sopIndex)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (executions.length === 0) {
                return '<div class="empty-state" style="padding: 40px; text-align: center; color: #bdc3c7;">Nessuna esecuzione registrata</div>';
            }

            return executions.map(exec => {
                const date = new Date(exec.date);
                const dateStr = formatDate(date.toISOString().split('T')[0]);
                const timeStr = date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="sop-history-item">
                        <div>
                            <div class="sop-history-date">üìÖ ${dateStr} alle ${timeStr}</div>
                            <div style="margin-top: 5px; font-size: 0.9em;">
                                <span style="color: var(--success-color); font-weight: 600;">
                                    ${exec.completedSteps}/${exec.totalSteps} passaggi (${exec.percentage}%)
                                </span>
                                ${exec.notes ? `<br><em style="color: #7f8c8d;">"${exec.notes}"</em>` : ''}
                            </div>
                        </div>
                        <button class="delete-btn" onclick="deleteSOPExecution(${exec.id})">Elimina</button>
                    </div>
                `;
            }).join('');
        }

        function deleteSOPExecution(executionId) {
            if (confirm('Sei sicura di voler eliminare questa esecuzione?')) {
                data.companies[currentCompany].sopExecutions =
                    data.companies[currentCompany].sopExecutions.filter(e => e.id !== executionId);
                saveData();
                showNotification('Esecuzione eliminata!');
                renderSOP();
            }
        }

        // REPORT
        function generateReport() {
            const reportContent = document.getElementById('report-content');
            reportContent.style.display = 'block';

            // Data settimana
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + 1);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            document.getElementById('report-week').textContent =
                `${formatDate(weekStart.toISOString().split('T')[0])} - ${formatDate(weekEnd.toISOString().split('T')[0])}`;

            // Completate
            const completedTasks = data.companies[currentCompany].tasks.filter(t => t.completed);
            document.getElementById('report-done').innerHTML = completedTasks.length > 0
                ? '<ul>' + completedTasks.map(t => `<li>${t.title}</li>`).join('') + '</ul>'
                : '<p>Nessuna attivit√† completata questa settimana.</p>';

            // In corso
            const ongoingTasks = data.companies[currentCompany].tasks.filter(t => !t.completed && (t.priority === 'a' || t.priority === 'aplus'));
            document.getElementById('report-ongoing').innerHTML = ongoingTasks.length > 0
                ? '<ul>' + ongoingTasks.map(t => `<li>${t.title} (${t.priority.toUpperCase()})</li>`).join('') + '</ul>'
                : '<p>Nessuna attivit√† prioritaria in corso.</p>';

            // Decisioni
            const decisions = data.companies[currentCompany].tasks.filter(t => t.category === 'decisions' && !t.completed);
            document.getElementById('report-decisions').innerHTML = decisions.length > 0
                ? '<ul>' + decisions.map(t => `<li>${t.title}</li>`).join('') + '</ul>'
                : '<p>Nessuna decisione in attesa.</p>';

            // Rischi
            const risks = data.companies[currentCompany].tasks.filter(t => t.category === 'critical' && !t.completed);
            document.getElementById('report-risks').innerHTML = risks.length > 0
                ? '<ul>' + risks.map(t => `<li>${t.title}</li>`).join('') + '</ul>'
                : '<p>Nessun rischio segnalato.</p>';

            // Scadenze
            const upcomingDeadlines = data.companies[currentCompany].deadlines.filter(d => {
                const deadlineDate = new Date(d.date);
                const twoWeeks = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
                return deadlineDate >= today && deadlineDate <= twoWeeks && !d.completed;
            });
            document.getElementById('report-deadlines').innerHTML = upcomingDeadlines.length > 0
                ? '<ul>' + upcomingDeadlines.map(d => `<li>${d.type} - ${formatDate(d.date)} (${d.category})</li>`).join('') + '</ul>'
                : '<p>Nessuna scadenza imminente.</p>';

            // Spese della settimana
            const weekExpenses = (data.companies[currentCompany].expenses || []).filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= weekStart && expDate <= weekEnd;
            });

            let totalWeekExpenses = 0;
            weekExpenses.forEach(exp => totalWeekExpenses += exp.amount);

            if (weekExpenses.length > 0) {
                const expensesByCategory = {};
                weekExpenses.forEach(exp => {
                    if (!expensesByCategory[exp.category]) {
                        expensesByCategory[exp.category] = 0;
                    }
                    expensesByCategory[exp.category] += exp.amount;
                });

                let expensesHTML = '<ul>';
                Object.keys(expensesByCategory).forEach(cat => {
                    expensesHTML += `<li>${getCategoryIcon(cat)} ${getCategoryName(cat)}: ‚Ç¨ ${expensesByCategory[cat].toFixed(2)}</li>`;
                });
                expensesHTML += '</ul>';
                expensesHTML += `<p style="margin-top: 10px; font-weight: bold;">Totale spese: ‚Ç¨ ${totalWeekExpenses.toFixed(2)}</p>`;
                document.getElementById('report-expenses').innerHTML = expensesHTML;
            } else {
                document.getElementById('report-expenses').innerHTML = '<p>Nessuna spesa registrata questa settimana.</p>';
            }

            showNotification('Report generato con successo!');
        }

        function exportReport() {
            window.print();
        }

        // SETTINGS
        function saveCompanyNames(event) {
            event.preventDefault();

            for (let i = 1; i <= 4; i++) {
                const name = document.getElementById(`company-${i}-name`).value;
                data.companies[i].name = name;

                const buttons = document.querySelectorAll(`.company-btn.azienda-${i}`);
                buttons.forEach(btn => btn.textContent = name);
            }

            saveData();
            showNotification('Nomi aziende salvati con successo!');
        }

        function loadCompanyNames() {
            for (let i = 1; i <= 4; i++) {
                const name = data.companies[i].name;
                document.getElementById(`company-${i}-name`).value = name;

                const buttons = document.querySelectorAll(`.company-btn.azienda-${i}`);
                buttons.forEach(btn => btn.textContent = name);
            }
        }

        // GESTIONE DATI
        function saveData() {
            localStorage.setItem('gestione-direzionale-data', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('gestione-direzionale-data');
            if (saved) {
                data = JSON.parse(saved);
                // Migrazione automatica: aggiungi campi mancanti
                for (let i = 1; i <= 4; i++) {
                    if (!data.companies[i].expenses) {
                        data.companies[i].expenses = [];
                    }
                    if (!data.companies[i].appointments) {
                        data.companies[i].appointments = [];
                    }
                }

                // Migrazione nuovi campi globali
                if (!data.templates) {
                    data.templates = [];
                }
                if (!data.auditLog) {
                    data.auditLog = [];
                }
                if (!data.backups) {
                    data.backups = [];
                }
                if (!data.settings) {
                    data.settings = {
                        autoBackup: true,
                        backupInterval: 30,
                        notificationsEnabled: false
                    };
                }

                // Salva migrazione
                saveData();
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-gestione-direzionale-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('Dati esportati con successo!');
        }

        function importData() {
            document.getElementById('import-file').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        data = JSON.parse(e.target.result);
                        saveData();
                        location.reload();
                    } catch (error) {
                        alert('Errore nel file importato!');
                    }
                };
                reader.readAsText(file);
            }
        }

        function clearAllData() {
            if (confirm('ATTENZIONE: Questa operazione canceller√† tutti i dati. Sei sicura?')) {
                if (confirm('Sei VERAMENTE sicura? Questa azione √® irreversibile!')) {
                    localStorage.removeItem('gestione-direzionale-data');
                    location.reload();
                }
            }
        }

        // UTILITY
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ===== NUOVE FUNZIONALIT√Ä =====

        // RICERCA GLOBALE
        function toggleGlobalSearch() {
            const searchContainer = document.getElementById('global-search');
            searchContainer.classList.toggle('active');
            if (searchContainer.classList.contains('active')) {
                document.getElementById('global-search-input').focus();
            } else {
                document.getElementById('global-search-input').value = '';
                document.getElementById('global-search-results').innerHTML = '<p style="text-align: center; padding: 40px; color: #7f8c8d;">Inizia a digitare per cercare in tutte le sezioni...</p>';
            }
        }

        function performGlobalSearch(event) {
            if (event.key === 'Escape') {
                toggleGlobalSearch();
                return;
            }

            const query = event.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('global-search-results');

            if (query.length < 2) {
                resultsContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #7f8c8d;">Digita almeno 2 caratteri...</p>';
                return;
            }

            const results = [];

            // Cerca in tutte le aziende
            for (let companyId = 1; companyId <= 4; companyId++) {
                const company = data.companies[companyId];
                const companyName = company.name;

                // Cerca nei task
                company.tasks.forEach(task => {
                    if (task.title.toLowerCase().includes(query) || task.description?.toLowerCase().includes(query)) {
                        results.push({
                            type: 'task',
                            title: task.title,
                            company: companyName,
                            section: 'Attivit√†',
                            meta: `Priorit√†: ${task.priority.toUpperCase()} | ${task.category}`
                        });
                    }
                });

                // Cerca nelle scadenze
                company.deadlines.forEach(deadline => {
                    if (deadline.type.toLowerCase().includes(query) || deadline.description?.toLowerCase().includes(query)) {
                        results.push({
                            type: 'deadline',
                            title: deadline.type,
                            company: companyName,
                            section: 'Scadenze',
                            meta: `Categoria: ${deadline.category} | Data: ${formatDate(deadline.date)}`
                        });
                    }
                });

                // Cerca nei contatti
                company.contacts.forEach(contact => {
                    if (contact.name.toLowerCase().includes(query) || contact.company?.toLowerCase().includes(query) || contact.email?.toLowerCase().includes(query)) {
                        results.push({
                            type: 'contact',
                            title: contact.name,
                            company: companyName,
                            section: 'Contatti',
                            meta: `${contact.company || ''} | ${contact.category}`
                        });
                    }
                });

                // Cerca negli appuntamenti
                company.appointments.forEach(apt => {
                    if (apt.title.toLowerCase().includes(query) || apt.location?.toLowerCase().includes(query)) {
                        results.push({
                            type: 'appointment',
                            title: apt.title,
                            company: companyName,
                            section: 'Appuntamenti',
                            meta: `${apt.date} ${apt.time} | ${apt.location || ''}`
                        });
                    }
                });
            }

            // Mostra risultati
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #7f8c8d;">Nessun risultato trovato</p>';
            } else {
                resultsContainer.innerHTML = results.map(result => `
                    <div class="search-result-item">
                        <div class="search-result-title">${highlightText(result.title, query)}</div>
                        <div class="search-result-meta">
                            ${result.company} ‚Ä¢ ${result.section} ‚Ä¢ ${result.meta}
                        </div>
                    </div>
                `).join('');
            }
        }

        function highlightText(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Shortcut Ctrl+K per ricerca
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                toggleGlobalSearch();
            }
        });

        // DASHBOARD CONSOLIDATA
        function updateConsolidatedDashboard() {
            const statsContainer = document.getElementById('consolidated-stats');
            const chartContainer = document.getElementById('company-comparison-chart');
            const alertsContainer = document.getElementById('global-alerts');

            let html = '';
            let chartData = [];
            let alerts = [];

            for (let i = 1; i <= 4; i++) {
                const company = data.companies[i];
                const tasks = company.tasks || [];
                const deadlines = company.deadlines || [];

                const urgentCount = tasks.filter(t => t.priority === 'aplus' && !t.completed).length;
                const importantCount = tasks.filter(t => t.priority === 'a' && !t.completed).length;
                const totalTasks = tasks.filter(t => !t.completed).length;
                const completedThisWeek = tasks.filter(t => {
                    if (!t.completed) return false;
                    const taskDate = new Date(t.createdAt);
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    return taskDate >= weekAgo;
                }).length;

                const imminentDeadlines = deadlines.filter(d => {
                    const deadlineDate = new Date(d.date);
                    const today = new Date();
                    const diff = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
                    return diff <= 7 && diff >= 0 && !d.completed;
                }).length;

                html += `
                    <div class="company-stat-card azienda-${i}">
                        <div class="company-stat-header">${company.name}</div>
                        <div class="company-stat-grid">
                            <div class="mini-stat">
                                <div class="mini-stat-number" style="color: #e74c3c;">${urgentCount}</div>
                                <div class="mini-stat-label">Urgenti</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-number" style="color: #f39c12;">${importantCount}</div>
                                <div class="mini-stat-label">Importanti</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-number">${totalTasks}</div>
                                <div class="mini-stat-label">Totale Attive</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-number" style="color: #2ecc71;">${completedThisWeek}</div>
                                <div class="mini-stat-label">Completate</div>
                            </div>
                        </div>
                    </div>
                `;

                chartData.push({
                    label: company.name,
                    value: totalTasks
                });

                // Genera alert
                if (urgentCount > 0) {
                    alerts.push(`üö® <strong>${company.name}</strong>: ${urgentCount} attivit√† urgenti in sospeso`);
                }
                if (imminentDeadlines > 0) {
                    alerts.push(`‚è∞ <strong>${company.name}</strong>: ${imminentDeadlines} scadenze nei prossimi 7 giorni`);
                }
            }

            statsContainer.innerHTML = html;

            // Genera grafico a barre
            const maxValue = Math.max(...chartData.map(d => d.value), 1);
            chartContainer.innerHTML = chartData.map(item => {
                const height = (item.value / maxValue) * 100;
                return `
                    <div class="bar-item">
                        <div class="bar" style="height: ${height}%">
                            <div class="bar-value">${item.value}</div>
                        </div>
                        <div class="bar-label">${item.label}</div>
                    </div>
                `;
            }).join('');

            // Mostra alert
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<p style="padding: 20px; color: #2ecc71;">‚úì Tutto sotto controllo! Nessun alert critico.</p>';
            } else {
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div style="padding: 12px; margin: 8px 0; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 6px;">
                        ${alert}
                    </div>
                `).join('');
            }
        }

        // ANALYTICS
        function updateAnalytics() {
            const period = document.getElementById('analytics-period').value;
            const companyFilter = document.getElementById('analytics-company').value;

            let allTasks = [];
            let allExpenses = [];

            if (companyFilter === 'all') {
                for (let i = 1; i <= 4; i++) {
                    allTasks = allTasks.concat(data.companies[i].tasks || []);
                    allExpenses = allExpenses.concat(data.companies[i].expenses || []);
                }
            } else {
                const companyId = parseInt(companyFilter);
                allTasks = data.companies[companyId].tasks || [];
                allExpenses = data.companies[companyId].expenses || [];
            }

            // Filtra per periodo
            const now = new Date();
            const filterDate = new Date();
            if (period === 'week') filterDate.setDate(now.getDate() - 7);
            else if (period === 'month') filterDate.setMonth(now.getMonth() - 1);
            else if (period === 'quarter') filterDate.setMonth(now.getMonth() - 3);
            else if (period === 'year') filterDate.setFullYear(now.getFullYear() - 1);

            const filteredTasks = allTasks.filter(t => new Date(t.createdAt) >= filterDate);
            const filteredExpenses = allExpenses.filter(e => new Date(e.date) >= filterDate);

            // Statistiche
            document.getElementById('analytics-total-tasks').textContent = filteredTasks.length;

            const completed = filteredTasks.filter(t => t.completed).length;
            const completionRate = filteredTasks.length > 0 ? Math.round((completed / filteredTasks.length) * 100) : 0;
            document.getElementById('analytics-completed-rate').textContent = completionRate + '%';

            // Tempo medio (mock - sarebbe necessario tracciare data completamento)
            document.getElementById('analytics-avg-time').textContent = '3.2';

            const overdue = filteredTasks.filter(t => {
                if (t.completed || !t.deadline) return false;
                return new Date(t.deadline) < now;
            }).length;
            document.getElementById('analytics-overdue').textContent = overdue;

            // Grafico priorit√†
            const priorityChart = document.getElementById('priority-chart');
            const priorities = { aplus: 0, a: 0, b: 0, c: 0 };
            filteredTasks.forEach(t => {
                if (!t.completed) priorities[t.priority]++;
            });

            const priorityData = [
                { label: 'A+', value: priorities.aplus },
                { label: 'A', value: priorities.a },
                { label: 'B', value: priorities.b },
                { label: 'C', value: priorities.c }
            ];

            renderBarChart(priorityChart, priorityData);

            // Grafico spese
            const expensesChart = document.getElementById('expenses-chart');
            const expensesByCategory = {};
            filteredExpenses.forEach(exp => {
                const cat = exp.category || 'altro';
                expensesByCategory[cat] = (expensesByCategory[cat] || 0) + exp.amount;
            });

            const expensesData = Object.keys(expensesByCategory).map(cat => ({
                label: cat.charAt(0).toUpperCase() + cat.slice(1),
                value: Math.round(expensesByCategory[cat])
            }));

            renderBarChart(expensesChart, expensesData);

            // Trend settimanale
            const weeklyTrend = document.getElementById('weekly-trend-chart');
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dayLabel = d.toLocaleDateString('it-IT', { weekday: 'short' });
                const dayStr = d.toISOString().split('T')[0];

                const completedToday = allTasks.filter(t => {
                    if (!t.completed || !t.completedAt) return false;
                    return t.completedAt?.startsWith(dayStr);
                }).length;

                last7Days.push({ label: dayLabel, value: completedToday });
            }

            renderBarChart(weeklyTrend, last7Days);
        }

        function renderBarChart(container, data) {
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Nessun dato disponibile</p>';
                return;
            }

            const maxValue = Math.max(...data.map(d => d.value), 1);
            container.innerHTML = data.map(item => {
                const height = (item.value / maxValue) * 100;
                return `
                    <div class="bar-item">
                        <div class="bar" style="height: ${height}%">
                            <div class="bar-value">${item.value}</div>
                        </div>
                        <div class="bar-label">${item.label}</div>
                    </div>
                `;
            }).join('');
        }

        // TEMPLATE RICORRENTI
        function addTemplate(event) {
            event.preventDefault();

            const template = {
                id: Date.now(),
                title: document.getElementById('template-title').value,
                description: document.getElementById('template-description').value,
                category: document.getElementById('template-category').value,
                priority: document.getElementById('template-priority').value,
                frequency: document.getElementById('template-frequency').value,
                createdAt: new Date().toISOString()
            };

            data.templates.push(template);
            saveData();
            logAudit('create', `Template creato: ${template.title}`, 'all');

            document.getElementById('template-form').reset();
            showNotification('Template creato con successo!');
            renderTemplates();
        }

        function renderTemplates() {
            const container = document.getElementById('templates-list');

            if (data.templates.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nessun template creato. Crea il tuo primo template ricorrente!</p></div>';
                return;
            }

            container.innerHTML = data.templates.map(template => {
                const frequencyBadgeClass = template.frequency === 'weekly' ? 'weekly' : template.frequency === 'monthly' ? 'monthly' : template.frequency === 'quarterly' ? 'quarterly' : '';

                return `
                    <div class="template-card" onclick="applyTemplate(${template.id})">
                        <div>
                            <span class="template-badge ${frequencyBadgeClass}">${template.frequency}</span>
                            <strong style="font-size: 1.1em;">${template.title}</strong>
                            <p style="color: #7f8c8d; margin-top: 5px; font-size: 0.9em;">${template.description || ''}</p>
                            <div style="margin-top: 8px;">
                                <span class="priority-badge ${template.priority}">${template.priority.toUpperCase()}</span>
                                <span style="margin-left: 10px; font-size: 0.85em; color: #7f8c8d;">${template.category}</span>
                            </div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteTemplate(${template.id})">Elimina</button>
                    </div>
                `;
            }).join('');
        }

        function applyTemplate(templateId) {
            const template = data.templates.find(t => t.id === templateId);
            if (!template) return;

            const task = {
                id: Date.now(),
                title: template.title,
                description: template.description,
                category: template.category,
                priority: template.priority,
                deadline: '',
                completed: false,
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].tasks.push(task);
            saveData();
            logAudit('create', `Attivit√† creata da template: ${task.title}`, currentCompany);

            showNotification('Attivit√† creata da template!');
            updateAllTasks();
            updateDashboard();
            showSection('tasks');
        }

        function deleteTemplate(templateId) {
            const index = data.templates.findIndex(t => t.id === templateId);
            if (index !== -1) {
                const template = data.templates[index];
                data.templates.splice(index, 1);
                saveData();
                logAudit('delete', `Template eliminato: ${template.title}`, 'all');
                showNotification('Template eliminato');
                renderTemplates();
            }
        }

        // AUDIT LOG
        function logAudit(action, description, company) {
            const entry = {
                id: Date.now(),
                action: action, // create, update, delete
                description: description,
                company: company,
                timestamp: new Date().toISOString()
            };

            data.auditLog.unshift(entry); // Aggiungi all'inizio
            if (data.auditLog.length > 1000) {
                data.auditLog = data.auditLog.slice(0, 1000); // Mantieni max 1000 entry
            }

            saveData();
            if (document.querySelector('#audit-log.active')) {
                renderAuditLog();
            }
        }

        function renderAuditLog() {
            const container = document.getElementById('audit-log-container');
            const filterType = document.getElementById('audit-filter-type').value;
            const filterCompany = document.getElementById('audit-filter-company').value;

            let filtered = data.auditLog;

            if (filterType !== 'all') {
                filtered = filtered.filter(entry => entry.action === filterType);
            }

            if (filterCompany !== 'all') {
                filtered = filtered.filter(entry => entry.company == filterCompany || entry.company === 'all');
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nessuna modifica registrata.</p></div>';
                return;
            }

            container.innerHTML = filtered.map(entry => {
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleString('it-IT');
                const companyName = entry.company === 'all' ? 'Tutte' : data.companies[entry.company]?.name || entry.company;

                return `
                    <div class="audit-log-item action-${entry.action}">
                        <div class="audit-log-time">${timeStr} - ${companyName}</div>
                        <div class="audit-log-action">${entry.description}</div>
                    </div>
                `;
            }).join('');
        }

        function filterAuditLog() {
            renderAuditLog();
        }

        function clearAuditLog() {
            if (confirm('Vuoi davvero eliminare tutto lo storico delle modifiche?')) {
                data.auditLog = [];
                saveData();
                showNotification('Storico eliminato');
                renderAuditLog();
            }
        }

        // NOTIFICHE BROWSER
        function enableNotifications() {
            if (!('Notification' in window)) {
                alert('Il tuo browser non supporta le notifiche');
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    notificationPermission = true;
                    data.settings.notificationsEnabled = true;
                    saveData();
                    document.getElementById('notification-status').textContent = '‚úì Notifiche abilitate';
                    document.getElementById('notification-status').style.color = '#2ecc71';
                    showNotification('Notifiche browser abilitate!');

                    // Avvia controllo notifiche
                    startNotificationChecks();
                } else {
                    document.getElementById('notification-status').textContent = '‚úó Permesso negato';
                    document.getElementById('notification-status').style.color = '#e74c3c';
                }
            });
        }

        function startNotificationChecks() {
            // Controlla ogni 30 minuti
            setInterval(() => {
                checkForNotifications();
            }, 30 * 60 * 1000);

            // Controlla subito
            checkForNotifications();
        }

        function checkForNotifications() {
            if (!notificationPermission || !data.settings.notificationsEnabled) return;

            const notifications = [];
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            for (let i = 1; i <= 4; i++) {
                const company = data.companies[i];

                // Controlla attivit√† urgenti
                const urgentTasks = company.tasks.filter(t => t.priority === 'aplus' && !t.completed);
                if (urgentTasks.length > 0) {
                    notifications.push({
                        title: `${company.name} - Attivit√† Urgenti`,
                        body: `Hai ${urgentTasks.length} attivit√† urgenti da completare`,
                        type: 'urgent'
                    });
                }

                // Controlla scadenze imminenti
                const imminent = company.deadlines.filter(d => {
                    const deadlineDate = new Date(d.date);
                    return deadlineDate <= tomorrow && deadlineDate >= today && !d.completed;
                });

                if (imminent.length > 0) {
                    notifications.push({
                        title: `${company.name} - Scadenze Imminenti`,
                        body: `${imminent.length} scadenze entro domani!`,
                        type: 'warning'
                    });
                }
            }

            // Mostra badge notifiche
            updateNotificationBadge(notifications.length);

            // Invia notifiche browser
            notifications.forEach((notif, index) => {
                setTimeout(() => {
                    new Notification(notif.title, {
                        body: notif.body,
                        icon: 'üìä'
                    });
                }, index * 1000); // Ritarda di 1 secondo tra una notifica e l'altra
            });

            // Aggiorna pannello notifiche
            updateNotificationPanel(notifications);
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            const countElement = document.getElementById('notification-count');

            if (count > 0) {
                badge.style.display = 'block';
                countElement.textContent = count;
            } else {
                badge.style.display = 'none';
            }
        }

        function updateNotificationPanel(notifications) {
            const panel = document.getElementById('notification-list');

            if (notifications.length === 0) {
                panel.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: #7f8c8d;"><p>Nessuna notifica al momento</p></div>';
                return;
            }

            panel.innerHTML = notifications.map(notif => `
                <div class="notification-item ${notif.type}">
                    <strong>${notif.title}</strong>
                    <p style="margin-top: 5px; font-size: 0.9em;">${notif.body}</p>
                </div>
            `).join('');
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('active');
        }

        // BACKUP AUTOMATICO
        function createBackup() {
            const backup = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                data: JSON.parse(JSON.stringify(data)) // Deep copy
            };

            // Salva in localStorage con chiave separata
            const backups = JSON.parse(localStorage.getItem('gestione-backups') || '[]');
            backups.unshift(backup);

            // Mantieni max 10 backup
            if (backups.length > 10) {
                backups.length = 10;
            }

            localStorage.setItem('gestione-backups', JSON.stringify(backups));

            // Mostra indicator
            const indicator = document.getElementById('backup-indicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);

            showNotification('Backup creato con successo!');
            logAudit('create', 'Backup manuale creato', 'all');
        }

        function startAutoBackup() {
            if (data.settings.autoBackup && !backupInterval) {
                const intervalMinutes = data.settings.backupInterval || 30;
                backupInterval = setInterval(() => {
                    createBackup();
                }, intervalMinutes * 60 * 1000);
            }
        }

        // EXPORT MULTI-FORMATO
        function exportToCSV() {
            const csvData = [];
            csvData.push(['Azienda', 'Tipo', 'Titolo', 'Categoria', 'Priorit√†', 'Data', 'Stato']);

            for (let i = 1; i <= 4; i++) {
                const company = data.companies[i];

                company.tasks.forEach(task => {
                    csvData.push([
                        company.name,
                        'Attivit√†',
                        task.title,
                        task.category,
                        task.priority.toUpperCase(),
                        task.deadline || '',
                        task.completed ? 'Completata' : 'In corso'
                    ]);
                });

                company.deadlines.forEach(deadline => {
                    csvData.push([
                        company.name,
                        'Scadenza',
                        deadline.type,
                        deadline.category,
                        '',
                        deadline.date,
                        deadline.completed ? 'Completata' : 'In corso'
                    ]);
                });
            }

            const csvContent = csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `export-gestione-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            showNotification('Export CSV completato!');
            logAudit('create', 'Export CSV eseguito', 'all');
        }

        function exportToExcel() {
            // Genera HTML table per Excel
            let html = '<table><thead><tr>';
            html += '<th>Azienda</th><th>Tipo</th><th>Titolo</th><th>Categoria</th><th>Priorit√†</th><th>Data</th><th>Stato</th>';
            html += '</tr></thead><tbody>';

            for (let i = 1; i <= 4; i++) {
                const company = data.companies[i];

                company.tasks.forEach(task => {
                    html += `<tr>
                        <td>${company.name}</td>
                        <td>Attivit√†</td>
                        <td>${task.title}</td>
                        <td>${task.category}</td>
                        <td>${task.priority.toUpperCase()}</td>
                        <td>${task.deadline || ''}</td>
                        <td>${task.completed ? 'Completata' : 'In corso'}</td>
                    </tr>`;
                });

                company.deadlines.forEach(deadline => {
                    html += `<tr>
                        <td>${company.name}</td>
                        <td>Scadenza</td>
                        <td>${deadline.type}</td>
                        <td>${deadline.category}</td>
                        <td></td>
                        <td>${deadline.date}</td>
                        <td>${deadline.completed ? 'Completata' : 'In corso'}</td>
                    </tr>`;
                });
            }

            html += '</tbody></table>';

            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `export-gestione-${new Date().toISOString().split('T')[0]}.xls`;
            a.click();

            showNotification('Export Excel completato!');
            logAudit('create', 'Export Excel eseguito', 'all');
        }

        // ===== SISTEMA DETTAGLIO ELEMENTI =====

        // Apri modal dettaglio
        function openDetailModal(type, id, companyId) {
            const modal = document.getElementById('detail-modal');
            const modalBody = document.getElementById('detail-modal-body');
            const modalTitle = document.getElementById('detail-modal-title');

            let item;
            let titleIcon = 'üìã';

            // Trova l'elemento
            if (type === 'task') {
                item = data.companies[companyId].tasks.find(t => t.id === id);
                titleIcon = '‚úÖ';
            } else if (type === 'deadline') {
                item = data.companies[companyId].deadlines.find(d => d.id === id);
                titleIcon = 'üìÖ';
            } else if (type === 'appointment') {
                item = data.companies[companyId].appointments.find(a => a.id === id);
                titleIcon = 'üóìÔ∏è';
            } else if (type === 'expense') {
                item = data.companies[companyId].expenses.find(e => e.id === id);
                titleIcon = 'üí∞';
            }

            if (!item) {
                showNotification('Elemento non trovato');
                return;
            }

            // Inizializza attachments e notes se non esistono
            if (!item.attachments) item.attachments = [];
            if (!item.notes) item.notes = [];
            if (!item.history) item.history = [{
                date: item.createdAt,
                action: 'Elemento creato'
            }];

            modalTitle.innerHTML = `${titleIcon} Dettaglio ${getTypeLabel(type)}`;

            // Genera contenuto
            modalBody.innerHTML = generateDetailContent(type, item, companyId);

            // Mostra modal
            modal.classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('active');
        }

        function getTypeLabel(type) {
            const labels = {
                'task': 'Attivit√†',
                'deadline': 'Scadenza',
                'appointment': 'Appuntamento',
                'expense': 'Spesa'
            };
            return labels[type] || 'Elemento';
        }

        function generateDetailContent(type, item, companyId) {
            let html = '';

            // Informazioni principali
            html += '<div class="detail-section">';
            html += '<div class="detail-section-title">üìä Informazioni Principali</div>';

            if (type === 'task') {
                const status = item.completed ? 'completed' : (item.deadline && new Date(item.deadline) < new Date() ? 'overdue' : 'pending');
                const statusLabel = item.completed ? 'Completata' : (status === 'overdue' ? 'In ritardo' : 'In corso');

                html += '<div class="detail-info-grid">';
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Stato</div>
                    <div class="detail-info-value"><span class="status-badge ${status}">${statusLabel}</span></div>
                </div>`;
                html += `<div class="detail-info-item" style="border-left-color: var(--priority-${item.priority})">
                    <div class="detail-info-label">Priorit√†</div>
                    <div class="detail-info-value"><span class="priority-badge ${item.priority}">${item.priority.toUpperCase()}</span></div>
                </div>`;
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Categoria</div>
                    <div class="detail-info-value">${item.category}</div>
                </div>`;
                if (item.deadline) {
                    html += `<div class="detail-info-item">
                        <div class="detail-info-label">Scadenza</div>
                        <div class="detail-info-value">${formatDate(item.deadline)}</div>
                    </div>`;
                }
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Data Creazione</div>
                    <div class="detail-info-value">${new Date(item.createdAt).toLocaleDateString('it-IT')}</div>
                </div>`;
                html += '</div>';

                if (item.description) {
                    html += `<div class="detail-description"><strong>Descrizione:</strong><br>${item.description}</div>`;
                }
            } else if (type === 'deadline') {
                const status = item.completed ? 'completed' : (new Date(item.date) < new Date() ? 'overdue' : 'pending');
                const statusLabel = item.completed ? 'Pagata' : (status === 'overdue' ? 'Scaduta' : 'Da pagare');

                html += '<div class="detail-info-grid">';
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Stato</div>
                    <div class="detail-info-value"><span class="status-badge ${status}">${statusLabel}</span></div>
                </div>`;
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Tipo</div>
                    <div class="detail-info-value">${item.type}</div>
                </div>`;
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Categoria</div>
                    <div class="detail-info-value">${item.category}</div>
                </div>`;
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Data Scadenza</div>
                    <div class="detail-info-value">${formatDate(item.date)}</div>
                </div>`;
                if (item.amount) {
                    html += `<div class="detail-info-item" style="border-left-color: var(--warning-color)">
                        <div class="detail-info-label">Importo</div>
                        <div class="detail-info-value" style="font-size: 1.3em; font-weight: bold;">${item.amount}</div>
                    </div>`;
                }
                html += '</div>';

                if (item.description) {
                    html += `<div class="detail-description"><strong>Note:</strong><br>${item.description}</div>`;
                }
            } else if (type === 'appointment') {
                html += '<div class="detail-info-grid">';
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Data</div>
                    <div class="detail-info-value">${formatDate(item.date)}</div>
                </div>`;
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Ora</div>
                    <div class="detail-info-value">${item.time}</div>
                </div>`;
                if (item.location) {
                    html += `<div class="detail-info-item">
                        <div class="detail-info-label">Luogo</div>
                        <div class="detail-info-value">${item.location}</div>
                    </div>`;
                }
                if (item.participants) {
                    html += `<div class="detail-info-item">
                        <div class="detail-info-label">Partecipanti</div>
                        <div class="detail-info-value">${item.participants}</div>
                    </div>`;
                }
                html += '</div>';

                if (item.notes) {
                    html += `<div class="detail-description"><strong>Note:</strong><br>${item.notes}</div>`;
                }
            } else if (type === 'expense') {
                html += '<div class="detail-info-grid">';
                html += `<div class="detail-info-item" style="border-left-color: var(--danger-color)">
                    <div class="detail-info-label">Importo</div>
                    <div class="detail-info-value" style="font-size: 1.4em; font-weight: bold; color: var(--danger-color)">‚Ç¨ ${item.amount.toFixed(2)}</div>
                </div>`;
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Categoria</div>
                    <div class="detail-info-value">${item.category}</div>
                </div>`;
                html += `<div class="detail-info-item">
                    <div class="detail-info-label">Data</div>
                    <div class="detail-info-value">${formatDate(item.date)}</div>
                </div>`;
                if (item.paymentMethod) {
                    html += `<div class="detail-info-item">
                        <div class="detail-info-label">Metodo Pagamento</div>
                        <div class="detail-info-value">${item.paymentMethod}</div>
                    </div>`;
                }
                html += '</div>';

                if (item.description) {
                    html += `<div class="detail-description"><strong>Descrizione:</strong><br>${item.description}</div>`;
                }
            }

            html += '</div>';

            // Documenti Allegati
            html += '<div class="detail-section">';
            html += '<div class="detail-section-title">üìé Documenti Allegati</div>';

            if (item.attachments && item.attachments.length > 0) {
                html += '<div class="attachments-list">';
                item.attachments.forEach((att, index) => {
                    const icon = getFileIcon(att.name);
                    html += `
                        <div class="attachment-item">
                            <div class="attachment-info">
                                <div class="attachment-icon">${icon}</div>
                                <div class="attachment-details">
                                    <h4>${att.name}</h4>
                                    <div class="attachment-meta">
                                        ${att.type || 'Documento'} ‚Ä¢ Aggiunto il ${new Date(att.addedAt).toLocaleDateString('it-IT')}
                                        ${att.size ? ` ‚Ä¢ ${att.size}` : ''}
                                    </div>
                                    ${att.notes ? `<p style="margin-top: 5px; font-size: 0.9em;">${att.notes}</p>` : ''}
                                </div>
                            </div>
                            <div class="attachment-actions">
                                ${att.link ? `<a href="${att.link}" target="_blank" class="btn btn-small">Apri</a>` : ''}
                                <button class="btn btn-danger btn-small" onclick="removeAttachment('${type}', ${item.id}, ${companyId}, ${index})">Elimina</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Nessun documento allegato</p>';
            }

            // Form aggiungi allegato
            html += `
                <div class="add-attachment-form">
                    <h4 style="margin-bottom: 15px;">Aggiungi Documento</h4>
                    <form onsubmit="addAttachment(event, '${type}', ${item.id}, ${companyId})">
                        <div class="form-inline">
                            <div class="form-group">
                                <label>Nome Documento *</label>
                                <input type="text" id="attach-name" required placeholder="es: Contratto_firmato.pdf">
                            </div>
                            <div class="form-group">
                                <label>Tipo</label>
                                <select id="attach-type">
                                    <option value="Documento">Documento</option>
                                    <option value="Contratto">Contratto</option>
                                    <option value="Fattura">Fattura</option>
                                    <option value="Email">Email</option>
                                    <option value="Preventivo">Preventivo</option>
                                    <option value="Altro">Altro</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>Link/Percorso File</label>
                            <input type="text" id="attach-link" placeholder="es: C:\\Documenti\\file.pdf o URL">
                        </div>
                        <div class="form-group">
                            <label>Note</label>
                            <input type="text" id="attach-notes" placeholder="Note sul documento...">
                        </div>
                        <button type="submit" class="btn btn-success">Aggiungi Documento</button>
                    </form>
                </div>
            `;

            html += '</div>';

            // Note interne
            html += '<div class="detail-section">';
            html += '<div class="detail-section-title">üìù Note e Commenti</div>';

            html += '<div class="notes-section">';
            if (item.notes && item.notes.length > 0) {
                html += '<div class="notes-list">';
                item.notes.forEach((note, index) => {
                    html += `
                        <div class="note-item">
                            <div class="note-header">
                                <span class="note-date">${new Date(note.date).toLocaleString('it-IT')}</span>
                                <button class="btn btn-danger btn-small" onclick="removeNote('${type}', ${item.id}, ${companyId}, ${index})">Elimina</button>
                            </div>
                            <div class="note-text">${note.text}</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Nessuna nota presente</p>';
            }

            // Form aggiungi nota
            html += `
                <div class="add-note-form">
                    <form onsubmit="addNote(event, '${type}', ${item.id}, ${companyId})">
                        <div class="form-group">
                            <label>Aggiungi Nota</label>
                            <textarea id="note-text" rows="3" required placeholder="Scrivi una nota o commento..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Aggiungi Nota</button>
                    </form>
                </div>
            `;
            html += '</div>';

            html += '</div>';

            // Cronologia
            if (item.history && item.history.length > 0) {
                html += '<div class="detail-section">';
                html += '<div class="detail-section-title">üïí Cronologia</div>';
                html += '<div class="timeline">';

                item.history.slice().reverse().forEach(h => {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <div class="timeline-date">${new Date(h.date).toLocaleString('it-IT')}</div>
                                <div class="timeline-text">${h.action}</div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                html += '</div>';
            }

            // Azioni
            html += '<div class="detail-actions">';
            if (type === 'task' && !item.completed) {
                html += `<button class="btn btn-success" onclick="completeTaskFromDetail(${item.id}, ${companyId})">‚úì Segna come Completata</button>`;
            } else if (type === 'deadline' && !item.completed) {
                html += `<button class="btn btn-success" onclick="completeDeadlineFromDetail(${item.id}, ${companyId})">‚úì Segna come Pagata</button>`;
            }
            html += `<button class="btn btn-danger" onclick="deleteItemFromDetail('${type}', ${item.id}, ${companyId})">üóëÔ∏è Elimina</button>`;
            html += '<button class="btn" onclick="closeDetailModal()">Chiudi</button>';
            html += '</div>';

            return html;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìï',
                'doc': 'üìò',
                'docx': 'üìò',
                'xls': 'üìó',
                'xlsx': 'üìó',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'png': 'üñºÔ∏è',
                'zip': 'üì¶',
                'eml': 'üìß',
                'msg': 'üìß'
            };
            return icons[ext] || 'üìÑ';
        }

        // Aggiungi allegato
        function addAttachment(event, type, itemId, companyId) {
            event.preventDefault();

            const attachment = {
                id: Date.now(),
                name: document.getElementById('attach-name').value,
                type: document.getElementById('attach-type').value,
                link: document.getElementById('attach-link').value,
                notes: document.getElementById('attach-notes').value,
                size: '',
                addedAt: new Date().toISOString()
            };

            let item;
            if (type === 'task') {
                item = data.companies[companyId].tasks.find(t => t.id === itemId);
            } else if (type === 'deadline') {
                item = data.companies[companyId].deadlines.find(d => d.id === itemId);
            } else if (type === 'appointment') {
                item = data.companies[companyId].appointments.find(a => a.id === itemId);
            } else if (type === 'expense') {
                item = data.companies[companyId].expenses.find(e => e.id === itemId);
            }

            if (!item.attachments) item.attachments = [];
            item.attachments.push(attachment);

            if (!item.history) item.history = [];
            item.history.push({
                date: new Date().toISOString(),
                action: `Documento aggiunto: ${attachment.name}`
            });

            saveData();
            logAudit('update', `Documento aggiunto a ${getTypeLabel(type)}: ${attachment.name}`, companyId);

            showNotification('Documento aggiunto!');
            openDetailModal(type, itemId, companyId);
        }

        // Rimuovi allegato
        function removeAttachment(type, itemId, companyId, index) {
            if (!confirm('Vuoi eliminare questo documento?')) return;

            let item;
            if (type === 'task') {
                item = data.companies[companyId].tasks.find(t => t.id === itemId);
            } else if (type === 'deadline') {
                item = data.companies[companyId].deadlines.find(d => d.id === itemId);
            } else if (type === 'appointment') {
                item = data.companies[companyId].appointments.find(a => a.id === itemId);
            } else if (type === 'expense') {
                item = data.companies[companyId].expenses.find(e => e.id === itemId);
            }

            const removed = item.attachments.splice(index, 1)[0];

            if (!item.history) item.history = [];
            item.history.push({
                date: new Date().toISOString(),
                action: `Documento rimosso: ${removed.name}`
            });

            saveData();
            logAudit('delete', `Documento rimosso da ${getTypeLabel(type)}: ${removed.name}`, companyId);

            showNotification('Documento eliminato');
            openDetailModal(type, itemId, companyId);
        }

        // Aggiungi nota
        function addNote(event, type, itemId, companyId) {
            event.preventDefault();

            const note = {
                id: Date.now(),
                text: document.getElementById('note-text').value,
                date: new Date().toISOString()
            };

            let item;
            if (type === 'task') {
                item = data.companies[companyId].tasks.find(t => t.id === itemId);
            } else if (type === 'deadline') {
                item = data.companies[companyId].deadlines.find(d => d.id === itemId);
            } else if (type === 'appointment') {
                item = data.companies[companyId].appointments.find(a => a.id === itemId);
            } else if (type === 'expense') {
                item = data.companies[companyId].expenses.find(e => e.id === itemId);
            }

            if (!item.notes) item.notes = [];
            item.notes.push(note);

            if (!item.history) item.history = [];
            item.history.push({
                date: new Date().toISOString(),
                action: 'Nota aggiunta'
            });

            saveData();
            logAudit('update', `Nota aggiunta a ${getTypeLabel(type)}`, companyId);

            showNotification('Nota aggiunta!');
            openDetailModal(type, itemId, companyId);
        }

        // Rimuovi nota
        function removeNote(type, itemId, companyId, index) {
            if (!confirm('Vuoi eliminare questa nota?')) return;

            let item;
            if (type === 'task') {
                item = data.companies[companyId].tasks.find(t => t.id === itemId);
            } else if (type === 'deadline') {
                item = data.companies[companyId].deadlines.find(d => d.id === itemId);
            } else if (type === 'appointment') {
                item = data.companies[companyId].appointments.find(a => a.id === itemId);
            } else if (type === 'expense') {
                item = data.companies[companyId].expenses.find(e => e.id === itemId);
            }

            item.notes.splice(index, 1);

            if (!item.history) item.history = [];
            item.history.push({
                date: new Date().toISOString(),
                action: 'Nota rimossa'
            });

            saveData();
            logAudit('delete', `Nota rimossa da ${getTypeLabel(type)}`, companyId);

            showNotification('Nota eliminata');
            openDetailModal(type, itemId, companyId);
        }

        // Completa task da dettaglio
        function completeTaskFromDetail(taskId, companyId) {
            const task = data.companies[companyId].tasks.find(t => t.id === taskId);
            if (!task) return;

            task.completed = true;
            task.completedAt = new Date().toISOString().split('T')[0];

            if (!task.history) task.history = [];
            task.history.push({
                date: new Date().toISOString(),
                action: 'Attivit√† completata'
            });

            saveData();
            logAudit('update', `Attivit√† completata: ${task.title}`, companyId);

            showNotification('Attivit√† completata!');
            updateAllTasks();
            updateDashboard();
            openDetailModal('task', taskId, companyId);
        }

        // Completa deadline da dettaglio
        function completeDeadlineFromDetail(deadlineId, companyId) {
            const deadline = data.companies[companyId].deadlines.find(d => d.id === deadlineId);
            if (!deadline) return;

            deadline.completed = true;

            if (!deadline.history) deadline.history = [];
            deadline.history.push({
                date: new Date().toISOString(),
                action: 'Scadenza pagata'
            });

            saveData();
            logAudit('update', `Scadenza completata: ${deadline.type}`, companyId);

            showNotification('Scadenza segnata come pagata!');
            updateDeadlinesTable();
            openDetailModal('deadline', deadlineId, companyId);
        }

        // Elimina elemento da dettaglio
        function deleteItemFromDetail(type, itemId, companyId) {
            if (!confirm(`Vuoi eliminare questo ${getTypeLabel(type).toLowerCase()}?`)) return;

            if (type === 'task') {
                const index = data.companies[companyId].tasks.findIndex(t => t.id === itemId);
                if (index !== -1) {
                    const task = data.companies[companyId].tasks[index];
                    data.companies[companyId].tasks.splice(index, 1);
                    logAudit('delete', `Attivit√† eliminata: ${task.title}`, companyId);
                    updateAllTasks();
                    updateDashboard();
                }
            } else if (type === 'deadline') {
                const index = data.companies[companyId].deadlines.findIndex(d => d.id === itemId);
                if (index !== -1) {
                    const deadline = data.companies[companyId].deadlines[index];
                    data.companies[companyId].deadlines.splice(index, 1);
                    logAudit('delete', `Scadenza eliminata: ${deadline.type}`, companyId);
                    updateDeadlinesTable();
                }
            } else if (type === 'appointment') {
                const index = data.companies[companyId].appointments.findIndex(a => a.id === itemId);
                if (index !== -1) {
                    const appointment = data.companies[companyId].appointments[index];
                    data.companies[companyId].appointments.splice(index, 1);
                    logAudit('delete', `Appuntamento eliminato: ${appointment.title}`, companyId);
                    updateAppointments();
                }
            } else if (type === 'expense') {
                const index = data.companies[companyId].expenses.findIndex(e => e.id === itemId);
                if (index !== -1) {
                    const expense = data.companies[companyId].expenses[index];
                    data.companies[companyId].expenses.splice(index, 1);
                    logAudit('delete', `Spesa eliminata: ${expense.description}`, companyId);
                    updateExpenses();
                }
            }

            saveData();
            closeDetailModal();
            showNotification('Elemento eliminato');
        }

        // Chiudi modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const detailModal = document.getElementById('detail-modal');
                if (detailModal.classList.contains('active')) {
                    closeDetailModal();
                }

                const emailViewModal = document.getElementById('email-view-modal');
                if (emailViewModal && emailViewModal.classList.contains('active')) {
                    closeEmailView();
                }

                const emailComposeModal = document.getElementById('email-compose-modal');
                if (emailComposeModal && emailComposeModal.classList.contains('active')) {
                    closeEmailCompose();
                }

                const assistantPanel = document.getElementById('email-assistant-panel');
                if (assistantPanel && assistantPanel.classList.contains('active')) {
                    toggleEmailAssistant();
                }
            }
        });

        // ===================================
        // GESTIONE EMAIL & ASSISTENTE IA
        // ===================================

        let currentEmailTab = 'inbox'; // inbox, sent, archived, trash
        let currentSelectedEmail = null; // Email selezionata per l'assistente
        let currentEmailFilter = {
            search: '',
            priority: 'all',
            category: 'all',
            unread: false,
            starred: false
        };

        // Inizializza sezione email
        function initializeEmailSection() {
            // Migrazione dati - aggiunge emails array se non esiste
            Object.keys(data.companies).forEach(companyId => {
                if (!data.companies[companyId].emails) {
                    data.companies[companyId].emails = [];
                }
            });

            // Aggiorna UI
            updateEmailStats();
            renderEmailList();

            // Checkbox template
            const useTemplateCheckbox = document.getElementById('email-use-template');
            if (useTemplateCheckbox) {
                useTemplateCheckbox.addEventListener('change', function() {
                    const templateSelect = document.getElementById('email-template-select');
                    if (templateSelect) {
                        templateSelect.style.display = this.checked ? 'inline-block' : 'none';
                    }
                });
            }
        }

        // Cambia tab email
        function switchEmailTab(tab) {
            currentEmailTab = tab;

            // Aggiorna bottoni
            document.querySelectorAll('.email-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Aggiorna titolo
            const titles = {
                'inbox': 'üì• Posta in Arrivo',
                'sent': 'üì§ Inviati',
                'archived': 'üì¶ Archiviati',
                'trash': 'üóëÔ∏è Cestino'
            };
            document.getElementById('current-email-tab-title').textContent = titles[tab];

            renderEmailList();
        }

        // Aggiorna statistiche email
        function updateEmailStats() {
            const emails = data.companies[currentCompany].emails || [];

            const unread = emails.filter(e => e.folder === 'inbox' && !e.read).length;
            const urgent = emails.filter(e => e.folder === 'inbox' && e.priority === 'urgent').length;
            const today = emails.filter(e => {
                const emailDate = new Date(e.date);
                const now = new Date();
                return emailDate.toDateString() === now.toDateString() && e.folder === 'inbox';
            }).length;
            const starred = emails.filter(e => e.starred).length;

            document.getElementById('stat-unread-emails').textContent = unread;
            document.getElementById('stat-urgent-emails').textContent = urgent;
            document.getElementById('stat-today-emails').textContent = today;
            document.getElementById('stat-flagged-emails').textContent = starred;

            // Aggiorna contatori tab
            document.getElementById('inbox-count').textContent = emails.filter(e => e.folder === 'inbox').length;
            document.getElementById('sent-count').textContent = emails.filter(e => e.folder === 'sent').length;
            document.getElementById('archived-count').textContent = emails.filter(e => e.folder === 'archived').length;
            document.getElementById('trash-count').textContent = emails.filter(e => e.folder === 'trash').length;
        }

        // Filtra email
        function filterEmails() {
            currentEmailFilter = {
                search: document.getElementById('email-search').value.toLowerCase(),
                priority: document.getElementById('email-filter-priority').value,
                category: document.getElementById('email-filter-category').value,
                unread: document.getElementById('email-filter-unread').checked,
                starred: document.getElementById('email-filter-starred').checked
            };

            renderEmailList();
        }

        // Renderizza lista email
        function renderEmailList() {
            const container = document.getElementById('email-list-container');
            if (!container) return;

            const emails = data.companies[currentCompany].emails || [];

            // Filtra per tab
            let filtered = emails.filter(e => e.folder === currentEmailTab);

            // Applica filtri
            if (currentEmailFilter.search) {
                filtered = filtered.filter(e =>
                    e.from.toLowerCase().includes(currentEmailFilter.search) ||
                    e.to.toLowerCase().includes(currentEmailFilter.search) ||
                    e.subject.toLowerCase().includes(currentEmailFilter.search) ||
                    e.body.toLowerCase().includes(currentEmailFilter.search)
                );
            }

            if (currentEmailFilter.priority !== 'all') {
                filtered = filtered.filter(e => e.priority === currentEmailFilter.priority);
            }

            if (currentEmailFilter.category !== 'all') {
                filtered = filtered.filter(e => e.category === currentEmailFilter.category);
            }

            if (currentEmailFilter.unread) {
                filtered = filtered.filter(e => !e.read);
            }

            if (currentEmailFilter.starred) {
                filtered = filtered.filter(e => e.starred);
            }

            // Ordina per data (pi√π recenti prima)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Nessuna email in questa cartella</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(email => `
                <div class="email-item ${email.read ? '' : 'unread'} ${email.priority !== 'normal' ? email.priority : ''}"
                     onclick="openEmailView(${email.id})">
                    <div class="email-checkbox">
                        <input type="checkbox" onclick="event.stopPropagation()">
                    </div>
                    <div class="email-star ${email.starred ? 'starred' : ''}"
                         onclick="event.stopPropagation(); toggleEmailStar(${email.id})">
                        ${email.starred ? '‚≠ê' : '‚òÜ'}
                    </div>
                    <div class="email-content">
                        <div class="email-header">
                            <div class="email-from">${currentEmailTab === 'sent' ? 'A: ' + email.to : email.from}</div>
                            <div class="email-date">${formatEmailDate(email.date)}</div>
                        </div>
                        <div class="email-subject">${email.subject}</div>
                        <div class="email-preview">${email.body.substring(0, 100)}...</div>
                        <div class="email-tags">
                            ${email.priority !== 'normal' ? `<span class="email-tag priority-${email.priority}">${getPriorityLabel(email.priority)}</span>` : ''}
                            <span class="email-tag category">${getCategoryLabel(email.category)}</span>
                            ${email.attachments && email.attachments.length > 0 ? `<span class="email-tag has-attachment">üìé ${email.attachments.length}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Apri visualizzazione email
        function openEmailView(emailId) {
            const email = data.companies[currentCompany].emails.find(e => e.id === emailId);
            if (!email) return;

            // Segna come letta
            if (!email.read && email.folder === 'inbox') {
                email.read = true;
                saveData();
                updateEmailStats();
                renderEmailList();
            }

            // Imposta email corrente per l'assistente
            currentSelectedEmail = email;
            updateEmailAssistantAnalysis(email);

            const modal = document.getElementById('email-view-modal');
            const body = document.getElementById('email-view-body');
            const title = document.getElementById('email-view-title');

            title.textContent = `üìß ${email.subject}`;

            body.innerHTML = `
                <div class="email-view-header">
                    <div class="email-view-subject">${email.subject}</div>
                    <div class="email-view-meta">
                        <strong>Da:</strong> <span>${email.from}</span>
                        <strong>A:</strong> <span>${email.to}</span>
                        <strong>Data:</strong> <span>${formatEmailDate(email.date)}</span>
                        <strong>Priorit√†:</strong> <span class="email-tag priority-${email.priority}">${getPriorityLabel(email.priority)}</span>
                        <strong>Categoria:</strong> <span class="email-tag category">${getCategoryLabel(email.category)}</span>
                        ${email.attachments && email.attachments.length > 0 ? `
                            <strong>Allegati:</strong>
                            <span>${email.attachments.map(a => `üìé ${a.name}`).join(', ')}</span>
                        ` : ''}
                    </div>
                </div>

                <div class="email-view-body">
                    ${email.body}
                </div>

                <div class="email-view-actions">
                    ${email.folder !== 'trash' ? `
                        <button class="btn btn-success" onclick="replyEmail(${emailId})">‚Ü©Ô∏è Rispondi</button>
                        <button class="btn" onclick="forwardEmail(${emailId})">‚û°Ô∏è Inoltra</button>
                    ` : ''}
                    ${email.folder === 'inbox' ? `
                        <button class="btn" onclick="archiveEmail(${emailId})">üì¶ Archivia</button>
                    ` : ''}
                    ${email.folder === 'archived' ? `
                        <button class="btn" onclick="moveToInbox(${emailId})">üì• Sposta in Inbox</button>
                    ` : ''}
                    ${email.folder !== 'trash' ? `
                        <button class="btn btn-danger" onclick="deleteEmail(${emailId})">üóëÔ∏è Elimina</button>
                    ` : ''}
                    ${email.folder === 'trash' ? `
                        <button class="btn" onclick="restoreEmail(${emailId})">‚Ü©Ô∏è Ripristina</button>
                        <button class="btn btn-danger" onclick="permanentDeleteEmail(${emailId})">‚ö†Ô∏è Elimina Definitivamente</button>
                    ` : ''}
                </div>
            `;

            modal.classList.add('active');
        }

        // Chiudi visualizzazione email
        function closeEmailView() {
            document.getElementById('email-view-modal').classList.remove('active');
        }

        // Toggle stella email
        function toggleEmailStar(emailId) {
            const email = data.companies[currentCompany].emails.find(e => e.id === emailId);
            if (!email) return;

            email.starred = !email.starred;
            saveData();
            updateEmailStats();
            renderEmailList();
        }

        // Componi nuova email
        function composeNewEmail() {
            document.getElementById('email-compose-form').reset();
            document.getElementById('email-compose-modal').classList.add('active');
        }

        // Rispondi email
        function replyEmail(emailId) {
            const email = data.companies[currentCompany].emails.find(e => e.id === emailId);
            if (!email) return;

            closeEmailView();
            composeNewEmail();

            document.getElementById('email-to').value = email.from;
            document.getElementById('email-subject').value = 'Re: ' + email.subject;
            document.getElementById('email-compose-category').value = email.category;
            document.getElementById('email-compose-priority').value = email.priority;

            const originalBody = `

------- Messaggio Originale -------
Da: ${email.from}
Data: ${formatEmailDate(email.date)}
Oggetto: ${email.subject}

${email.body}`;

            document.getElementById('email-body').value = originalBody;
            // Posiziona cursore all'inizio
            document.getElementById('email-body').setSelectionRange(0, 0);
            document.getElementById('email-body').focus();
        }

        // Inoltra email
        function forwardEmail(emailId) {
            const email = data.companies[currentCompany].emails.find(e => e.id === emailId);
            if (!email) return;

            closeEmailView();
            composeNewEmail();

            document.getElementById('email-subject').value = 'Fwd: ' + email.subject;
            document.getElementById('email-compose-category').value = email.category;
            document.getElementById('email-compose-priority').value = email.priority;

            const forwardBody = `

------- Messaggio Inoltrato -------
Da: ${email.from}
A: ${email.to}
Data: ${formatEmailDate(email.date)}
Oggetto: ${email.subject}

${email.body}`;

            document.getElementById('email-body').value = forwardBody;
            document.getElementById('email-body').setSelectionRange(0, 0);
            document.getElementById('email-to').focus();
        }

        // Archivia email
        function archiveEmail(emailId) {
            const email = data.companies[currentCompany].emails.find(e => e.id === emailId);
            if (!email) return;

            email.folder = 'archived';
            saveData();
            closeEmailView();
            updateEmailStats();
            renderEmailList();
            showNotification('Email archiviata');
        }

        // Sposta in inbox
        function moveToInbox(emailId) {
            const email = data.companies[currentCompany].emails.find(e => e.id === emailId);
            if (!email) return;

            email.folder = 'inbox';
            saveData();
            closeEmailView();
            updateEmailStats();
            renderEmailList();
            showNotification('Email spostata in Posta in Arrivo');
        }

        // Elimina email (sposta in cestino)
        function deleteEmail(emailId) {
            const email = data.companies[currentCompany].emails.find(e => e.id === emailId);
            if (!email) return;

            email.folder = 'trash';
            saveData();
            closeEmailView();
            updateEmailStats();
            renderEmailList();
            showNotification('Email spostata nel cestino');
        }

        // Ripristina email
        function restoreEmail(emailId) {
            const email = data.companies[currentCompany].emails.find(e => e.id === emailId);
            if (!email) return;

            email.folder = 'inbox';
            saveData();
            closeEmailView();
            updateEmailStats();
            renderEmailList();
            showNotification('Email ripristinata');
        }

        // Elimina definitivamente
        function permanentDeleteEmail(emailId) {
            if (!confirm('Sei sicura di voler eliminare definitivamente questa email? Questa azione non pu√≤ essere annullata.')) {
                return;
            }

            const index = data.companies[currentCompany].emails.findIndex(e => e.id === emailId);
            if (index !== -1) {
                data.companies[currentCompany].emails.splice(index, 1);
                saveData();
                closeEmailView();
                updateEmailStats();
                renderEmailList();
                showNotification('Email eliminata definitivamente');
            }
        }

        // Invia email
        function sendEmail(event) {
            event.preventDefault();

            const newEmail = {
                id: Date.now(),
                from: 'me@company.com', // Email dell'azienda
                to: document.getElementById('email-to').value,
                subject: document.getElementById('email-subject').value,
                body: document.getElementById('email-body').value,
                category: document.getElementById('email-compose-category').value,
                priority: document.getElementById('email-compose-priority').value,
                date: new Date().toISOString(),
                folder: 'sent',
                read: true,
                starred: false,
                attachments: []
            };

            data.companies[currentCompany].emails.push(newEmail);

            logAudit('create', 'email', newEmail.id, `Email inviata a: ${newEmail.to}`);
            saveData();
            closeEmailCompose();
            updateEmailStats();
            renderEmailList();
            showNotification('‚úÖ Email inviata con successo!');
        }

        // Salva bozza
        function saveDraft() {
            const draft = {
                id: Date.now(),
                from: 'me@company.com',
                to: document.getElementById('email-to').value || '',
                subject: document.getElementById('email-subject').value || '(Nessun oggetto)',
                body: document.getElementById('email-body').value || '',
                category: document.getElementById('email-compose-category').value,
                priority: document.getElementById('email-compose-priority').value,
                date: new Date().toISOString(),
                folder: 'drafts',
                read: true,
                starred: false,
                attachments: []
            };

            data.companies[currentCompany].emails.push(draft);
            saveData();
            closeEmailCompose();
            showNotification('üíæ Bozza salvata');
        }

        // Chiudi modal composizione
        function closeEmailCompose() {
            document.getElementById('email-compose-modal').classList.remove('active');
        }

        // Applica template email
        function applyEmailTemplate() {
            const templateId = document.getElementById('email-template-select').value;
            if (!templateId) return;

            const templates = {
                'conferma-ordine': {
                    subject: 'Conferma Ordine',
                    body: `Gentile Cliente,

Confermiamo la ricezione del Vostro ordine n. ______ del _______.

I prodotti ordinati sono i seguenti:
- _______
- _______

Tempi di consegna previsti: _______ giorni lavorativi.

Restiamo a disposizione per qualsiasi chiarimento.

Cordiali saluti,
${data.companies[currentCompany].name}`
                },
                'sollecito-pagamento': {
                    subject: 'Sollecito Pagamento - Fattura n. _____',
                    body: `Gentile Cliente,

Con la presente Vi informiamo che la fattura n. _____ del _______ risulta ancora non saldata.

Importo: ‚Ç¨ _______
Scadenza: _______

Vi chiediamo cortesemente di provvedere al saldo entro _______ giorni.

In caso di problemi o necessit√† di chiarimenti, non esitate a contattarci.

Cordiali saluti,
${data.companies[currentCompany].name}`
                },
                'richiesta-info': {
                    subject: 'Richiesta Informazioni',
                    body: `Gentile _______,

Con la presente desideriamo richiedere informazioni riguardo a:

_______

Restiamo in attesa di Vs cortese riscontro.

Cordiali saluti,
${data.companies[currentCompany].name}`
                },
                'conferma-appuntamento': {
                    subject: 'Conferma Appuntamento',
                    body: `Gentile _______,

Confermiamo l'appuntamento fissato per:

Data: _______
Ora: _______
Luogo: _______

In caso di impedimenti, Vi preghiamo di comunicarcelo tempestivamente.

Cordiali saluti,
${data.companies[currentCompany].name}`
                },
                'risposta-reclamo': {
                    subject: 'Re: Reclamo - Ns. Rif. _______',
                    body: `Gentile Cliente,

Facciamo riferimento alla Vostra comunicazione del _______ relativa a _______.

Ci scusiamo per il disagio arrecato e Vi informiamo che:

_______

Restiamo a disposizione per ulteriori chiarimenti.

Cordiali saluti,
${data.companies[currentCompany].name}`
                }
            };

            const template = templates[templateId];
            if (template) {
                document.getElementById('email-subject').value = template.subject;
                document.getElementById('email-body').value = template.body;
            }
        }

        // Toggle pannello assistente
        function toggleEmailAssistant() {
            const panel = document.getElementById('email-assistant-panel');
            panel.classList.toggle('active');
        }

        // Aggiorna analisi assistente (VERSIONE AVANZATA con IA)
        function updateEmailAssistantAnalysis(email) {
            if (!email) return;

            const analysisContainer = document.getElementById('email-analysis');

            // Usa il classificatore IA avanzato
            const analysis = advancedClassifyEmail(email);

            // Estrai appuntamenti se presenti
            let appointmentsHtml = '';
            if (analysis.hasAppointment) {
                const appointments = extractAppointmentsFromEmail(email);
                if (appointments.length > 0) {
                    appointmentsHtml = `
                        <div class="analysis-item">
                            <strong>üìÖ Appuntamenti Rilevati</strong>
                            ${appointments.map(apt => `
                                <div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 5px;">
                                    üìå ${apt.title}<br>
                                    ‚è∞ ${apt.date} alle ${apt.time}
                                    ${apt.location ? `<br>üìç ${apt.location}` : ''}
                                    <button class="btn-small" style="margin-top: 5px;" onclick="quickAddAppointment('${apt.title}', '${apt.date}', '${apt.time}', '${apt.description}')">
                                        Aggiungi al Calendario
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            // Estrai scadenze se presenti
            let deadlinesHtml = '';
            if (analysis.hasDeadline) {
                const deadlines = extractDeadlinesFromEmail(email);
                if (deadlines.length > 0) {
                    deadlinesHtml = `
                        <div class="analysis-item">
                            <strong>‚è∞ Scadenze Rilevate</strong>
                            ${deadlines.map(dl => `
                                <div style="margin-top: 8px; padding: 8px; background: #fff3e0; border-radius: 5px;">
                                    üìå ${dl.title}<br>
                                    üìÖ ${dl.date}
                                    <button class="btn-small" style="margin-top: 5px;" onclick="quickAddDeadline('${dl.title}', '${dl.date}', '${dl.description}')">
                                        Aggiungi Scadenza
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            analysisContainer.innerHTML = `
                <div class="analysis-item">
                    <strong>üéØ Classificazione IA</strong>
                    <div style="margin-top: 8px;">
                        Categoria: ${getCategoryLabel(analysis.category)}<br>
                        Priorit√†: ${getPriorityLabel(analysis.priority)}<br>
                        Confidenza: ${(analysis.confidence * 100).toFixed(0)}%
                    </div>
                </div>
                <div class="analysis-item">
                    <strong>üìä Punteggio Urgenza</strong>
                    <div style="margin-top: 8px;">
                        ${analysis.urgencyScore >= 4 ? 'üî¥ Molto Alta' :
                          analysis.urgencyScore >= 2 ? 'üü° Media-Alta' :
                          analysis.urgencyScore >= 1 ? 'üü¢ Media' : '‚ö™ Bassa'}
                        (${analysis.urgencyScore.toFixed(1)}/10)
                    </div>
                </div>
                <div class="analysis-item">
                    <strong>‚úÖ Richieste Rilevate</strong>
                    <div style="margin-top: 8px;">
                        ${analysis.requiresReply ? '‚úì Richiede risposta' : '‚óã Non richiede risposta'}<br>
                        ${analysis.requiresAction ? '‚úì Richiede azione' : '‚óã Non richiede azione'}<br>
                        ${analysis.hasDeadline ? '‚úì Contiene scadenze' : '‚óã Nessuna scadenza'}<br>
                        ${analysis.hasAppointment ? '‚úì Contiene appuntamenti' : '‚óã Nessun appuntamento'}
                    </div>
                </div>
                ${appointmentsHtml}
                ${deadlinesHtml}
                <div class="analysis-item">
                    <strong>ü§ñ Regole Attivate</strong>
                    <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
                        ${analysis.matchedRules.length > 0 ?
                            analysis.matchedRules.map(r => `‚Ä¢ ${r}`).join('<br>') :
                            'Nessuna regola speciale attivata'
                        }
                    </div>
                </div>
                <div class="analysis-item">
                    <strong>üí° Suggerimento IA</strong>
                    <div style="margin-top: 8px; padding: 10px; background: #e8f5e9; border-radius: 5px; color: #2e7d32;">
                        ${analysis.urgencyScore >= 4 ? 'üö® Rispondere URGENTEMENTE - Entro oggi!' :
                          analysis.requiresAction ? '‚úÖ Creare un\'attivit√† da questa email' :
                          analysis.requiresReply ? 'üìß Preparare risposta dettagliata entro 24-48h' :
                          analysis.hasAppointment ? 'üìÖ Aggiungere appuntamento al calendario' :
                          analysis.hasDeadline ? '‚è∞ Inserire scadenza nel sistema' :
                          'üìñ Email informativa - Archiviare dopo lettura'}
                    </div>
                </div>
            `;
        }

        // Quick add appuntamento
        function quickAddAppointment(title, date, time, description) {
            const newAppointment = {
                id: Date.now(),
                title: title,
                date: date,
                time: time,
                description: description,
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].appointments.push(newAppointment);
            logAudit('create', 'appointment', newAppointment.id, `Appuntamento creato da email: ${title}`);
            saveData();

            showNotification('‚úÖ Appuntamento aggiunto al calendario!');
            updateAppointments();
        }

        // Quick add scadenza
        function quickAddDeadline(title, date, description) {
            const newDeadline = {
                id: Date.now(),
                title: title,
                date: date,
                description: description,
                type: 'other',
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].deadlines.push(newDeadline);
            logAudit('create', 'deadline', newDeadline.id, `Scadenza creata da email: ${title}`);
            saveData();

            showNotification('‚úÖ Scadenza aggiunta!');
            renderDeadlines();
        }

        // Risposte rapide
        function applyQuickReply(type) {
            composeNewEmail();

            if (currentSelectedEmail) {
                document.getElementById('email-to').value = currentSelectedEmail.from;
                document.getElementById('email-subject').value = 'Re: ' + currentSelectedEmail.subject;

                const quickReplies = {
                    'conferma': `Gentile ${currentSelectedEmail.from.split('@')[0]},

Confermiamo la ricezione della Vostra email.

Cordiali saluti,
${data.companies[currentCompany].name}`,

                    'informazioni': `Gentile ${currentSelectedEmail.from.split('@')[0]},

Grazie per la Vostra email. Per fornirVi le informazioni richieste, avremmo bisogno di ulteriori dettagli:

- _______
- _______

Restiamo in attesa di Vs. cortese riscontro.

Cordiali saluti,
${data.companies[currentCompany].name}`,

                    'ringrazia': `Gentile ${currentSelectedEmail.from.split('@')[0]},

Vi ringraziamo per la Vostra comunicazione.

Cordiali saluti,
${data.companies[currentCompany].name}`,

                    'sollecito': `Gentile ${currentSelectedEmail.from.split('@')[0]},

Facciamo seguito alla nostra precedente comunicazione, per la quale non abbiamo ancora ricevuto riscontro.

Vi chiediamo cortesemente di fornirci un aggiornamento.

Cordiali saluti,
${data.companies[currentCompany].name}`
                };

                document.getElementById('email-body').value = quickReplies[type];
            }
        }

        // Converti email in task
        function convertEmailToTask() {
            if (!currentSelectedEmail) {
                alert('Seleziona prima un\'email');
                return;
            }

            const newTask = {
                id: Date.now(),
                title: 'Email: ' + currentSelectedEmail.subject,
                description: `Da: ${currentSelectedEmail.from}\n\n${currentSelectedEmail.body.substring(0, 200)}...`,
                category: currentSelectedEmail.category === 'clienti' ? 'important' :
                         currentSelectedEmail.category === 'fiscale' ? 'fiscal' : 'normal',
                priority: currentSelectedEmail.priority === 'urgent' ? 'aplus' :
                         currentSelectedEmail.priority === 'important' ? 'a' : 'b',
                deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // +7 giorni
                completed: false,
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].tasks.push(newTask);
            logAudit('create', 'task', newTask.id, `Task creato da email: ${currentSelectedEmail.subject}`);
            saveData();

            showNotification('‚úÖ Email convertita in attivit√†!');
            showSection('tasks');
            renderTasks();
        }

        // Converti email in scadenza
        function convertEmailToDeadline() {
            if (!currentSelectedEmail) {
                alert('Seleziona prima un\'email');
                return;
            }

            const newDeadline = {
                id: Date.now(),
                title: currentSelectedEmail.subject,
                date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // +7 giorni
                description: `Email da: ${currentSelectedEmail.from}\n\n${currentSelectedEmail.body.substring(0, 200)}...`,
                type: currentSelectedEmail.category === 'fiscale' ? 'fiscal' : 'other',
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].deadlines.push(newDeadline);
            logAudit('create', 'deadline', newDeadline.id, `Scadenza creata da email: ${currentSelectedEmail.subject}`);
            saveData();

            showNotification('‚úÖ Email convertita in scadenza!');
            showSection('scadenze');
            renderDeadlines();
        }

        // Converti email in contatto
        function convertEmailToContact() {
            if (!currentSelectedEmail) {
                alert('Seleziona prima un\'email');
                return;
            }

            const emailAddress = currentSelectedEmail.from;
            const nameParts = emailAddress.split('@')[0].split('.');
            const firstName = nameParts[0] || 'Nome';
            const lastName = nameParts[1] || 'Cognome';

            const newContact = {
                id: Date.now(),
                name: `${firstName.charAt(0).toUpperCase() + firstName.slice(1)} ${lastName.charAt(0).toUpperCase() + lastName.slice(1)}`,
                role: 'Da definire',
                company: '',
                email: emailAddress,
                phone: '',
                notes: `Contatto aggiunto da email: "${currentSelectedEmail.subject}"`,
                createdAt: new Date().toISOString()
            };

            data.companies[currentCompany].contacts.push(newContact);
            logAudit('create', 'contact', newContact.id, `Contatto creato da email: ${emailAddress}`);
            saveData();

            showNotification('‚úÖ Contatto salvato!');
            showSection('contatti');
            renderContacts();
        }

        // Mostra email urgenti
        function showUrgentEmails() {
            currentEmailFilter.priority = 'urgent';
            document.getElementById('email-filter-priority').value = 'urgent';
            renderEmailList();
            toggleEmailAssistant();
        }

        // Mostra email con scadenza
        function showDeadlineEmails() {
            // Logica per mostrare email con scadenze imminenti
            currentEmailFilter.search = 'scadenza';
            document.getElementById('email-search').value = 'scadenza';
            renderEmailList();
            toggleEmailAssistant();
        }

        // Formatta data email
        function formatEmailDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Adesso';
            if (minutes < 60) return `${minutes} min fa`;
            if (hours < 24) return `${hours} ore fa`;
            if (days < 7) return `${days} giorni fa`;

            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        // Label priorit√†
        function getPriorityLabel(priority) {
            const labels = {
                'urgent': 'üî¥ Urgente',
                'important': 'üü° Importante',
                'normal': 'üü¢ Normale'
            };
            return labels[priority] || 'üü¢ Normale';
        }

        // Label categoria
        function getCategoryLabel(category) {
            const labels = {
                'clienti': 'üë• Clienti',
                'fornitori': 'üè≠ Fornitori',
                'fiscale': 'üí∞ Fiscale',
                'hr': 'üëî HR',
                'commerciale': 'üìà Commerciale',
                'legale': '‚öñÔ∏è Legale',
                'altro': 'üìã Altro'
            };
            return labels[category] || 'üìã Altro';
        }

        // ===================================
        // ASSISTENTE IA AVANZATO
        // (Integrato dal progetto ASSISTENTE)
        // ===================================

        // Classificatore IA avanzato
        function advancedClassifyEmail(email) {
            const subject = email.subject.toLowerCase();
            const body = email.body.toLowerCase();
            const sender = email.from.toLowerCase();

            let urgencyScore = 0;
            let category = email.category || 'altro';
            let priority = email.priority || 'normal';
            let matchedRules = [];
            let requiresReply = false;
            let requiresAction = false;
            let hasDeadline = false;
            let hasAppointment = false;

            // RILEVAMENTO SPAM
            const spamKeywords = ['click here', 'free money', 'winner', 'congratulat', 'limited time', 'act now', '!!!', 'urgent!!!'];
            const spamScore = spamKeywords.filter(k => subject.includes(k) || body.includes(k)).length;

            if (spamScore > 2) {
                return {
                    category: 'spam',
                    priority: 'normal',
                    urgencyScore: 0,
                    matchedRules: ['spam_detection'],
                    requiresReply: false,
                    requiresAction: false,
                    confidence: 0.9
                };
            }

            // PAROLE CHIAVE URGENTI (dal classifier.py)
            const urgentKeywords = [
                'urgente', 'immediat', 'asap', 'entro oggi', 'entro domani',
                'scadenza', 'deadline', 'importante', 'critico', 'emergency',
                'attenzione', 'priorit', 'quanto prima'
            ];

            urgentKeywords.forEach(keyword => {
                if (subject.includes(keyword) || body.includes(keyword)) {
                    urgencyScore += 2;
                    matchedRules.push(`urgent_keyword: ${keyword}`);
                }
            });

            // RILEVAMENTO RICHIESTA DI RISPOSTA
            const replyKeywords = [
                'per favore rispondi', 'please reply', 'attendo riscontro',
                'puoi confermare', 'can you confirm', 'risposta', 'response',
                'fammi sapere', 'let me know', 'conferma', 'confirm'
            ];

            replyKeywords.forEach(keyword => {
                if (subject.includes(keyword) || body.includes(keyword)) {
                    requiresReply = true;
                    urgencyScore += 1;
                    matchedRules.push('requires_reply');
                }
            });

            // Se c'√® un punto interrogativo nel subject = richiede risposta
            if (subject.includes('?')) {
                requiresReply = true;
                urgencyScore += 0.5;
            }

            // RILEVAMENTO AZIONE RICHIESTA
            const actionKeywords = [
                'per favore invia', 'please send', 'devi', 'you need to',
                'completa', 'complete', 'approva', 'approve', 'verifica',
                'verify', 'controlla', 'check', 'firma', 'sign'
            ];

            actionKeywords.forEach(keyword => {
                if (subject.includes(keyword) || body.includes(keyword)) {
                    requiresAction = true;
                    urgencyScore += 1.5;
                    matchedRules.push('requires_action');
                }
            });

            // RILEVAMENTO SCADENZE
            const deadlinePatterns = [
                /entro\s+(oggi|domani|luned√¨|marted√¨|mercoled√¨|gioved√¨|venerd√¨|sabato|domenica)/gi,
                /scadenz\w*/gi,
                /deadline/gi,
                /by\s+(today|tomorrow|monday|tuesday|wednesday|thursday|friday)/gi,
                /\d{1,2}[/-]\d{1,2}[/-]\d{2,4}/g
            ];

            deadlinePatterns.forEach(pattern => {
                if (pattern.test(subject + ' ' + body)) {
                    hasDeadline = true;
                    urgencyScore += 2;
                    matchedRules.push('has_deadline');
                }
            });

            // RILEVAMENTO APPUNTAMENTI
            const appointmentKeywords = [
                'riunione', 'meeting', 'appuntamento', 'call',
                'videochiamata', 'video call', 'incontro', 'colloquio'
            ];

            appointmentKeywords.forEach(keyword => {
                if (subject.includes(keyword) || body.includes(keyword)) {
                    hasAppointment = true;
                    urgencyScore += 1;
                    matchedRules.push('has_appointment');
                }
            });

            // RILEVAMENTO PATTERN TEMPO (orari)
            if (/\d{1,2}:\d{2}/.test(subject + ' ' + body)) {
                urgencyScore += 0.5;
                matchedRules.push('time_mentioned');
            }

            // DETERMINA PRIORIT√Ä FINALE
            if (urgencyScore >= 4) {
                priority = 'urgent';
            } else if (urgencyScore >= 2) {
                priority = 'important';
            } else {
                priority = 'normal';
            }

            // DETERMINA CATEGORIA INTELLIGENTE
            if (body.includes('fattura') || body.includes('invoice') || body.includes('pagamento')) {
                category = 'fiscale';
            } else if (body.includes('contratto') || body.includes('legale') || body.includes('avvocato')) {
                category = 'legale';
            } else if (body.includes('dipendent') || body.includes('assunzione') || body.includes('colloquio')) {
                category = 'hr';
            } else if (body.includes('ordine') || body.includes('preventivo') || body.includes('offerta')) {
                category = 'commerciale';
            }

            const confidence = Math.min(0.5 + (matchedRules.length * 0.1), 0.95);

            return {
                category,
                priority,
                urgencyScore,
                matchedRules,
                requiresReply,
                requiresAction,
                hasDeadline,
                hasAppointment,
                confidence
            };
        }

        // Estrai appuntamenti da email (dal calendar_manager.py)
        function extractAppointmentsFromEmail(email) {
            const subject = email.subject;
            const body = email.body;
            const text = `${subject}. ${body}`;

            const appointments = [];

            // Pattern 1: Data esplicita + orario (15/12/2024 alle 14:30)
            const pattern1 = /(\d{1,2}[/-]\d{1,2}[/-]\d{2,4})\s+(?:alle|at|@|ore)?\s*(\d{1,2}[:]\d{2})/gi;
            let match;

            while ((match = pattern1.exec(text)) !== null) {
                try {
                    const dateStr = match[1];
                    const timeStr = match[2];

                    // Parse data
                    const dateParts = dateStr.split(/[/-]/);
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const year = dateParts[2].length === 2 ? 2000 + parseInt(dateParts[2]) : parseInt(dateParts[2]);

                    // Parse orario
                    const timeParts = timeStr.split(':');
                    const hour = parseInt(timeParts[0]);
                    const minute = parseInt(timeParts[1]);

                    const startTime = new Date(year, month, day, hour, minute);

                    // Solo appuntamenti futuri
                    if (startTime > new Date()) {
                        appointments.push({
                            title: extractAppointmentTitle(subject, body),
                            date: startTime.toISOString().split('T')[0],
                            time: timeStr,
                            description: `Da email: ${email.from}\n\n${body.substring(0, 200)}...`,
                            location: extractLocation(body),
                            confidence: 0.9
                        });
                    }
                } catch (e) {
                    console.error('Error parsing appointment:', e);
                }
            }

            // Pattern 2: Solo orario (14:30, 3:00 PM)
            const pattern2 = /\b(\d{1,2}):(\d{2})\b/g;

            while ((match = pattern2.exec(body)) !== null) {
                try {
                    const hour = parseInt(match[1]);
                    const minute = parseInt(match[2]);

                    const now = new Date();
                    let appointmentDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);

                    // Se l'orario √® passato, assume domani
                    if (appointmentDate < now) {
                        appointmentDate.setDate(appointmentDate.getDate() + 1);
                    }

                    appointments.push({
                        title: extractAppointmentTitle(subject, body),
                        date: appointmentDate.toISOString().split('T')[0],
                        time: `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`,
                        description: `Da email: ${email.from}\n\n${body.substring(0, 200)}...`,
                        location: extractLocation(body),
                        confidence: 0.5
                    });
                } catch (e) {
                    console.error('Error parsing time:', e);
                }
            }

            // Pattern 3: "domani alle 15:00", "oggi alle 10:00"
            const pattern3 = /(oggi|domani|dopodomani)\s+(?:alle|at)?\s*(\d{1,2}):(\d{2})/gi;

            while ((match = pattern3.exec(text)) !== null) {
                try {
                    const when = match[1].toLowerCase();
                    const hour = parseInt(match[2]);
                    const minute = parseInt(match[3]);

                    const now = new Date();
                    let appointmentDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);

                    if (when === 'domani') {
                        appointmentDate.setDate(appointmentDate.getDate() + 1);
                    } else if (when === 'dopodomani') {
                        appointmentDate.setDate(appointmentDate.getDate() + 2);
                    }

                    if (appointmentDate > now) {
                        appointments.push({
                            title: extractAppointmentTitle(subject, body),
                            date: appointmentDate.toISOString().split('T')[0],
                            time: `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`,
                            description: `Da email: ${email.from}\n\n${body.substring(0, 200)}...`,
                            location: extractLocation(body),
                            confidence: 0.8
                        });
                    }
                } catch (e) {
                    console.error('Error parsing relative date:', e);
                }
            }

            return appointments.slice(0, 3); // Max 3 appuntamenti per email
        }

        // Estrai titolo appuntamento
        function extractAppointmentTitle(subject, body) {
            // Cerca pattern tipo "Riunione: Titolo"
            const titlePatterns = [
                /(?:riunione|meeting|appuntamento|call):\s*([^\n]+)/i,
                /(?:oggetto|subject):\s*([^\n]+)/i
            ];

            for (const pattern of titlePatterns) {
                const match = pattern.exec(subject + ' ' + body);
                if (match) {
                    return match[1].trim().substring(0, 100);
                }
            }

            // Fallback al subject o prima riga
            if (subject && subject.length > 5) {
                return subject.substring(0, 100);
            }

            return 'Appuntamento da email';
        }

        // Estrai location
        function extractLocation(body) {
            const locationPatterns = [
                /(?:location|luogo|dove|where|presso|at):\s*([^\n]+)/i,
                /(?:sala|room|ufficio|office)\s+([A-Za-z0-9]+)/i,
                /(?:via|viale|piazza)\s+([^,\n]+)/i
            ];

            for (const pattern of locationPatterns) {
                const match = pattern.exec(body);
                if (match) {
                    return match[1].trim().substring(0, 100);
                }
            }

            return null;
        }

        // Estrai scadenze da email
        function extractDeadlinesFromEmail(email) {
            const subject = email.subject;
            const body = email.body;
            const text = `${subject}. ${body}`;

            const deadlines = [];

            // Pattern 1: "entro il 15/12/2024"
            const pattern1 = /entro\s+(?:il\s+)?(\d{1,2}[/-]\d{1,2}[/-]\d{2,4})/gi;
            let match;

            while ((match = pattern1.exec(text)) !== null) {
                try {
                    const dateStr = match[1];
                    const dateParts = dateStr.split(/[/-]/);
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const year = dateParts[2].length === 2 ? 2000 + parseInt(dateParts[2]) : parseInt(dateParts[2]);

                    const deadlineDate = new Date(year, month, day);

                    if (deadlineDate > new Date()) {
                        deadlines.push({
                            title: `Scadenza: ${subject}`,
                            date: deadlineDate.toISOString().split('T')[0],
                            description: `Da email: ${email.from}\n\n${body.substring(0, 200)}...`,
                            type: 'other',
                            confidence: 0.9
                        });
                    }
                } catch (e) {
                    console.error('Error parsing deadline:', e);
                }
            }

            // Pattern 2: "scadenza: 30/12/2024"
            const pattern2 = /(?:scadenz\w*|deadline):\s*(\d{1,2}[/-]\d{1,2}[/-]\d{2,4})/gi;

            while ((match = pattern2.exec(text)) !== null) {
                try {
                    const dateStr = match[1];
                    const dateParts = dateStr.split(/[/-]/);
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const year = dateParts[2].length === 2 ? 2000 + parseInt(dateParts[2]) : parseInt(dateParts[2]);

                    const deadlineDate = new Date(year, month, day);

                    if (deadlineDate > new Date()) {
                        deadlines.push({
                            title: `Scadenza: ${subject}`,
                            date: deadlineDate.toISOString().split('T')[0],
                            description: `Da email: ${email.from}\n\n${body.substring(0, 200)}...`,
                            type: 'other',
                            confidence: 0.9
                        });
                    }
                } catch (e) {
                    console.error('Error parsing deadline:', e);
                }
            }

            // Pattern 3: "entro domani", "entro oggi"
            const pattern3 = /entro\s+(oggi|domani|dopodomani)/gi;

            while ((match = pattern3.exec(text)) !== null) {
                const when = match[1].toLowerCase();
                const now = new Date();
                let deadlineDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                if (when === 'domani') {
                    deadlineDate.setDate(deadlineDate.getDate() + 1);
                } else if (when === 'dopodomani') {
                    deadlineDate.setDate(deadlineDate.getDate() + 2);
                }

                deadlines.push({
                    title: `Scadenza urgente: ${subject}`,
                    date: deadlineDate.toISOString().split('T')[0],
                    description: `Da email: ${email.from}\n\n${body.substring(0, 200)}...`,
                    type: 'other',
                    confidence: 0.8
                });
            }

            return deadlines.slice(0, 2); // Max 2 scadenze per email
        }

        // DAILY BRIEFING - Dashboard giornaliera intelligente
        function generateDailyBriefing() {
            const emails = data.companies[currentCompany].emails || [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Analizza tutte le email in inbox
            const inboxEmails = emails.filter(e => e.folder === 'inbox');

            let urgentEmails = [];
            let deadlinesToday = [];
            let appointmentsToday = [];
            let requiresReply = [];
            let requiresAction = [];

            inboxEmails.forEach(email => {
                // Classifica con IA avanzata
                const analysis = advancedClassifyEmail(email);

                email._aiAnalysis = analysis; // Salva analisi

                if (analysis.priority === 'urgent') {
                    urgentEmails.push(email);
                }

                if (analysis.requiresReply && !email.read) {
                    requiresReply.push(email);
                }

                if (analysis.requiresAction) {
                    requiresAction.push(email);
                }

                // Estrai appuntamenti
                if (analysis.hasAppointment) {
                    const appointments = extractAppointmentsFromEmail(email);
                    appointments.forEach(apt => {
                        const aptDate = new Date(apt.date);
                        if (aptDate.toDateString() === today.toDateString()) {
                            appointmentsToday.push({...apt, emailId: email.id});
                        }
                    });
                }

                // Estrai scadenze
                if (analysis.hasDeadline) {
                    const deadlines = extractDeadlinesFromEmail(email);
                    deadlines.forEach(dl => {
                        const dlDate = new Date(dl.date);
                        if (dlDate.toDateString() === today.toDateString()) {
                            deadlinesToday.push({...dl, emailId: email.id});
                        }
                    });
                }
            });

            return {
                date: today.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }),
                urgentEmails,
                deadlinesToday,
                appointmentsToday,
                requiresReply,
                requiresAction,
                totalInbox: inboxEmails.length,
                unreadCount: inboxEmails.filter(e => !e.read).length
            };
        }

        // Mostra Daily Briefing
        function showDailyBriefing() {
            const briefing = generateDailyBriefing();

            const briefingHtml = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h2 style="margin: 0 0 10px 0;">‚òÄÔ∏è Buongiorno! Daily Briefing</h2>
                    <p style="margin: 0; opacity: 0.9;">${briefing.date}</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em; font-weight: bold;">${briefing.urgentEmails.length}</div>
                        <div style="font-size: 1.2em;">Email Urgenti</div>
                    </div>
                    <div style="background: #f39c12; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em; font-weight: bold;">${briefing.deadlinesToday.length}</div>
                        <div style="font-size: 1.2em;">Scadenze Oggi</div>
                    </div>
                    <div style="background: #3498db; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em; font-weight: bold;">${briefing.appointmentsToday.length}</div>
                        <div style="font-size: 1.2em;">Appuntamenti Oggi</div>
                    </div>
                    <div style="background: #9b59b6; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em; font-weight: bold;">${briefing.requiresReply.length}</div>
                        <div style="font-size: 1.2em;">Richieste Risposta</div>
                    </div>
                </div>

                ${briefing.urgentEmails.length > 0 ? `
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="color: #e74c3c;">üö® EMAIL URGENTI</h3>
                        ${briefing.urgentEmails.map(email => `
                            <div style="padding: 15px; border-left: 4px solid #e74c3c; background: #ffebee; margin-bottom: 10px; cursor: pointer;" onclick="openEmailView(${email.id})">
                                <div style="font-weight: bold;">${email.subject}</div>
                                <div style="color: #666; font-size: 0.9em;">Da: ${email.from}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${briefing.deadlinesToday.length > 0 ? `
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="color: #f39c12;">‚è∞ SCADENZE OGGI</h3>
                        ${briefing.deadlinesToday.map(dl => `
                            <div style="padding: 15px; border-left: 4px solid #f39c12; background: #fff3e0; margin-bottom: 10px;">
                                <div style="font-weight: bold;">${dl.title}</div>
                                <div style="color: #666; font-size: 0.9em;">${dl.description.substring(0, 100)}...</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${briefing.appointmentsToday.length > 0 ? `
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="color: #3498db;">üìÖ APPUNTAMENTI OGGI</h3>
                        ${briefing.appointmentsToday.map(apt => `
                            <div style="padding: 15px; border-left: 4px solid #3498db; background: #e3f2fd; margin-bottom: 10px;">
                                <div style="font-weight: bold;">${apt.title}</div>
                                <div style="color: #666; font-size: 0.9em;">‚è∞ ${apt.time} ${apt.location ? `‚Ä¢ üìç ${apt.location}` : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${briefing.requiresAction.length > 0 ? `
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="color: #9b59b6;">‚úÖ AZIONI RICHIESTE</h3>
                        ${briefing.requiresAction.slice(0, 5).map(email => `
                            <div style="padding: 15px; border-left: 4px solid #9b59b6; background: #f3e5f5; margin-bottom: 10px; cursor: pointer;" onclick="openEmailView(${email.id})">
                                <div style="font-weight: bold;">${email.subject}</div>
                                <div style="color: #666; font-size: 0.9em;">Da: ${email.from}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <div class="card">
                    <h3>üéØ PRIORIT√Ä PER OGGI</h3>
                    <ol style="line-height: 2;">
                        ${briefing.urgentEmails.length > 0 ? `<li>Rispondere a ${briefing.urgentEmails.length} email urgenti</li>` : ''}
                        ${briefing.deadlinesToday.length > 0 ? `<li>Completare ${briefing.deadlinesToday.length} scadenze</li>` : ''}
                        ${briefing.appointmentsToday.length > 0 ? `<li>Partecipare a ${briefing.appointmentsToday.length} appuntamenti</li>` : ''}
                        ${briefing.requiresReply.length > 0 ? `<li>Rispondere a ${briefing.requiresReply.length} email</li>` : ''}
                        ${briefing.urgentEmails.length === 0 && briefing.deadlinesToday.length === 0 && briefing.appointmentsToday.length === 0 ? `<li>‚úÖ Tutto sotto controllo! Nessuna urgenza oggi.</li>` : ''}
                    </ol>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #ecf0f1; border-radius: 10px; text-align: center;">
                    <p style="margin: 0; color: #7f8c8d;">
                        <strong>Inbox:</strong> ${briefing.totalInbox} email totali ‚Ä¢
                        <strong>${briefing.unreadCount}</strong> non lette
                    </p>
                </div>
            `;

            // Mostra in un modal
            const modal = document.getElementById('email-view-modal');
            const body = document.getElementById('email-view-body');
            const title = document.getElementById('email-view-title');

            title.textContent = '‚òÄÔ∏è Daily Briefing';
            body.innerHTML = briefingHtml;
            modal.classList.add('active');
        }

        // AVVIO
        init();
    </script>
</body>
</html>
